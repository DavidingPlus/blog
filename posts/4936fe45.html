<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><script>window.MSInputMethodContext&&document.documentMode&&(window.location.href="https://support.dmeng.net/upgrade-your-browser.html")</script><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/assets/favicon-16x16.webp?v=2.8.6" type="image/png" sizes="16x16"><link rel="icon" href="/assets/favicon-32x32.webp?v=2.8.6" type="image/png" sizes="32x32"><link rel="apple-touch-icon" href="/assets/apple-touch-icon.webp?v=2.8.6" sizes="180x180"><meta name="description" content="Rtems æºç é˜…è¯»        RTEMSï¼ˆRealâ€‘Time Executive for Multiprocessor Systemsï¼‰æ˜¯ä¸€æ¬¾å§‹äº 1988 å¹´ã€1993 å¹´æ­£å¼å‘å¸ƒçš„å¼€æºå®æ—¶æ“ä½œç³»ç»Ÿï¼Œä¸“ä¸ºå¤šå¤„ç†å™¨åµŒå…¥å¼ç¯å¢ƒè®¾è®¡ï¼Œæ”¯æŒ POSIX å’Œ BSD å¥—æ¥å­—ç­‰å¼€æ”¾æ ‡å‡† APIï¼Œå¹¶å¯è¿è¡Œäº ARMã€PowerPCã€SPARCã€MIPSã€RIS"><meta property="og:type" content="article"><meta property="og:title" content="Rtems Source Code"><meta property="og:url" content="https://blog.davidingplus.cn/posts/4936fe45.html"><meta property="og:site_name" content="DavidingPlus&#39;s Blog"><meta property="og:description" content="Rtems æºç é˜…è¯»        RTEMSï¼ˆRealâ€‘Time Executive for Multiprocessor Systemsï¼‰æ˜¯ä¸€æ¬¾å§‹äº 1988 å¹´ã€1993 å¹´æ­£å¼å‘å¸ƒçš„å¼€æºå®æ—¶æ“ä½œç³»ç»Ÿï¼Œä¸“ä¸ºå¤šå¤„ç†å™¨åµŒå…¥å¼ç¯å¢ƒè®¾è®¡ï¼Œæ”¯æŒ POSIX å’Œ BSD å¥—æ¥å­—ç­‰å¼€æ”¾æ ‡å‡† APIï¼Œå¹¶å¯è¿è¡Œäº ARMã€PowerPCã€SPARCã€MIPSã€RIS"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2025-05-19T12:50:00.000Z"><meta property="article:modified_time" content="2025-06-18T17:20:00.000Z"><meta property="article:author" content="DavidingPlus"><meta name="twitter:card" content="summary"><title>Rtems Source Code | DavidingPlus's Blog</title><link ref="canonical" href="https://blog.davidingplus.cn/posts/4936fe45.html"><link rel="dns-prefetch" href="https://cdn.davidingplus.cn"><link rel="stylesheet" href="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/css/fontawesome.css" type="text/css"><link rel="stylesheet" href="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/css/fancybox.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.8.6"><script>var Stun=window.Stun||{},CONFIG={root:"/",algolia:void 0,assistSearch:["bing","baidu"],fontIcon:{prompt:{success:"fas fa-check-circle",info:"fas fa-arrow-circle-right",warning:"fas fa-exclamation-circle",error:"fas fa-times-circle"},copyBtn:"fas fa-copy"},sidebar:{offsetTop:"55px",tocMaxDepth:6},header:{enable:!0,showOnPost:!0,scrollDownIcon:!0},postWidget:{endText:!0},nightMode:{enable:!0},back2top:{enable:!0},back2bottom:{enable:!0},codeblock:{style:"default",highlight:"light",wordWrap:!0},reward:!0,fancybox:!0,zoomImage:{gapAside:"20px"},galleryWaterfall:{colWidth:"255px",gapX:"65px"},lazyload:!0,pjax:{avoidBanner:!0},externalLink:{icon:{enable:!0,name:"fas fa-external-link-alt"}},shortcuts:void 0,prompt:{copyButton:"å¤åˆ¶",copySuccess:"æ­å–œäº²äº²ï¼Œå¤åˆ¶æˆåŠŸå’§",copyError:"å“å‘€ï¼Œå¤åˆ¶å¤±è´¥äº†"},sourcePath:{js:"js",css:"css",images:"images"},utterancesTheme:{light:"github-light",dark:"photon-dark"}};window.CONFIG=CONFIG</script><meta name="generator" content="Hexo 7.2.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">é¦–é¡µ</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">å½’æ¡£</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">åˆ†ç±»</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return!1"><span class="header-nav-menu-item__icon"><i class="fas fa-bars"></i></span><span class="header-nav-menu-item__text">å…¶ä»–</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/friends/"><span class="header-nav-submenu-item__icon"><i class="fas fa-users"></i></span><span class="header-nav-submenu-item__text">å‹é“¾</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/gallery/"><span class="header-nav-submenu-item__icon"><i class="fas fa-images"></i></span><span class="header-nav-submenu-item__text">ç›¸å†Œ</span></a></div></div></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">å…³äº</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" target="_blank" rel="noopener" href="https://davidingplus.cn/"><span class="header-nav-menu-item__icon"><i class="fas fa-pager"></i></span><span class="header-nav-menu-item__text">ç«™ç‚¹ä¸»é¡µ</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">æœç´¢</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">DavidingPlus's Blog</div><div class="header-banner-info__subtitle">ğŸ•Šï¸ world peace</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">Rtems Source Code</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2025-05-19</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2025-06-18</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">å­—æ•°ç»Ÿè®¡</span><span class="post-meta-item__value">9.5k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">é˜…è¯»æ—¶é•¿</span><span class="post-meta-item__value">60åˆ†</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">é˜…è¯»æ¬¡æ•°</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><meta name="referrer" content="no-referrer"><h1 id="rtems-æºç é˜…è¯»"><a href="#rtems-æºç é˜…è¯»" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#rtems-æºç é˜…è¯»"></a> Rtems æºç é˜…è¯»</h1><p>RTEMSï¼ˆRealâ€‘Time Executive for Multiprocessor Systemsï¼‰æ˜¯ä¸€æ¬¾å§‹äº 1988 å¹´ã€1993 å¹´æ­£å¼å‘å¸ƒçš„å¼€æºå®æ—¶æ“ä½œç³»ç»Ÿï¼Œä¸“ä¸ºå¤šå¤„ç†å™¨åµŒå…¥å¼ç¯å¢ƒè®¾è®¡ï¼Œæ”¯æŒ POSIX å’Œ BSD å¥—æ¥å­—ç­‰å¼€æ”¾æ ‡å‡† APIï¼Œå¹¶å¯è¿è¡Œäº ARMã€PowerPCã€SPARCã€MIPSã€RISCâ€‘V ç­‰ 18 ç§å¤„ç†å™¨æ¶æ„åŠè¿‘ 200 ä¸ª BSPï¼ˆBoard Support Packageï¼‰ä¸Šã€‚å®ƒä»¥åº“å½¢å¼å‘å¸ƒï¼Œåº”ç”¨ç¨‹åºä¸å†…æ ¸é™æ€é“¾æ¥ä¸ºå•ä¸€æ˜ åƒï¼Œé‡‡ç”¨å•åœ°å€ç©ºé—´ã€æ— ç”¨æˆ·/å†…æ ¸éš”ç¦»è®¾è®¡ï¼Œä»è€Œç®€åŒ–èµ„æºç®¡ç†å¹¶ç¡®ä¿ç¡®å®šæ€§å“åº”ã€‚2025 å¹´ 1 æœˆ 22 æ—¥å‘å¸ƒçš„ 6.1 ç‰ˆæœ¬å…¨é¢å°†æ„å»ºç³»ç»Ÿç”± GNU Autotools åˆ‡æ¢åˆ°åŸºäº Python çš„ Wafï¼Œå¤§å¹…æå‡äº†æ„å»ºé€Ÿåº¦å¹¶ä¼˜åŒ–äº†ä¾èµ–ç®¡ç†ï¼ŒåŒæ—¶å¼•å…¥äº†æ”¹è¿›çš„è°ƒåº¦ç®—æ³•å’Œå¢å¼ºçš„ SMP æ”¯æŒã€‚</p><p>æœ¬æ–‡ç« ç”¨äºè®°å½•é˜…è¯» Rtems å†…æ ¸æºç çš„ç¬”è®°ï¼Œå°è¯•ç†è§£å…¶ä¸­çš„é€»è¾‘ã€‚Rtems å†…æ ¸çš„ç‰ˆæœ¬æ˜¯ 6.1ï¼Œåœ¨çº¿ä»£ç ç½‘ç«™è§ <span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://rtems.davidingplus.cn/lxr/source/">https://rtems.davidingplus.cn/lxr/source/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ã€‚</p><p>æœ¬æ–‡ç« ä¸­æ¶‰åŠåˆ°çš„æºç æ‘˜æŠ„è§é¡¹ç›® <span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://github.com/DavidingPlus/rtems-source-code">DavidingPlus/rtems-source-code: Rtems æºç é˜…è¯»ã€‚</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ã€‚</p><span id="more"></span><h1 id="æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ–‡ä»¶ç³»ç»Ÿ" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#æ–‡ä»¶ç³»ç»Ÿ"></a> æ–‡ä»¶ç³»ç»Ÿ</h1><h2 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#ç³»ç»Ÿè°ƒç”¨"></a> ç³»ç»Ÿè°ƒç”¨</h2><h3 id="open"><a href="#open" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#open"></a> open()</h3><p>open() å‡½æ•°çš„è°ƒç”¨æµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <pre class="mermaid">flowchart TD
    A[å¼€å§‹ open å‡½æ•°] --> B[åˆå§‹åŒ–å˜é‡ rv=0, mode=0, iop=NULL]
    B --> C[va_start å¼€å§‹å¤„ç†å¯å˜å‚æ•°]
    C --> D[è·å– mode å‚æ•°]
    D --> E{æ˜¯å¦æˆåŠŸåˆ†é… iop}
    E -- æ˜¯ --> F[è°ƒç”¨ do_open æ‰“å¼€æ–‡ä»¶]
    F --> G[è®¾ç½® rv ä¸º do_open è¿”å›å€¼]
    E -- å¦ --> H[è®¾ç½® errno = ENFILE]
    H --> I[rv = -1]
    G --> J[va_end ç»“æŸå¯å˜å‚æ•°å¤„ç†]
    I --> J
    J --> K[è¿”å› rv]</pre> <h4 id="struct-rtems_libio_t"><a href="#struct-rtems_libio_t" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-rtems_libio_t"></a> struct rtems_libio_t</h4><p>rtems_libio_t ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ã€‚è¯¥ç»“æ„ä½“ç”¨äºè¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„å†…éƒ¨çŠ¶æ€ï¼ŒRtems ä¸­æ¯æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶éƒ½ä¼šå…³è”ä¸€ä¸ªè¯¥ç»“æ„ä½“çš„å®ä¾‹ï¼Œé€šå¸¸ç®€ç§°ä¸º iopï¼ˆI/O pointerï¼‰ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtems_libio_tt</span> <span class="title">rtems_libio_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtems_libio_tt</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// æ–‡ä»¶çŠ¶æ€æ ‡å¿—ï¼Œä½¿ç”¨åŸå­ç±»å‹ä»¥æ”¯æŒçº¿ç¨‹å®‰å…¨æ“ä½œã€‚</span></span><br><span class="line">    <span class="comment">// å¯èƒ½æ ‡å¿—ï¼šæ˜¯å¦æ‰“å¼€ã€è¯»/å†™æƒé™ã€æ–‡ä»¶ç±»å‹ç­‰ã€‚</span></span><br><span class="line">    Atomic_Uint flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰æ–‡ä»¶åç§»é‡ï¼Œç”¨äºè¯»å†™æ“ä½œæ—¶å®šä½æ–‡ä»¶æŒ‡é’ˆä½ç½®ã€‚</span></span><br><span class="line">    <span class="type">off_t</span> offset;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶è·¯å¾„å®šä½ä¿¡æ¯ï¼Œç±»ä¼¼äº inodeã€‚</span></span><br><span class="line">    <span class="comment">// åŒ…å«æŒ‚è½½ç‚¹ã€èŠ‚ç‚¹ã€é©±åŠ¨ç­‰ä¿¡æ¯ï¼Œç”¨äºå®é™…æ–‡ä»¶è®¿é—®ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_location_info_t</span> pathinfo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é©±åŠ¨æˆ–æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨çš„ç§æœ‰å­—æ®µã€‚</span></span><br><span class="line">    <span class="comment">// é€šå¸¸ç”¨äºå­˜å‚¨è½»é‡çº§çŠ¶æ€ã€å¥æŸ„æˆ–æ ‡å¿—å€¼ã€‚</span></span><br><span class="line">    <span class="type">uint32_t</span> data0;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é©±åŠ¨æˆ–æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨çš„æ‰©å±•å­—æ®µã€‚</span></span><br><span class="line">    <span class="comment">// å¯æŒ‡å‘ä»»æ„ç±»å‹æ•°æ®ï¼Œæ”¯æŒæ›´å¤æ‚çš„ä¸Šä¸‹æ–‡ç®¡ç†ã€‚</span></span><br><span class="line">    <span class="type">void</span> *data1;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><h5 id="struct-rtems_filesystem_location_info_t"><a href="#struct-rtems_filesystem_location_info_t" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-rtems_filesystem_location_info_t"></a> struct rtems_filesystem_location_info_t</h5><p>rtems_filesystem_location_info_t ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ã€‚å®ƒè¡¨ç¤ºä¸€ä¸ªè·¯å¾„ä½ç½®ï¼Œç”¨äºæè¿°æ–‡ä»¶ç³»ç»Ÿä¸­æŸä¸ªå…·ä½“èŠ‚ç‚¹ï¼ˆå¦‚æ–‡ä»¶æˆ–ç›®å½•ï¼‰çš„ä½ç½®åŠå…¶è®¿é—®æ–¹å¼ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå¦‚æ–‡ä»¶æˆ–ç›®å½•ï¼‰çš„ä½ç½®åŠå…¶è®¿é—®ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtems_filesystem_location_info_tt</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// ç”¨äºå°†è¯¥èŠ‚ç‚¹æ’å…¥åˆ°æŒ‚è½½ç‚¹çš„é“¾è¡¨ä¸­ï¼ˆå¦‚ç›®å½•é¡¹åˆ—è¡¨ï¼‰ã€‚</span></span><br><span class="line">    rtems_chain_node mt_entry_node;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡å‘å…·ä½“èŠ‚ç‚¹çš„è®¿é—®ç»“æ„ï¼Œä¸€èˆ¬æ˜¯ä¸å…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°ç›¸å…³çš„ inode æˆ–æ•°æ®ç»“æ„ã€‚</span></span><br><span class="line">    <span class="type">void</span> *node_access;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯é€‰çš„ç¬¬äºŒä¸ªè®¿é—®å­—æ®µï¼Œä¾›æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ï¼Œå¦‚è½¯é“¾æ¥æˆ–æ‰©å±•å…ƒæ•°æ®ã€‚</span></span><br><span class="line">    <span class="type">void</span> *node_access_2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡å‘è¯¥èŠ‚ç‚¹æ‰€ä½¿ç”¨çš„æ–‡ä»¶æ“ä½œå¤„ç†å™¨é›†åˆï¼ˆå¦‚ openã€readã€writeã€close ç­‰å‡½æ•°æŒ‡é’ˆï¼‰ã€‚</span></span><br><span class="line">    <span class="type">const</span> rtems_filesystem_file_handlers_r *handlers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹æ‰€å±çš„æŒ‚è½½è¡¨æ¡ç›®ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹æ¥è‡ªå“ªä¸ªæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_mount_table_entry_t</span> *mt_entry;</span><br><span class="line"></span><br><span class="line">&#125; <span class="type">rtems_filesystem_location_info_t</span>;</span><br></pre></td></tr></table></div></figure><h5 id="struct-rtems_filesystem_file_handlers_r"><a href="#struct-rtems_filesystem_file_handlers_r" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-rtems_filesystem_file_handlers_r"></a> struct rtems_filesystem_file_handlers_r</h5><p>æ¯”è¾ƒé‡è¦çš„æˆå‘˜æ˜¯ <code>const rtems_filesystem_file_handlers_r *handlers</code>ï¼Œè¯¥ç»“æ„ç±»ä¼¼äº Linux å†…æ ¸ä¸­çš„ file_operationsï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief File system node operations table.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">rtems_filesystem_file_handlers_r</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// æ‰“å¼€æ–‡ä»¶çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_open_t</span> open_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­æ–‡ä»¶çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_close_t</span> close_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æ–‡ä»¶çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_read_t</span> read_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥æ–‡ä»¶çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_write_t</span> write_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ§åˆ¶æ“ä½œï¼ˆå¦‚è®¾å¤‡æ§åˆ¶ï¼‰çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_ioctl_t</span> ioctl_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ä½ç½®æŒ‡é’ˆç§»åŠ¨ï¼ˆå¦‚ lseekï¼‰çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_lseek_t</span> lseek_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ–‡ä»¶çŠ¶æ€ä¿¡æ¯çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_fstat_t</span> fstat_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æˆªæ–­æ–‡ä»¶å¤§å°çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_ftruncate_t</span> ftruncate_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†æ–‡ä»¶ç¼“å†²åŒºæ•°æ®åŒæ­¥åˆ°å­˜å‚¨è®¾å¤‡çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_fsync_t</span> fsync_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒæ­¥æ–‡ä»¶æ•°æ®ï¼ˆä½†ä¸ä¸€å®šåŒ…æ‹¬å…ƒæ•°æ®ï¼‰çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_fdatasync_t</span> fdatasync_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶æ§åˆ¶ï¼ˆå¦‚ä¿®æ”¹æ–‡ä»¶æè¿°ç¬¦å±æ€§ï¼‰çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_fcntl_t</span> fcntl_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½®è¯¢æ–‡ä»¶çŠ¶æ€ï¼ˆå¦‚æ˜¯å¦å¯è¯»å†™ï¼‰çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_poll_t</span> poll_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºäº‹ä»¶è¿‡æ»¤ï¼ˆBSD kqueueï¼‰çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_kqfilter_t</span> kqfilter_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–å¤šä¸ªç¼“å†²åŒºï¼ˆå‘é‡è¯»ï¼‰çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_readv_t</span> readv_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥å¤šä¸ªç¼“å†²åŒºï¼ˆå‘é‡å†™ï¼‰çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_writev_t</span> writev_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…å­˜æ˜ å°„æ–‡ä»¶çš„å¤„ç†å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_mmap_t</span> mmap_h;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><h5 id="struct-rtems_filesystem_mount_table_entry_tt"><a href="#struct-rtems_filesystem_mount_table_entry_tt" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-rtems_filesystem_mount_table_entry_tt"></a> struct rtems_filesystem_mount_table_entry_tt</h5><p>å¦ä¸€ä¸ªæˆå‘˜æ˜¯ struct rtems_filesystem_mount_table_entry_ttã€‚è¿™ä¸ªç»“æ„ä½“çš„ä½œç”¨æ˜¯ä¸ºæ¯ä¸€ä¸ªå·²æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿæä¾›ä¸€ä¸ªé›†ä¸­å¼çš„æè¿°ï¼ŒåŒ…å«äº†æ–‡ä»¶ç³»ç»Ÿçš„æ ¹èŠ‚ç‚¹ä¿¡æ¯ã€æŒ‚è½½ç‚¹ã€ç±»å‹ã€è®¾å¤‡ã€è®¿é—®æ§åˆ¶çŠ¶æ€ç­‰å…³é”®ä¿¡æ¯ã€‚å¯¹æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼ŒRtems ä¼šç»´æŠ¤ä¸€ä¸ªè¿™æ ·çš„æŒ‚è½½è¡¨é“¾è¡¨ã€‚åœ¨æŒ‚è½½å’Œå¸è½½æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼ŒRtems ä¼šå¯¹è¿™ä¸ªç»“æ„ä½“è¿›è¡Œç›¸åº”çš„åˆå§‹åŒ–ã€æ“ä½œæˆ–é‡Šæ”¾ã€‚æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ã€æŸ¥æ‰¾è·¯å¾„ã€è®¿é—®æƒé™ã€å¸è½½ç­‰éƒ½ä¾èµ–äºè¿™ä¸ªç»“æ„ä½“ä¸­è®°å½•çš„ä¿¡æ¯ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtems_filesystem_mount_table_entry_tt</span></span></span><br><span class="line"><span class="class">    <span class="title">rtems_filesystem_mount_table_entry_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¡¨ç¤ºä¸€ä¸ªæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿå®ä¾‹ï¼Œæ˜¯ Rtems æ–‡ä»¶ç³»ç»ŸæŒ‚è½½è¡¨ä¸­çš„ä¸€é¡¹ã€‚</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtems_filesystem_mount_table_entry_tt</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// ç”¨äºå°†è¯¥æŒ‚è½½ç‚¹æ’å…¥å…¨å±€æŒ‚è½½é“¾è¡¨ã€‚</span></span><br><span class="line">    rtems_chain_node mt_node;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç³»ç»Ÿç§æœ‰ä¿¡æ¯ï¼Œç”±å…·ä½“æ–‡ä»¶ç³»ç»Ÿå®ç°å®šä¹‰ï¼Œå¦‚ ext2 çš„ superblock ä¿¡æ¯ã€‚</span></span><br><span class="line">    <span class="type">void</span> *fs_info;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡å‘æ–‡ä»¶ç³»ç»Ÿæ“ä½œå‡½æ•°è¡¨ï¼Œå®šä¹‰å¦‚ mountã€unmountã€eval_path ç­‰ã€‚</span></span><br><span class="line">    <span class="type">const</span> rtems_filesystem_operations_table *ops;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç³»ç»Ÿçš„å¸¸é‡ä¿¡æ¯ï¼Œä¸å¯å˜ï¼Œä¾‹å¦‚åˆå§‹æŒ‚è½½å‚æ•°ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">void</span> *immutable_fs_info;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯¥æ–‡ä»¶ç³»ç»Ÿä¸­æ‰€æœ‰èŠ‚ç‚¹çš„å…¨å±€é“¾è¡¨ï¼Œä¾¿äºéå†ã€‚</span></span><br><span class="line">    rtems_chain_control location_chain;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºè¯¥æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åœ¨å“ªä¸ªç›®å½•ï¼ˆæŒ‚è½½ç‚¹ï¼‰ä¸Šã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_global_location_t</span> *mt_point_node;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºè¯¥æ–‡ä»¶ç³»ç»Ÿçš„æ ¹èŠ‚ç‚¹ä½ç½®ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_global_location_t</span> *mt_fs_root;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦å·²æŒ‚è½½æˆåŠŸã€‚</span></span><br><span class="line">    <span class="type">bool</span> mounted;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦æ”¯æŒå†™æ“ä½œã€‚</span></span><br><span class="line">    <span class="type">bool</span> writeable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦ç¦æ­¢åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹å’Œæ™®é€šæ–‡ä»¶ï¼ˆmknodï¼‰ã€‚</span></span><br><span class="line">    <span class="type">bool</span> no_regular_file_mknod;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯¥æ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„åé™åˆ¶å’Œé€‰é¡¹ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">rtems_filesystem_limits_and_options_t</span> *pathconf_limits_and_options;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‚è½½ç‚¹è·¯å¾„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ &quot;/mnt/usb&quot;ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *target;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç³»ç»Ÿç±»å‹åç§°ï¼Œä¾‹å¦‚ &quot;imfs&quot;ã€&quot;devfs&quot;ã€&quot;nfs&quot; ç­‰ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾å¤‡åç§°ï¼Œå¦‚ &quot;/dev/sda1&quot;ï¼Œä»¥å­—ç¬¦ä¸²å½¢å¼è¡¨ç¤ºï¼Œä¾›åº•å±‚æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ã€‚</span></span><br><span class="line">    <span class="type">char</span> *dev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘èµ·å¸è½½æ“ä½œçš„ä»»åŠ¡ IDï¼Œå¸è½½å®Œæˆåé€šè¿‡äº‹ä»¶é€šçŸ¥è¯¥ä»»åŠ¡ã€‚</span></span><br><span class="line">    rtems_id unmount_task;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><p>åœ¨ RTEMS ä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œç”± rtems_filesystem_operations_table ç»“æ„ä½“ç»Ÿä¸€ç®¡ç†ï¼Œå®ƒå®šä¹‰äº†è·¯å¾„è§£æã€èŠ‚ç‚¹åˆ›å»ºã€åˆ é™¤ã€å…‹éš†ç­‰æ ¸å¿ƒæ“ä½œå‡½æ•°ï¼Œä½œç”¨ä¸Šç›¸å½“äº Linux ä¸­çš„ inode_operationsã€‚æ¯ä¸ªæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿé€šè¿‡ rtems_filesystem_mount_table_entry_t è¡¨ç¤ºï¼Œç±»ä¼¼äº Linux çš„ super_blockï¼Œå…¶ä¸­åŒ…å«äº†æŒ‡å‘æ“ä½œè¡¨ ops çš„æŒ‡é’ˆã€‚å½“ç”¨æˆ·å‘èµ·å¦‚ openã€readã€write ç­‰æ–‡ä»¶è®¿é—®è¯·æ±‚æ—¶ï¼Œç³»ç»Ÿé¦–å…ˆé€šè¿‡ eval_path_h å‡½æ•°è§£æè·¯å¾„å¹¶å®šä½åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œç„¶åä½¿ç”¨è¯¥èŠ‚ç‚¹ä¸­æŒ‚è½½çš„ rtems_filesystem_file_handlers_rï¼ˆç±»ä¼¼ Linux çš„ file_operationsï¼‰æ¥å®Œæˆå…·ä½“æ“ä½œã€‚æ•´ä¸ªè®¾è®¡å°†æŒ‚è½½ç®¡ç†ã€è·¯å¾„è§£æå’Œæ–‡ä»¶æ“ä½œèŒè´£åˆ†ç¦»ï¼Œå½¢æˆæ¸…æ™°çš„æ¨¡å—è¾¹ç•Œï¼ŒåŒæ—¶å€Ÿé‰´äº† Linux æ–‡ä»¶ç³»ç»Ÿæ¶æ„çš„æ€æƒ³ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">rtems_filesystem_operations_table</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// æŒ‚è½½ç‚¹åŠ é”å‡½æ•°ï¼Œé˜²æ­¢å¹¶å‘è®¿é—®æŒ‚è½½ç‚¹ç»“æ„ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_mt_entry_lock_t</span> lock_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‚è½½ç‚¹è§£é”å‡½æ•°ï¼Œä¸ lock_h æˆå¯¹ä½¿ç”¨ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_mt_entry_unlock_t</span> unlock_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·¯å¾„è§£æå‡½æ•°ï¼Œå°†è·¯å¾„è½¬æ¢ä¸ºæ–‡ä»¶ç³»ç»ŸèŠ‚ç‚¹ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_eval_path_t</span> eval_path_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºç¡¬é“¾æ¥çš„å‡½æ•°ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_link_t</span> link_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­ä¸¤ä¸ªèŠ‚ç‚¹æ˜¯å¦è¡¨ç¤ºåŒä¸€å¯¹è±¡çš„å‡½æ•°ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_are_nodes_equal_t</span> are_nodes_equal_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–‡ä»¶ç³»ç»ŸèŠ‚ç‚¹ï¼ˆå¦‚æ–‡ä»¶ã€ç›®å½•ã€è®¾å¤‡èŠ‚ç‚¹ï¼‰çš„å‡½æ•°ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_mknod_t</span> mknod_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ é™¤æ–‡ä»¶ç³»ç»ŸèŠ‚ç‚¹çš„å‡½æ•°ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_rmnod_t</span> rmnod_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ”¹èŠ‚ç‚¹æƒé™çš„å‡½æ•°ï¼Œç›¸å½“äº chmodã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_fchmod_t</span> fchmod_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ”¹èŠ‚ç‚¹æ‰€æœ‰è€…ä¿¡æ¯çš„å‡½æ•°ï¼Œç›¸å½“äº chownã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_chown_t</span> chown_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…‹éš†èŠ‚ç‚¹çš„å‡½æ•°ï¼Œé€šå¸¸ç”¨äºç›®å½•é¡¹å¼•ç”¨å¢åŠ æ—¶å¤åˆ¶èŠ‚ç‚¹ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_clonenode_t</span> clonenod_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹èµ„æºçš„å‡½æ•°ï¼Œé€šå¸¸åœ¨èŠ‚ç‚¹å¼•ç”¨å‡å°‘åˆ° 0 æ—¶è°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_freenode_t</span> freenod_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç³»ç»ŸæŒ‚è½½å¤„ç†å‡½æ•°ï¼Œå¤„ç†å®é™…æŒ‚è½½é€»è¾‘ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_mount_t</span> mount_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç³»ç»Ÿå¸è½½å¤„ç†å‡½æ•°ï¼Œé‡Šæ”¾æŒ‚è½½ç›¸å…³èµ„æºã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_unmount_t</span> unmount_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç³»ç»Ÿè‡ªå®šä¹‰å¸è½½é’©å­ï¼Œç”¨äºæŒ‚è½½å…¥å£è¢«æ¸…ç†æ—¶çš„å›è°ƒã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_fsunmount_me_t</span> fsunmount_me_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿®æ”¹èŠ‚ç‚¹æ—¶é—´æˆ³ä¿¡æ¯çš„å‡½æ•°ï¼Œç›¸å½“äº utimensatã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_utimens_t</span> utimens_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºç¬¦å·é“¾æ¥çš„å‡½æ•°ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_symlink_t</span> symlink_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–ç¬¦å·é“¾æ¥ç›®æ ‡è·¯å¾„çš„å‡½æ•°ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_readlink_t</span> readlink_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡å‘½åæ–‡ä»¶æˆ–ç›®å½•çš„å‡½æ•°ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_rename_t</span> rename_h;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ–‡ä»¶ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯çš„å‡½æ•°ï¼Œå¦‚ç©ºé—´å¤§å°ã€inode æ•°ç­‰ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_statvfs_t</span> statvfs_h;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><h4 id="rtems_libio_allocate"><a href="#rtems_libio_allocate" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#rtems_libio_allocate"></a> rtems_libio_allocate()</h4><p>open å‡½æ•°ä¸­åˆ†é…æ–‡ä»¶æè¿°ç¬¦ç»“æ„ä½¿ç”¨çš„å‡½æ•°æ˜¯ rtems_libio_allocate()ï¼Œæ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <pre class="mermaid">flowchart TD
    A[å¼€å§‹ rtems_libio_allocate å‡½æ•°] --> B[åŠ é”ä¿æŠ¤ç©ºé—²é“¾è¡¨]
    B --> C[ä»ç©ºé—²é“¾è¡¨å¤´è·å– iop]
    C --> D{iop æ˜¯å¦ä¸º NULL?}
    D -- å¦ --> E[è·å– iop->data1 åˆ° next]
    E --> F[æ›´æ–°ç©ºé—²é“¾è¡¨å¤´æŒ‡é’ˆä¸º next]
    F --> G{next æ˜¯å¦ä¸º NULL}
    G -- æ˜¯ --> H[æ›´æ–°å°¾æŒ‡é’ˆä¸º &rtems_libio_iop_free_head]
    G -- å¦ --> I[ä¸æ“ä½œ]
    D -- æ˜¯ --> I
    H --> J[è§£é”é‡Šæ”¾è®¿é—®]
    I --> J
    J --> K[è¿”å› iop]</pre> <h5 id="rtems_libio_iop_free_head"><a href="#rtems_libio_iop_free_head" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#rtems_libio_iop_free_head"></a> rtems_libio_iop_free_head</h5><p>rtems_libio_iop_free_head æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç”¨äºç»´æŠ¤ Rtems æ–‡ä»¶æè¿°ç¬¦ï¼ˆrtems_libio_tï¼‰çš„ç©ºé—²é“¾è¡¨å¤´æŒ‡é’ˆã€‚</p><p>åœ¨åˆå§‹åŒ–é˜¶æ®µï¼ŒRtems ä¼šé¢„åˆ†é…ä¸€å®šæ•°é‡çš„ rtems_libio_t ç»“æ„ï¼Œå¹¶é€šè¿‡ data1 å­—æ®µå°†å®ƒä»¬ä¸²æˆä¸€ä¸ªå•å‘é“¾è¡¨ã€‚rtems_libio_iop_free_head æŒ‡å‘ç¬¬ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹ã€‚æ¯æ¬¡ rtems_libio_allocate() è¢«è°ƒç”¨æ—¶ï¼Œä»å¤´éƒ¨å–å‡ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶æ›´æ–°é“¾è¡¨ã€‚å¦‚æœåˆ†é…åé“¾è¡¨ä¸ºç©ºï¼Œrtems_libio_iop_free_tail ä¼šè¢«æŒ‡å‘ &amp;rtems_libio_iop_free_headï¼Œè¡¨ç¤ºç©ºäº†ã€‚é‡Šæ”¾èŠ‚ç‚¹æ—¶ä¼šè°ƒç”¨ä¸€ä¸ªå¯¹åº”çš„ rtems_libio_free(iop)ï¼Œå°†èŠ‚ç‚¹é‡æ–°æŒ‚å›é“¾è¡¨å°¾éƒ¨ã€‚</p><p>é‚£å…¶å®å¯¹äº rtems_libio_t é“¾è¡¨è€Œè¨€ï¼Œåœ¨é¢„åˆ†é…çš„æ—¶å€™å°±éœ€è¦å°† rtems_filesystem_location_info_tt ä¸­å…³äºæ–‡ä»¶ç³»ç»Ÿå…¨å±€çš„ rtems_filesystem_file_handlers_r å’Œ rtems_filesystem_mount_table_entry_tt ä¿¡æ¯å†™å…¥ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™èƒ½å¤ŸæˆåŠŸè°ƒç”¨åº•å±‚å‡½æ•°ã€‚</p><p>åˆå§‹åŒ–é˜¶æ®µçš„å‡½æ•°é€»è¾‘å¦‚ä¸‹ï¼š</p> <pre class="mermaid">flowchart TD
    A[å¼€å§‹ rtems_libio_init å‡½æ•°] --> B{rtems_libio_number_iops > 0?}
    B -- å¦ --> Z[ç»“æŸå‡½æ•°]
    B -- æ˜¯ --> C[è®¾ç½®ç©ºé—²é“¾è¡¨å¤´æŒ‡é’ˆ]
    C --> D[åˆå§‹åŒ–å¾ªç¯å˜é‡ i = 0]
    D --> E{i + 1 < rtems_libio_number_iops?}
    E -- æ˜¯ --> F[è®¾ç½® iop->data1 = iop + 1]
    F --> G[i++, iop++]
    G --> E
    E -- å¦ --> H[è®¾ç½®æœ€åä¸€ä¸ª iop->data1 = NULL]
    H --> I[è®¾ç½®é“¾è¡¨å°¾æŒ‡é’ˆ rtems_libio_iop_free_tail = &iop->data1]
    I --> Z</pre> <p>rtems_libio_iops æ˜¯ Rtems é¢„å…ˆåˆ†é…çš„ I/O æ§åˆ¶å—æ•°ç»„ï¼Œé…ç½®äº† CONFIGURE_MAXIMUM_FILE_DESCRIPTORS ä»¥åï¼Œä¼šé¢„å…ˆåˆ›å»ºå‡ºè¿™ä¸ªæ•°ç»„ã€‚</p><p>é—®é¢˜æ¥äº†ï¼šæœ‰äº†è¿™ä¸ªæ•°ç»„ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä¸€ä¸ªé¢å¤–çš„ free list é“¾è¡¨æ¥ç®¡ç†å‘¢ï¼Ÿ</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIGURE_MAXIMUM_FILE_DESCRIPTORS &gt; 0</span></span><br><span class="line"><span class="type">rtems_libio_t</span> rtems_libio_iops[CONFIGURE_MAXIMUM_FILE_DESCRIPTORS];</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> rtems_libio_number_iops = RTEMS_ARRAY_SIZE(rtems_libio_iops);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></div></figure><h4 id="do_open"><a href="#do_open" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#do_open"></a> do_open()</h4><p>open() å‡½æ•°ä¸­åˆ†é…å¥½æ–‡ä»¶æè¿°ç¬¦ç»“æ„ä»¥åï¼Œæœ€ç»ˆä¼šåˆ°è¾¾ do_open() å‡½æ•°çš„ä½ç½®è¿›è¡Œå¤„ç†ã€‚</p><p>å‡½æ•°å¼€å§‹æ—¶ï¼Œä» iop è·å–æ–‡ä»¶æè¿°ç¬¦ fdï¼Œå¹¶æ ¹æ® oflag è§£æè¯»å†™æƒé™ã€åˆ›å»ºã€ç‹¬å ã€æˆªæ–­å’Œç›®å½•æ‰“å¼€ç­‰æ ‡å¿—ã€‚ç„¶åç¡®å®šæ˜¯å¦è·Ÿéšç¬¦å·é“¾æ¥ï¼Œç»„åˆè·¯å¾„è§£ææ‰€éœ€çš„æƒé™æ ‡å¿— eval_flagsã€‚</p><p>æ¥ç€åˆå§‹åŒ–è·¯å¾„è§£æä¸Šä¸‹æ–‡ï¼Œè§£æè·¯å¾„å¹¶è·å–å½“å‰æ–‡ä»¶ç³»ç»Ÿä½ç½®ã€‚è‹¥æ”¯æŒåˆ›å»ºæ™®é€šæ–‡ä»¶ä¸”è·¯å¾„æœªç»“æŸï¼Œåˆ™è°ƒç”¨åˆ›å»ºæ–‡ä»¶çš„å‡½æ•°ã€‚éšååˆ¤æ–­æ˜¯å¦ä»¥ç›®å½•æ–¹å¼æ‰“å¼€ï¼Œå¹¶æ£€æŸ¥å†™æƒé™å’Œç›®å½•ç±»å‹çš„åˆæ³•æ€§ï¼Œé˜²æ­¢å†™ç›®å½•æˆ–ä»¥ç›®å½•æ–¹å¼æ‰“å¼€éç›®å½•ã€‚</p><p>è·¯å¾„ä¿¡æ¯ä¿å­˜åˆ° iop-&gt;pathinfoï¼Œæ¸…ç†è·¯å¾„è§£æä¸Šä¸‹æ–‡åï¼Œè®¾ç½®æ–‡ä»¶æ§åˆ¶æ ‡å¿—ï¼Œè°ƒç”¨åº•å±‚é©±åŠ¨çš„ open å‡½æ•°æ‰“å¼€æ–‡ä»¶ã€‚è‹¥æˆåŠŸä¸”æŒ‡å®šæˆªæ–­ï¼Œåˆ™è°ƒç”¨ ftruncate æˆªæ–­æ–‡ä»¶å†…å®¹ï¼Œæˆªæ–­å¤±è´¥æ—¶å…³é—­æ–‡ä»¶ã€‚</p><p>æœ€åï¼Œè‹¥æ“ä½œå…¨éƒ¨æˆåŠŸï¼Œè®¾ç½®æ–‡ä»¶æ‰“å¼€æ ‡å¿—å¹¶è¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼›å¤±è´¥æ—¶é‡Šæ”¾èµ„æºå¹¶è¿”å›é”™è¯¯ã€‚æ•´ä¸ªè¿‡ç¨‹ç¡®ä¿äº†è·¯å¾„è§£æã€æƒé™æ£€æŸ¥å’Œæ–‡ä»¶æ‰“å¼€çš„æ­£ç¡®æ€§å’Œå®‰å…¨æ€§ã€‚</p><p>do_open() å‡½æ•°çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <pre class="mermaid">flowchart TD
    A[å¼€å§‹ do_open] --> B[è§£æå‚æ•°å’Œæ ‡å¿—]
    B --> C[è·¯å¾„è§£æå¯åŠ¨: rtems_filesystem_eval_path_start]
    C --> D[è·å– currentloc å’Œæ˜¯å¦æ”¯æŒåˆ›å»ºæ–‡ä»¶]
    D --> E{æ˜¯å¦éœ€è¦åˆ›å»ºæ™®é€šæ–‡ä»¶?}
    E -- æ˜¯ --> F[create_regular_file]
    E -- å¦ --> G[è·³è¿‡åˆ›å»º]
    F --> H[æ˜¯å¦ä¸ºç›®å½•æ‰“å¼€æˆ–éœ€è¦å†™æƒé™?]
    G --> H
    H --> I{è·¯å¾„ç±»å‹æ£€æŸ¥}
    I -- é”™è¯¯: å†™ç›®å½• --> J[è®¾ç½® EISDIR é”™è¯¯]
    I -- é”™è¯¯: éç›®å½• --> K[è®¾ç½® ENOTDIR é”™è¯¯]
    I --> L[æå– pathinfo å¹¶æ¸…ç†ä¸Šä¸‹æ–‡]

    L --> M[è®¾ç½® LibIO æ‰“å¼€æ ‡å¿—]
    M --> N[è°ƒç”¨åº•å±‚ open å‡½æ•°]
    N --> O{open æ˜¯å¦æˆåŠŸ?}
    O -- å¦ --> P[é‡Šæ”¾ iop å¹¶è¿”å› -1]
    O -- æ˜¯ --> Q{æ˜¯å¦éœ€è¦æˆªæ–­?}
    Q -- æ˜¯ --> R{æ˜¯å¦æœ‰å†™æƒé™?}
    R -- å¦ --> S[errno = EINVAL, è¿”å›é”™è¯¯]
    R -- æ˜¯ --> T[è°ƒç”¨ ftruncate]
    T --> U{ftruncate æˆåŠŸ?}
    U -- å¦ --> V[è°ƒç”¨ close, è¿”å› -1]
    U -- æ˜¯ --> W[è®¾ç½® LIBIO_FLAGS_OPEN, è¿”å› fd]
    Q -- å¦ --> W
    S --> P
    V --> P</pre> <h5 id="è·¯å¾„è§£æè¿‡ç¨‹"><a href="#è·¯å¾„è§£æè¿‡ç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#è·¯å¾„è§£æè¿‡ç¨‹"></a> è·¯å¾„è§£æè¿‡ç¨‹</h5><p>do_open() æ¶‰åŠåˆ°çš„è·¯å¾„è§£æä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯åŠ¨è·¯å¾„è§£æï¼Œå‡†å¤‡è§£ææ–‡ä»¶è·¯å¾„ã€‚</span></span><br><span class="line">rtems_filesystem_eval_path_start(&amp;ctx, path, eval_flags);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–è§£æåçš„å½“å‰è·¯å¾„ä½ç½®ä¿¡æ¯ã€‚</span></span><br><span class="line">currentloc = rtems_filesystem_eval_path_get_currentloc(&amp;ctx);</span><br></pre></td></tr></table></div></figure><p>rtems_filesystem_eval_path_start() çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <pre class="mermaid">flowchart TD
    A[è°ƒç”¨ rtems_filesystem_eval_path_start] --> B[è°ƒç”¨ rtems_filesystem_eval_path_start_with_root_and_current]
    B --> C[æ¸…ç©ºä¸Šä¸‹æ–‡ memset]
    C --> D[è®¾ç½® ctx è·¯å¾„å’Œé•¿åº¦]
    D --> E[è®¾ç½® ctx æ ‡å¿—ä½]
    E --> F[åˆå§‹åŒ–èµ·å§‹ä½ç½® set_startloc]
    F --> G[é”å®šèµ·å§‹ä½ç½® rtems_filesystem_instance_lock]
    G --> H[å¤åˆ¶ startloc åˆ° currentloc]
    H --> I[ç»§ç»­è§£æè·¯å¾„ rtems_filesystem_eval_path_continue]
    I --> J[è¿”å› ctx currentloc]</pre> <p>å¯ä»¥çœ‹å‡ºæœ€åè¿›å…¥äº† rtems_filesystem_eval_path_continue() å‡½æ•°ï¼ŒåµŒå¥—å¤ªæ·±äº†ã€‚ç›®å‰çœ‹ä¸æ‡‚æ•´ä¸ªè·¯å¾„çš„è§£æè¿‡ç¨‹ã€‚</p><p>è·¯å¾„è§£æå®Œæ¯•åï¼Œdo_open() å‡½æ•°ä¸­æ‰§è¡Œä»¥ä¸‹å‡½æ•°ç”¨äºç»´æŠ¤çŠ¶æ€ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–è§£æåçš„å½“å‰è·¯å¾„ä½ç½®ä¿¡æ¯ã€‚</span></span><br><span class="line">currentloc = rtems_filesystem_eval_path_get_currentloc(&amp;ctx);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­å½“å‰è·¯å¾„æ‰€åœ¨æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦å…è®¸åˆ›å»ºæ™®é€šæ–‡ä»¶ã€‚</span></span><br><span class="line">create_reg_file = !currentloc-&gt;mt_entry-&gt;no_regular_file_mknod;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†è·¯å¾„è§£æå¾—åˆ°çš„å½“å‰è·¯å¾„ä¿¡æ¯ä¿å­˜åˆ° iop çš„ pathinfo ä¸­ã€‚</span></span><br><span class="line">rtems_filesystem_eval_path_extract_currentloc(&amp;ctx, &amp;iop-&gt;pathinfo);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç†è·¯å¾„è§£æä¸Šä¸‹æ–‡ï¼Œé‡Šæ”¾èµ„æºã€‚</span></span><br><span class="line">rtems_filesystem_eval_path_cleanup(&amp;ctx);</span><br></pre></td></tr></table></div></figure><h5 id="åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„-open-å‡½æ•°"><a href="#åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„-open-å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„-open-å‡½æ•°"></a> åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„ open å‡½æ•°</h5><p>æ‹¿åˆ°æ‰€æœ‰ä¿¡æ¯ä»¥åï¼Œdo_open() å‡½æ•°ä¸­è°ƒç”¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„ open() å‡½æ•°çœŸæ­£æ‰“å¼€æ–‡ä»¶ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„ open å‡½æ•°æ‰“å¼€æ–‡ä»¶ã€‚</span></span><br><span class="line">rv = (*iop-&gt;pathinfo.handlers-&gt;open_h)(iop, path, oflag, mode);</span><br></pre></td></tr></table></div></figure><h3 id="close"><a href="#close" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#close"></a> close()</h3><p>close() å‡½æ•°çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ã€‚åœ¨å‰é¢æ›´æ”¹å®ŒçŠ¶æ€æ ‡å¿—ä½åï¼Œè¿˜æ˜¯ä¼šè¿›å…¥åˆ°åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„ close_h å‡½æ•°ã€‚</p> <pre class="mermaid">flowchart TD
  A[å¼€å§‹å…³é—­ fd] --> B{æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦è¶Šç•Œ}
  B -- æ˜¯ --> C[è®¾ç½®é”™è¯¯ç åæ–‡ä»¶æè¿°ç¬¦å¹¶è¿”å›å¤±è´¥]
  B -- å¦ --> D[è·å–å¯¹åº”çš„ I/O å¯¹è±¡]
  D --> E[è¯»å– I/O å¯¹è±¡æ ‡å¿—]
  E --> F{æ ‡å¿—ä¸­æ˜¯å¦åŒ…å«æ‰“å¼€çŠ¶æ€}
  F -- å¦ --> G[è®¾ç½®é”™è¯¯ç åæ–‡ä»¶æè¿°ç¬¦å¹¶è¿”å›å¤±è´¥]
  F -- æ˜¯ --> H[æ¸…é™¤å¼•ç”¨è®¡æ•°éƒ¨åˆ†]
  H --> I[æ„é€ å»æ‰æ‰“å¼€æ ‡å¿—çš„æ–°æ ‡å¿—]
  I --> J[æ‰§è¡ŒåŸå­æ¯”è¾ƒäº¤æ¢æ“ä½œ]
  J --> K{æ¯”è¾ƒäº¤æ¢æ˜¯å¦æˆåŠŸ}
  K -- æ˜¯ --> L[ç»§ç»­å…³é—­å¤„ç†]
  K -- å¦ --> M{æ ‡å¿—ä¸­æ˜¯å¦æœ‰éæ³•çŠ¶æ€}
  M -- æ˜¯ --> N[è®¾ç½®é”™è¯¯ç è®¾å¤‡å¿™å¹¶è¿”å›å¤±è´¥]
  M -- å¦ --> F

  L --> O[è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿçš„å…³é—­å‡½æ•°]
  O --> P[é‡Šæ”¾ I/O å¯¹è±¡]
  P --> Q[è¿”å›å…³é—­ç»“æœ]</pre> <h3 id="read"><a href="#read" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#read"></a> read()</h3><p>read() å‡½æ•°çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ã€‚å¯ä»¥çœ‹å‡ºé™¤äº†åšäº†ä¸€äº›æ£€æŸ¥ä»¥å¤–ï¼Œç›´æ¥è°ƒç”¨äº†åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„ read_h() å‡½æ•°ã€‚</p> <pre class="mermaid">flowchart TD
  A[å¼€å§‹è°ƒç”¨ read å‡½æ•°] --> B[ç¡®è®¤ç¼“å†²åŒºæŒ‡é’ˆæœ‰æ•ˆ]
  B --> C[ç¡®è®¤è¯»å–é•¿åº¦åˆç†]
  C --> D{å°è¯•è·å–å¯¹åº”çš„ I/O å¯¹è±¡å¹¶æ£€æŸ¥æ˜¯å¦å¯è¯»}
  D -- å¤±è´¥ --> E[è®¾ç½®é”™è¯¯ç ä¸ºåæ–‡ä»¶æè¿°ç¬¦å¹¶è¿”å›å¤±è´¥]
  D -- æˆåŠŸ --> F[è°ƒç”¨åº•å±‚è¯»æ“ä½œå®Œæˆè¯»å–]
  F --> G[é‡Šæ”¾ I/O èµ„æº]
  G --> H[è¿”å›è¯»å–åˆ°çš„å­—èŠ‚æ•°æˆ–è€…é”™è¯¯ç ]</pre> <h3 id="write"><a href="#write" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#write"></a> write()</h3><p>write() å‡½æ•°çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ã€‚å¤§è‡´é€»è¾‘åŒæ ·åŒ read å‡½æ•°ã€‚</p> <pre class="mermaid">flowchart TD
  A[å¼€å§‹è°ƒç”¨ write å‡½æ•°] --> B[ç¡®è®¤ç¼“å†²åŒºæŒ‡é’ˆæœ‰æ•ˆ]
  B --> C[ç¡®è®¤å†™å…¥å­—èŠ‚æ•°åˆç†]
  C --> D{å°è¯•è·å–å¯¹åº”çš„ I/O å¯¹è±¡å¹¶æ£€æŸ¥æ˜¯å¦å¯å†™}
  D -- å¤±è´¥ --> E[è®¾ç½®é”™è¯¯ç åæ–‡ä»¶æè¿°ç¬¦å¹¶è¿”å›å¤±è´¥]
  D -- æˆåŠŸ --> F[è°ƒç”¨åº•å±‚å†™æ“ä½œå®Œæˆå†™å…¥]
  F --> G[é‡Šæ”¾ I/O èµ„æº]
  G --> H[è¿”å›å†™å…¥çš„å­—èŠ‚æ•°æˆ–é”™è¯¯ç ]</pre> <h2 id="æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨æµç¨‹"><a href="#æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨æµç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨æµç¨‹"></a> æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨æµç¨‹</h2><h3 id="rtems_filesystem_initialize"><a href="#rtems_filesystem_initialize" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#rtems_filesystem_initialize"></a> rtems_filesystem_initialize()</h3><p>è¯¥å‡½æ•°ç”¨äºåˆå§‹åŒ– Rtems çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œé€šå¸¸æ˜¯ IMFSã€‚<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://docs.rtems.org/docs/6.1/filesystem/system_init.html">å®˜æ–¹æ–‡æ¡£</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> æåˆ°ï¼Œå…¶ä»–æ–‡ä»¶ç³»ç»Ÿå¯ä»¥è¢«æŒ‚è½½ï¼Œä½†å®ƒä»¬åªèƒ½æŒ‚è½½åˆ°åŸºç¡€æ–‡ä»¶ç³»ç»Ÿä¸­çš„æŸä¸ªç›®å½•æŒ‚è½½ç‚¹ã€‚å¯¹äºæˆ‘ä»¬æƒ³æ³¨å†Œçš„è‡ªå®šä¹‰æ–‡ä»¶ç³»ç»Ÿï¼Œæœ‰ä¸¤ç§æ‰‹æ®µï¼Œä¸€ç§æ˜¯åœ¨æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½å¥½ä»¥åï¼Œæ‰¾åˆ°æŸä¸ªç›®å½•æ‰‹åŠ¨æŒ‚è½½æ–°æ–‡ä»¶ç³»ç»Ÿï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥ä¿®æ”¹ rtems_filesystem_root_configuration æ ¹æ–‡ä»¶ç³»ç»Ÿçš„é…ç½®ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™æ · Rtems åœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šé»˜è®¤è·‘æˆ‘ä»¬è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>rtems_filesystem_initialize() å‡½æ•°çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <pre class="mermaid">flowchart TD
  A[å¼€å§‹åˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿ] --> B[è·å–æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½é…ç½®ä¿¡æ¯]
  B --> C[æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ]
  C --> D{æŒ‚è½½æ˜¯å¦æˆåŠŸ}
  D -- å¦ --> E[è§¦å‘è‡´å‘½é”™è¯¯åœæ­¢ç³»ç»Ÿ]
  D -- æ˜¯ --> F[åˆ›å»º /dev ç›®å½•]
  F --> G{ç›®å½•åˆ›å»ºæ˜¯å¦æˆåŠŸ}
  G -- å¦ --> H[è§¦å‘è‡´å‘½é”™è¯¯åœæ­¢ç³»ç»Ÿ]
  G -- æ˜¯ --> I[æ ¹æ–‡ä»¶ç³»ç»Ÿå’Œ /dev ç›®å½•åˆ›å»ºå®Œæˆ]
  I --> J[è¯´æ˜å…¶ä»–æ–‡ä»¶ç³»ç»Ÿéœ€æ‰‹åŠ¨æŒ‚è½½]
  J --> K[åˆå§‹åŒ–å®Œæˆ]</pre> <h4 id="struct-rtems_filesystem_mount_configuration"><a href="#struct-rtems_filesystem_mount_configuration" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-rtems_filesystem_mount_configuration"></a> struct rtems_filesystem_mount_configuration</h4><p>æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½é…ç½®ä¿¡æ¯çš„ç»“æ„ä½“æ˜¯ struct rtems_filesystem_mount_configurationã€‚è¯¥ç»“æ„ä½“æ˜¯ Rtems ä¸­ç”¨äºæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿæ—¶ä¼ é€’å‚æ•°çš„é…ç½®ç»“æ„ã€‚å®ƒçš„ä½œç”¨æ˜¯å°†æŒ‚è½½ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ‰€éœ€çš„å„ç§ä¿¡æ¯ï¼ˆå¦‚è®¾å¤‡æºã€æŒ‚è½½ç‚¹ã€æ–‡ä»¶ç³»ç»Ÿç±»å‹ç­‰ï¼‰é›†ä¸­åœ¨ä¸€èµ·ï¼Œä½œä¸ºå‚æ•°ä¼ ç»™ mount() å‡½æ•°ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// æè¿°æŒ‚è½½æºï¼Œé€šå¸¸æ˜¯è®¾å¤‡è·¯å¾„ï¼Œå¦‚ &quot;/dev/sd0&quot;ï¼›å¯¹ IMFS ç­‰å†…å­˜æ–‡ä»¶ç³»ç»Ÿå¯ä¸º NULLã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *source;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‚è½½ç›®æ ‡ç›®å½•ï¼Œå¿…é¡»æ˜¯ç³»ç»Ÿä¸­å·²å­˜åœ¨çš„è·¯å¾„ï¼Œå¦‚ &quot;/&quot; æˆ– &quot;/mnt/usb&quot;ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *target;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç³»ç»Ÿç±»å‹çš„åç§°å­—ç¬¦ä¸²ï¼Œå¦‚ &quot;imfs&quot;ã€&quot;dosfs&quot;ã€&quot;devfs&quot; ç­‰ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *filesystemtype;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‚è½½é€‰é¡¹ï¼Œå®šä¹‰ä¸º rtems_filesystem_options_t ç±»å‹ï¼Œæ§åˆ¶å¦‚åªè¯»ã€è¯»å†™ç­‰è¡Œä¸ºã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_options_t</span> options;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡å‘æ–‡ä»¶ç³»ç»Ÿç‰¹å®šçš„é™„åŠ æ•°æ®ï¼Œä¸€èˆ¬ä¸º NULLï¼ŒæŸäº›æ–‡ä»¶ç³»ç»Ÿå¯èƒ½ä½¿ç”¨æ­¤å­—æ®µä¼ é€’é…ç½®ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">void</span> *data;</span><br><span class="line">&#125; rtems_filesystem_mount_configuration;</span><br></pre></td></tr></table></div></figure><p>åœ¨ rtems_filesystem_initialize() ä¸­ï¼Œæ ¹æ–‡ä»¶ç³»ç»Ÿçš„é…ç½®æ˜¯é¢„å®šä¹‰å¥½çš„å…¨å±€å˜é‡ rtems_filesystem_root_configurationã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> rtems_filesystem_mount_configuration rtems_filesystem_root_configuration = &#123;</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    RTEMS_FILESYSTEM_READ_WRITE,</span><br><span class="line">    &amp;IMFS_root_mount_data,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><h3 id="rtems_filesystem_register"><a href="#rtems_filesystem_register" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#rtems_filesystem_register"></a> rtems_filesystem_register()</h3><p>rtems_filesystem_register() ç”¨äºåœ¨ Rtems æ“ä½œç³»ç»Ÿä¸­æ³¨å†Œä¸€ä¸ªæ–°çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚å®ƒæ¥æ”¶æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹åç§°å’Œå¯¹åº”çš„æŒ‚è½½å‡½æ•°æŒ‡é’ˆï¼ŒåŠ¨æ€åˆ†é…å†…å­˜åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»ŸèŠ‚ç‚¹ï¼Œå°†ç±»å‹åç§°å’ŒæŒ‚è½½å‡½æ•°ä¿å­˜åˆ°è¯¥èŠ‚ç‚¹ä¸­ï¼Œå¹¶æ£€æŸ¥è¯¥ç±»å‹æ˜¯å¦å·²è¢«æ³¨å†Œã€‚å¦‚æœæœªæ³¨å†Œï¼Œåˆ™å°†è¯¥èŠ‚ç‚¹æ·»åŠ åˆ°å…¨å±€æ–‡ä»¶ç³»ç»Ÿé“¾è¡¨å®Œæˆæ³¨å†Œï¼›å¦‚æœå·²æ³¨å†Œï¼Œåˆ™é‡Šæ”¾å†…å­˜å¹¶è¿”å›é”™è¯¯ã€‚é€šè¿‡è¿™ä¸ªæ³¨å†Œæœºåˆ¶ï¼Œç³»ç»Ÿèƒ½å¤Ÿè¯†åˆ«å’Œç®¡ç†å¤šç§æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œå¹¶åœ¨éœ€è¦æ—¶è°ƒç”¨å¯¹åº”çš„æŒ‚è½½å‡½æ•°è¿›è¡ŒæŒ‚è½½æ“ä½œã€‚</p><p>rtems_filesystem_register() çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <pre class="mermaid">flowchart TD
    A[å¼€å§‹ rtems_filesystem_register] --> B[è®¡ç®— type_size ä¸ fsn_size å¹¶ malloc åˆ†é… fsn]
    B --> C{fsn æ˜¯å¦ä¸º NULL?}
    C -- æ˜¯ --> D[è®¾ç½® errno ç­‰äº ENOMEM å¹¶è¿”å› -1]
    C -- å¦ --> E[è®¡ç®— type_storage å¹¶ memcpy å¤åˆ¶ç±»å‹å­—ç¬¦ä¸²]
    E --> F[è®¾ç½® fsn->entry.type ç­‰äº type_storage]
    F --> G[è®¾ç½® fsn->entry.mount_h ç­‰äº mount_h]
    G --> H[rtems_libio_lock è¿›å…¥ä¸´ç•ŒåŒº]
    H --> I{rtems_filesystem_get_mount_handler åˆ¤æ–­ type æ˜¯å¦å·²æ³¨å†Œ}
    I -- æœªæ³¨å†Œ --> J[rtems_chain_initialize_node åˆå§‹åŒ–é“¾è¡¨èŠ‚ç‚¹]
    J --> K[rtems_chain_append_unprotected å°† fsn æ·»åŠ åˆ°å…¨å±€é“¾è¡¨]
    K --> L[rtems_libio_unlock è§£é”]
    L --> M[è¿”å› 0 æ³¨å†ŒæˆåŠŸ]
    I -- å·²æ³¨å†Œ --> N[rtems_libio_unlock è§£é”]
    N --> O[free fsn é‡Šæ”¾å†…å­˜]
    O --> P[è®¾ç½® errno ç­‰äº EINVAL å¹¶è¿”å› -1]</pre> <p>åœ¨ rtems_filesystem_register() çš„æºç ä¸­ï¼Œæœ‰å‡ è¡Œæ¯”è¾ƒç»†èŠ‚çš„åœ°æ–¹ã€‚åœ¨ Rtems ä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„æ³¨å†Œå…¨å±€è¡¨æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯é™æ€è¡¨ rtems_filesystem_tableï¼Œä¸€ä¸ªæ˜¯åŠ¨æ€è¡¨ filesystem_chainã€‚é™æ€è¡¨æ˜¯ Rtems é¢„å…ˆå®šä¹‰å¥½çš„å¸¸é‡ï¼Œæä¾›äº† Rtems å†…ç½®çš„æ–‡ä»¶ç³»ç»Ÿã€‚åŠ¨æ€è¡¨ç”¨äºç”¨æˆ·åŠ¨æ€æ³¨å†Œæ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨ä¸‹é¢çš„å‡½æ•°å®ç°ä¸­ï¼Œå¦‚æœå‘ç°å…¨å±€è¡¨æ²¡æœ‰æ³¨å†Œè¯¥æ–‡ä»¶ç³»ç»Ÿï¼ŒRtems ä¼šå°†è¯¥æ–‡ä»¶ç³»ç»ŸæŒ‚åˆ° filesystem_chain ä¸Šã€‚</p><p>å¥½ï¼Œé—®é¢˜æ¥äº†ï¼Œè¡¨é‡Œé¢é™¤äº† type æˆå‘˜ï¼Œæ›´é‡è¦çš„æ˜¯æŒ‚è½½å‡½æ•° rtems_filesystem_fsmount_me_tã€‚è¿™ä¸ªå‡½æ•°æ˜¯éœ€è¦æˆ‘ä»¬è‡ªå·±å†™çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ Rtems åœ¨æ³¨å†Œæ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™ï¼Œé™¤äº†è®°å½•åˆ°æ³¨å†Œå…¨å±€è¡¨ä»¥åï¼Œå°±æ²¡æœ‰å…¶ä»–æ¶æ„ä¸Šçš„æ“ä½œäº†ã€‚åé¢çš„æ“ä½œéƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±åšï¼ŒRtems çš„æ–‡ä»¶ç³»ç»Ÿè™šæ‹Ÿå±‚ç›®å‰çœ‹èµ·æ¥å‡ ä¹æ²¡æœ‰ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rtems_chain_control *chain = &amp;filesystem_chain;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rtems_filesystem_get_mount_handler(type) == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    rtems_chain_initialize_node(&amp;fsn-&gt;node);</span><br><span class="line">    rtems_chain_append_unprotected(chain, &amp;fsn-&gt;node);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><h4 id="struct-filesystem_node"><a href="#struct-filesystem_node" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-filesystem_node"></a> struct filesystem_node</h4><p>struct filesystem_node ç»“æ„ä½“çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æè¿°ä¿¡æ¯å°è£…ä¸ºé“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½¿å¾—å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿè¡¨é¡¹å¯ä»¥é€šè¿‡é“¾è¡¨çš„å½¢å¼ç»„ç»‡å’Œç®¡ç†ã€‚å®ƒç»“åˆäº† Rtems çš„é“¾è¡¨èŠ‚ç‚¹ç»“æ„ rtems_chain_node ä¸æ–‡ä»¶ç³»ç»Ÿè¡¨é¡¹ rtems_filesystem_table_tï¼Œæ–¹ä¾¿åœ¨ç³»ç»Ÿä¸­åŠ¨æ€ç»´æŠ¤ã€æŸ¥æ‰¾å’Œæ“ä½œæ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿã€‚è¯¥ç»“æ„ä½“é€šå¸¸ç”¨äºæ„å»ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿæ³¨å†Œè¡¨ï¼Œå®ç°å¯¹å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ç»Ÿä¸€ç®¡ç†å’Œéå†ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ç±»å‹ filesystem_nodeï¼Œç”¨äºè¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿé“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// RTEMS æä¾›çš„åŒå‘é“¾è¡¨èŠ‚ç‚¹ç»“æ„ï¼Œç”¨äºå°†å¤šä¸ªæ–‡ä»¶ç³»ç»ŸèŠ‚ç‚¹è¿æ¥æˆé“¾è¡¨ã€‚</span></span><br><span class="line">    rtems_chain_node node;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç³»ç»Ÿè¡¨é¡¹ï¼ŒåŒ…å«è¯¥æ–‡ä»¶ç³»ç»Ÿçš„åˆå§‹åŒ–å‡½æ•°ã€æŒ‚è½½å‡½æ•°ç­‰æè¿°ä¿¡æ¯ã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_table_t</span> entry;</span><br><span class="line">&#125; filesystem_node;</span><br></pre></td></tr></table></div></figure><h4 id="struct-rtems_filesystem_table_t"><a href="#struct-rtems_filesystem_table_t" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-rtems_filesystem_table_t"></a> struct rtems_filesystem_table_t</h4><p>struct rtems_filesystem_table_t ç»“æ„ä½“çš„ä½œç”¨æ˜¯æè¿°ä¸€ä¸ªå¯æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼ŒåŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹åç§°å’Œå¯¹åº”çš„æŒ‚è½½å‡½æ•°ã€‚å®ƒä¸º RTEMS æä¾›äº†ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼æ¥è¡¨ç¤ºå’Œç®¡ç†ä¸åŒç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä½¿ç³»ç»Ÿèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶æ ¹æ®ç±»å‹åç§°é€‰æ‹©åˆé€‚çš„æŒ‚è½½å‡½æ•°è¿›è¡Œæ–‡ä»¶ç³»ç»Ÿåˆå§‹åŒ–å’ŒæŒ‚è½½æ“ä½œã€‚è¿™ç§è®¾è®¡æœ‰åŠ©äºæ‰©å±•æ–‡ä»¶ç³»ç»Ÿæ”¯æŒï¼Œå¹¶å®ç°çµæ´»çš„æ–‡ä»¶ç³»ç»Ÿç®¡ç†æœºåˆ¶ã€‚</p><p>åœ¨ rtems_filesystem_register() å‡½æ•°ä¸­ï¼Œæˆå‘˜ type å’Œ mount_h é€šè¿‡å‡½æ•°å‚æ•°ä¼ å…¥ï¼Œå¹¶åœ¨å‡½æ•°å†…èµ‹å€¼ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ç±»å‹ rtems_filesystem_table_tï¼Œç”¨äºæè¿°ä¸€ä¸ªå¯æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">rtems_filesystem_table_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹åç§°ï¼Œé€šå¸¸ä¸ºå­—ç¬¦ä¸²å½¢å¼ï¼Œä¾‹å¦‚ &quot;imfs&quot; æˆ– &quot;dosfs&quot;ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½å‡½æ•°æŒ‡é’ˆï¼Œç”¨äºæŒ‚è½½è¯¥ç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿã€‚</span></span><br><span class="line">    <span class="type">rtems_filesystem_fsmount_me_t</span> mount_h;</span><br><span class="line">&#125; <span class="type">rtems_filesystem_table_t</span>;</span><br></pre></td></tr></table></div></figure><h4 id="rtems_filesystem_fsmount_me_t"><a href="#rtems_filesystem_fsmount_me_t" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#rtems_filesystem_fsmount_me_t"></a> rtems_filesystem_fsmount_me_t</h4><p>rtems_filesystem_fsmount_me_t æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief åˆå§‹åŒ–ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå®ä¾‹ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¯¥å‡½æ•°è´Ÿè´£åˆå§‹åŒ–æŒ‚è½½è¡¨é¡¹ä¸­çš„æ–‡ä»¶ç³»ç»Ÿæ ¹èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param[in] mt_entry æŒ‡å‘æŒ‚è½½è¡¨é¡¹çš„æŒ‡é’ˆï¼Œè¡¨ç¤ºè¦æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿå®ä¾‹ã€‚</span></span><br><span class="line"><span class="comment"> * @param[in] data ç”¨æˆ·æä¾›çš„åˆå§‹åŒ–æ•°æ®ï¼Œå¦‚è®¾å¤‡è·¯å¾„æˆ–æŒ‚è½½é€‰é¡¹ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @retval 0 æ“ä½œæˆåŠŸï¼Œæ–‡ä»¶ç³»ç»Ÿå®ä¾‹åˆå§‹åŒ–å®Œæˆã€‚</span></span><br><span class="line"><span class="comment"> * @retval -1 æ“ä½œå¤±è´¥ï¼Œè®¾ç½® errno ä»¥æŒ‡ç¤ºå…·ä½“é”™è¯¯ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰å‡½æ•°æŒ‡é’ˆç±»å‹ rtems_filesystem_fsmount_me_tï¼Œè¡¨ç¤ºæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿçš„å‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment">// è¯¥å‡½æ•°æ¥å—æŒ‚è½½è¡¨é¡¹æŒ‡é’ˆå’Œç”¨æˆ·æ•°æ®ä½œä¸ºå‚æ•°ï¼Œè¿”å›æŒ‚è½½ç»“æœã€‚</span></span><br><span class="line"><span class="comment">// è¿”å› 0 è¡¨ç¤ºæŒ‚è½½æˆåŠŸï¼Œè¿”å› -1 è¡¨ç¤ºæŒ‚è½½å¤±è´¥ä¸”è®¾ç½® errnoã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*<span class="type">rtems_filesystem_fsmount_me_t</span>)</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="type">rtems_filesystem_mount_table_entry_t</span> *mt_entry, <span class="comment">// æŒ‡å‘æŒ‚è½½è¡¨é¡¹ï¼Œè¡¨ç¤ºè¦æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿã€‚</span></span></span><br><span class="line"><span class="params">    <span class="type">const</span> <span class="type">void</span> *data                                <span class="comment">// ç”¨æˆ·ä¼ å…¥çš„åˆå§‹åŒ–æ•°æ®ã€‚</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></div></figure><p>struct rtems_filesystem_mount_table_entry_t ç»“æ„ä½“çš„ä½œç”¨æ˜¯ä¸ºæ¯ä¸€ä¸ªå·²æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿæä¾›ä¸€ä¸ªé›†ä¸­å¼çš„æè¿°ï¼ŒåŒ…å«äº†æ–‡ä»¶ç³»ç»Ÿçš„æ ¹èŠ‚ç‚¹ä¿¡æ¯ã€æŒ‚è½½ç‚¹ã€ç±»å‹ã€è®¾å¤‡ã€è®¿é—®æ§åˆ¶çŠ¶æ€ç­‰å…³é”®ä¿¡æ¯ã€‚Rtems ä¼šç»´æŠ¤ä¸€ä¸ªè¿™æ ·çš„æŒ‚è½½è¡¨é“¾è¡¨ï¼Œæ¯ä¸ªè¡¨é¡¹éƒ½æ˜¯è¿™ä¸ªç»“æ„ä½“çš„ä¸€ä¸ªå®ä¾‹ã€‚åœ¨æŒ‚è½½å’Œå¸è½½æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼ŒRtems ä¼šå¯¹è¿™ä¸ªç»“æ„ä½“è¿›è¡Œç›¸åº”çš„åˆå§‹åŒ–ã€æ“ä½œæˆ–é‡Šæ”¾ã€‚æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ã€æŸ¥æ‰¾è·¯å¾„ã€è®¿é—®æƒé™ã€å¸è½½ç­‰éƒ½ä¾èµ–äºè¿™ä¸ªç»“æ„ä½“ä¸­è®°å½•çš„ä¿¡æ¯ã€‚</p><p>å…³äº struct rtems_filesystem_mount_table_entry_tt å’Œ struct _rtems_filesystem_operations_tableï¼Œå‰é¢åœ¨ struct rtems_libio_t çš„æ—¶å€™æåˆ°è¿‡ï¼Œä¸å†èµ˜è¿°ã€‚</p><h3 id="rtems_fsmount"><a href="#rtems_fsmount" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#rtems_fsmount"></a> rtems_fsmount()</h3><p>rtems_fsmount() å‡½æ•°çš„ä½œç”¨æ˜¯æ‰¹é‡æŒ‚è½½å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒæŒ‰ç…§ç”¨æˆ·æä¾›çš„æŒ‚è½½è¡¨ï¼ˆfstabï¼‰é¡ºåºï¼Œä¾æ¬¡åˆ›å»ºæ¯ä¸ªæŒ‚è½½ç‚¹ç›®å½•å¹¶è°ƒç”¨ mount() æ‰§è¡ŒæŒ‚è½½æ“ä½œã€‚è¯¥å‡½æ•°æ”¯æŒé”™è¯¯æŠ¥å‘Šå’Œå¤±è´¥æ§åˆ¶æœºåˆ¶ï¼Œå…è®¸ç”¨æˆ·æ ¹æ®æŒ‚è½½ç»“æœå†³å®šæ˜¯å¦ç»§ç»­å¤„ç†åç»­é¡¹ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œrtems_fsmount æä¾›äº†ä¸€ç§ç»Ÿä¸€ã€é«˜æ•ˆçš„æ¥å£ï¼Œé€‚ç”¨äºç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨æŒ‚è½½å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œç®€åŒ–äº†æŒ‚è½½æµç¨‹å¹¶å¢å¼ºäº†å¯é…ç½®æ€§ã€‚</p><p>rtems_fsmount() çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <pre class="mermaid">flowchart TD
    A[å¼€å§‹, åˆå§‹åŒ– rc, fstab_idx, terminate] --> B[æ£€æŸ¥å¾ªç¯æ¡ä»¶ fstab_idx å°äº fstab_count, ä¸” terminate ä¸º false]
    B -->|æ˜¯| C[åˆ›å»ºæŒ‚è½½ç‚¹, è°ƒç”¨ rtems_mkdir]
    C --> D{åˆ›å»ºæˆåŠŸ}
    D -- å¦ --> E[æ ¹æ®é…ç½®æŠ¥å‘Šé”™è¯¯, æ›´æ–° terminate å’Œ rc]
    D -- æ˜¯ --> F[æ‰§è¡ŒæŒ‚è½½, è°ƒç”¨ mount]
    F --> G{æŒ‚è½½æˆåŠŸ}
    G -- å¦ --> H[æ ¹æ®é…ç½®æŠ¥å‘ŠæŒ‚è½½å¤±è´¥, æ›´æ–° terminate å’Œ rc]
    G -- æ˜¯ --> I[æ ¹æ®é…ç½®æŠ¥å‘ŠæŒ‚è½½æˆåŠŸ, æ›´æ–° terminate]
    E & H & I --> J{terminate}
    J -- å¦ --> K[fstab_ptr å‰ç§», fstab_idx åŠ ä¸€, ç„¶åè¿”å› B]
    J -- æ˜¯ --> L[é€€å‡ºå¾ªç¯]
    B -->|å¦| L
    L --> M{fail_idx æ˜¯å¦å­˜åœ¨}
    M -- æ˜¯ --> N[å†™å…¥å¤±è´¥ç´¢å¼•]
    M -- å¦ --> O
    N --> P[è¿”å› rc]
    O --> P</pre> <h4 id="struct-rtems_fstab_entry"><a href="#struct-rtems_fstab_entry" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-rtems_fstab_entry"></a> struct rtems_fstab_entry</h4><p>struct rtems_fstab_entry ç”¨äºæè¿°å•ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬æŒ‚è½½æºè®¾å¤‡æˆ–è·¯å¾„ã€æŒ‚è½½ç‚¹ç›®å½•ã€æ–‡ä»¶ç³»ç»Ÿç±»å‹ä»¥åŠæŒ‚è½½æ—¶çš„é€‰é¡¹å’Œè¡Œä¸ºæ§åˆ¶æ ‡å¿—ã€‚å®ƒä¸ºç³»ç»Ÿæ‰¹é‡æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿæ—¶æä¾›äº†ç»Ÿä¸€çš„æ•°æ®æ ¼å¼ï¼Œä½¿æŒ‚è½½æ“ä½œå¯ä»¥æ ¹æ®è¯¥ç»“æ„ä½“ä¸­çš„ä¿¡æ¯ä¾æ¬¡æ‰§è¡Œï¼Œæ”¯æŒå¯¹æŒ‚è½½è¿‡ç¨‹ä¸­çš„é”™è¯¯æŠ¥å‘Šå’Œä¸­æ­¢æ¡ä»¶è¿›è¡Œçµæ´»ç®¡ç†ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–‡ä»¶ç³»ç»ŸæŒ‚è½½è¡¨æ¡ç›®ç»“æ„ä½“ã€‚</span></span><br><span class="line"><span class="comment">// ç”¨äºæè¿°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ä¿¡æ¯ï¼ŒåŒ…æ‹¬æŒ‚è½½æºã€æŒ‚è½½ç‚¹ã€æ–‡ä»¶ç³»ç»Ÿç±»å‹åŠæŒ‚è½½é€‰é¡¹ã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// æŒ‚è½½æºï¼Œè¡¨ç¤ºè¦æŒ‚è½½çš„è®¾å¤‡ã€åˆ†åŒºæˆ–è·¯å¾„ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *source;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‚è½½ç›®æ ‡ï¼Œå³æŒ‚è½½ç‚¹è·¯å¾„ï¼Œæ–‡ä»¶ç³»ç»Ÿå°†æŒ‚è½½åˆ°è¯¥ç›®å½•ä¸‹ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *target;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç³»ç»Ÿç±»å‹åç§°ï¼Œå¦‚ &quot;imfs&quot;ã€&quot;dosfs&quot; ç­‰ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç³»ç»ŸæŒ‚è½½é€‰é¡¹ï¼ŒåŒ…å«æŒ‚è½½æ—¶çš„å‚æ•°é…ç½®ã€‚</span></span><br><span class="line">    <span class="comment">// // æ–‡ä»¶ç³»ç»ŸæŒ‚è½½é€‰é¡¹æšä¸¾ç±»å‹ï¼Œå®šä¹‰äº†æ–‡ä»¶ç³»ç»ŸæŒ‚è½½æ—¶æ”¯æŒçš„ä¸åŒè®¿é—®æƒé™æ¨¡å¼ã€‚</span></span><br><span class="line">    <span class="comment">// typedef enum</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     // åªè¯»æ¨¡å¼ï¼Œæ–‡ä»¶ç³»ç»Ÿä»¥åªè¯»æ–¹å¼æŒ‚è½½ã€‚</span></span><br><span class="line">    <span class="comment">//     RTEMS_FILESYSTEM_READ_ONLY,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//     // è¯»å†™æ¨¡å¼ï¼Œæ–‡ä»¶ç³»ç»Ÿä»¥è¯»å†™æ–¹å¼æŒ‚è½½ã€‚</span></span><br><span class="line">    <span class="comment">//     RTEMS_FILESYSTEM_READ_WRITE,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//     // æ— æ•ˆæˆ–é”™è¯¯çš„æŒ‚è½½é€‰é¡¹ã€‚</span></span><br><span class="line">    <span class="comment">//     RTEMS_FILESYSTEM_BAD_OPTIONS</span></span><br><span class="line">    <span class="comment">// &#125; rtems_filesystem_options_t;</span></span><br><span class="line">    <span class="type">rtems_filesystem_options_t</span> options;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŠ¥å‘Šæ¡ä»¶æ ‡å¿—ï¼Œç”¨äºæŒ‡å®šå“ªäº›æƒ…å†µéœ€è¦æŠ¥å‘Šé”™è¯¯æˆ–ä¿¡æ¯ã€‚</span></span><br><span class="line">    <span class="type">uint16_t</span> report_reasons;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»ˆæ­¢æ¡ä»¶æ ‡å¿—ï¼Œç”¨äºæŒ‡å®šå“ªäº›æƒ…å†µä¼šå¯¼è‡´æŒ‚è½½æµç¨‹ç»ˆæ­¢ã€‚</span></span><br><span class="line">    <span class="type">uint16_t</span> abort_reasons;</span><br><span class="line">&#125; rtems_fstab_entry;</span><br></pre></td></tr></table></div></figure><h4 id="mount"><a href="#mount" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mount"></a> mount()</h4><p>mount() å‡½æ•°ç”¨äºæ ¹æ®æŒ‡å®šçš„æºè·¯å¾„ã€ç›®æ ‡æŒ‚è½½ç‚¹ã€æ–‡ä»¶ç³»ç»Ÿç±»å‹å’ŒæŒ‚è½½é€‰é¡¹ï¼Œå®Œæˆæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½æ“ä½œã€‚å®ƒé¦–å…ˆæ ¹æ®æ–‡ä»¶ç³»ç»Ÿç±»å‹è·å–å¯¹åº”çš„æŒ‚è½½å¤„ç†å‡½æ•°ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæŒ‚è½½è¡¨é¡¹æ¥ä¿å­˜æŒ‚è½½ä¿¡æ¯ï¼Œè°ƒç”¨å…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½å‡½æ•°è¿›è¡ŒæŒ‚è½½ï¼Œå¹¶å°†æŒ‚è½½ç‚¹æ³¨å†Œåˆ°ç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ä¸­ã€‚å¦‚æœæŒ‚è½½æˆ–æ³¨å†Œå¤±è´¥ï¼Œä¼šè¿›è¡Œç›¸åº”çš„èµ„æºé‡Šæ”¾å’Œé”™è¯¯å¤„ç†ã€‚å‡½æ•°æœ€ç»ˆè¿”å›æŒ‚è½½ç»“æœï¼ŒæˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å› -1 å¹¶è®¾ç½®ç›¸åº”çš„é”™è¯¯ç ã€‚</p><p>mount() å‡½æ•°çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <pre class="mermaid">flowchart TD
    A[å¼€å§‹, è°ƒç”¨ mount] --> B[éªŒè¯ options æ˜¯å¦ä¸ºåªè¯» æˆ– è¯»å†™]
    B -->|æ— æ•ˆ| C[è®¾ç½® errno ä¸º EINVAL, è¿”å› -1]
    B -->|æœ‰æ•ˆ| D[è°ƒç”¨ rtems_filesystem_get_mount_handler, è·å–æŒ‚è½½å‡½æ•°]
    D -->|æ—  å‡½æ•°| E[è®¾ç½® errno ä¸º EINVAL, è¿”å› -1]
    D -->|æœ‰ å‡½æ•°| F[è°ƒç”¨ alloc_mount_table_entry, åˆ†é…æŒ‚è½½è¡¨é¡¹]
    F -->|åˆ†é… å¤±è´¥| G[è®¾ç½® errno ä¸º ENOMEM, è¿”å› -1]
    F -->|åˆ†é… æˆåŠŸ| H[æ ¹æ® options è®¾ç½® writeable æ ‡å¿—]
    H --> I[è°ƒç”¨æŒ‚è½½å‡½æ•°, æ‰§è¡ŒæŒ‚è½½]
    I -->|æŒ‚è½½ å¤±è´¥| J[é‡Šæ”¾æŒ‚è½½è¡¨é¡¹, è¿”å› -1]
    I -->|æŒ‚è½½ æˆåŠŸ| K[æ³¨å†Œ æ–‡ä»¶ç³»ç»Ÿ]
    K -->|æ³¨å†Œ æˆåŠŸ| L[è¿”å› 0]
    K -->|æ³¨å†Œ å¤±è´¥| M[è°ƒç”¨ fsunmount, å¸è½½, é‡Šæ”¾æŒ‚è½½è¡¨é¡¹, è¿”å› -1]</pre> <h2 id="imfs-æ–‡ä»¶ç³»ç»Ÿ"><a href="#imfs-æ–‡ä»¶ç³»ç»Ÿ" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#imfs-æ–‡ä»¶ç³»ç»Ÿ"></a> IMFS æ–‡ä»¶ç³»ç»Ÿ</h2><p>IMFSï¼ˆInâ€Memory File Systemï¼‰æ˜¯ Rtems æä¾›çš„ä¸€ä¸ªå†…å­˜æ–‡ä»¶ç³»ç»Ÿã€‚å®ƒå°†æ–‡ä»¶å’Œç›®å½•å…¨éƒ¨å­˜å‚¨åœ¨ RAM ä¸­ï¼Œä¸ºåµŒå…¥å¼åº”ç”¨æä¾›å¿«é€Ÿã€è½»é‡çº§çš„ POSIX é£æ ¼æ–‡ä»¶æ“ä½œæ¥å£ï¼›å…¶æ ¸å¿ƒæ¨¡å—è´Ÿè´£ç®¡ç†ç›®å½•æ ‘ç»“æ„ã€è·¯å¾„è§£æå’Œæ–‡ä»¶è¯»å†™é€»è¾‘ï¼Œè€Œåº•å±‚çš„èŠ‚ç‚¹åˆ†é…ä¸é”€æ¯ã€å…ƒæ•°æ®åˆå§‹åŒ–ç­‰åˆ™é€šè¿‡å›è°ƒå‡½æ•°ï¼ˆå¦‚ node_initializeã€node_removeã€node_destroyï¼‰ç”±ç³»ç»Ÿé»˜è®¤å®ç°æˆ–ç”¨æˆ·è‡ªå®šä¹‰å®ç°æ¥å®Œæˆï¼Œä½¿å¾— IMFS åœ¨ä¸ä¿®æ”¹ä¸»ä½“æ¡†æ¶çš„æƒ…å†µä¸‹èƒ½å¤Ÿçµæ´»é€‚é…ä¸åŒå†…å­˜å¸ƒå±€æˆ–ç‰¹æ®Šéœ€æ±‚ï¼Œå¯åŠ¨æ—¶é€šè¿‡ IMFS_initialize è‡ªåŠ¨æ³¨å†Œå¹¶æŒ‚è½½ä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨æˆ·å³å¯ç›´æ¥ä½¿ç”¨æ ‡å‡†çš„ open/read/write/close ç­‰æ¥å£è®¿é—®å†…å­˜ä¸­å­˜å‚¨çš„æ–‡ä»¶ã€‚</p><h3 id="rtems_filesystem_get_mount_handler"><a href="#rtems_filesystem_get_mount_handler" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#rtems_filesystem_get_mount_handler"></a> rtems_filesystem_get_mount_handler()</h3><p>åœ¨ rtems_filesystem_register() ä¸­ï¼Œæœ‰ä¸€æ­¥æ˜¯è°ƒç”¨ rtems_filesystem_get_mount_handler å‡½æ•°åˆ¤æ–­èŠ‚ç‚¹ç±»å‹æ˜¯å¦æ³¨å†Œã€‚è¿™ä¸ä»…è®©æˆ‘ä»¬è”æƒ³åˆ°ï¼Œå¯èƒ½ Rtems å†…éƒ¨ç»´æŠ¤äº†ä¸€å¼ å…¨å±€è¡¨ï¼Œä¸“é—¨ç”¨äºè®°å½•ç›®å‰å·²æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ã€‚</p><p>rtems_filesystem_get_mount_handler() çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ã€‚</p> <pre class="mermaid">flowchart TD
    A[å¼€å§‹ rtems_filesystem_get_mount_handler] --> B{type ä¸ºç©º?}
    B -- æ˜¯ --> C[è¿”å› NULL]
    B -- å¦ --> D[éå†è¡¨ rtems_filesystem_table]
    D --> E{è¡¨é¡¹åŒ¹é…?}
    E -- æ˜¯ --> F[è¿”å›å¯¹åº” mount_h]
    E -- å¦ --> G[éå†è¡¨ filesystem_chain]
    G --> H{è¡¨é¡¹åŒ¹é…?}
    H -- æ˜¯ --> I[è¿”å›å¯¹åº” mount_h]
    H -- å¦ --> J[è¿”å› NULL]</pre> <p>åœ¨ rtems_filesystem_iterate å‡½æ•°ä¸­ï¼Œå¯ä»¥å‘ç° Rtems å®šä¹‰äº†å…¨å±€çš„ä¸¤ä¸ªè¡¨ filesystem_chain å’Œ rtems_filesystem_tableã€‚æºç ä¸­æ— æ³•ç›´æ¥è·³è½¬ filesystem_chainï¼Œç›®å‰æ— æ³•å¾—çŸ¥ä»–çš„å…·ä½“çŠ¶å†µã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rtems_chain_control *chain = &amp;filesystem_chain;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">rtems_filesystem_table_t</span> *table_entry = &amp;rtems_filesystem_table[<span class="number">0</span>];</span><br></pre></td></tr></table></div></figure><h4 id="variable-rtems_filesystem_table"><a href="#variable-rtems_filesystem_table" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#variable-rtems_filesystem_table"></a> variable rtems_filesystem_table</h4><p>å…³äº rtems_filesystem_tableï¼Œå®ƒç”¨äºè¡¨ç¤ºæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ï¼Œå¹¶ä¸”çŒœæµ‹å¤§æ¦‚ç‡æ˜¯é¢„æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ã€‚ç»“æ„ä½“ rtems_filesystem_table_t å‰é¢æåˆ°è¿‡ï¼Œä¸¤ä¸ªæˆå‘˜åˆ†åˆ«ä»£è¡¨æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹åç§° type å’Œæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½å‡½æ•°æŒ‡é’ˆ mount_hã€‚</p><p>rtems_filesystem_table çš„å®šä¹‰å¦‚ä¸‹ã€‚å…¶ä¸­å…³äº IMFS æœ‰ä¸¤ä¸ªåœ°æ–¹æåˆ°ï¼Œä¸€ä¸ªæ˜¯æ–‡ä»¶ç³»ç»Ÿåå­—å« â€œ/â€ çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸€ä¸ªæ˜¯ä¸‹é¢çš„ IMFS æ–‡ä»¶ç³»ç»Ÿã€‚ä»–ä»¬å¯¹åº”çš„æŒ‚è½½å‡½æ•°åˆ†åˆ«å« IMFS_initialize_support() å’Œ IMFS_initialize()ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">rtems_filesystem_table_t</span> rtems_filesystem_table[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;/&quot;</span>, IMFS_initialize_support&#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIGURE_FILESYSTEM_DOSFS</span></span><br><span class="line">    &#123;RTEMS_FILESYSTEM_TYPE_DOSFS, rtems_dosfs_initialize&#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIGURE_FILESYSTEM_FTPFS</span></span><br><span class="line">    &#123;RTEMS_FILESYSTEM_TYPE_FTPFS, rtems_ftpfs_initialize&#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIGURE_FILESYSTEM_IMFS</span></span><br><span class="line">    &#123;RTEMS_FILESYSTEM_TYPE_IMFS, IMFS_initialize&#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIGURE_FILESYSTEM_JFFS2</span></span><br><span class="line">    &#123;RTEMS_FILESYSTEM_TYPE_JFFS2, rtems_jffs2_initialize&#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIGURE_FILESYSTEM_NFS</span></span><br><span class="line">    &#123;RTEMS_FILESYSTEM_TYPE_NFS, rtems_nfs_initialize&#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIGURE_FILESYSTEM_RFS</span></span><br><span class="line">    &#123;RTEMS_FILESYSTEM_TYPE_RFS, rtems_rfs_rtems_initialise&#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIGURE_FILESYSTEM_TFTPFS</span></span><br><span class="line">    &#123;RTEMS_FILESYSTEM_TYPE_TFTPFS, rtems_tftpfs_initialize&#125;,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;&#125;;</span><br></pre></td></tr></table></div></figure><h3 id="imfs_initialize-å’Œ-imfs_initialize_support"><a href="#imfs_initialize-å’Œ-imfs_initialize_support" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#imfs_initialize-å’Œ-imfs_initialize_support"></a> IMFS_initialize() å’Œ IMFS_initialize_support()</h3><p>IMFS_initialize() çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <pre class="mermaid">flowchart TD
    A[å¼€å§‹ IMFS_initialize] --> B[è°ƒç”¨ calloc åˆ†é…å¹¶æ¸…é›¶ fs_info å†…å­˜]
    B --> C{fs_info æ˜¯å¦ä¸º NULL}
    C -- æ˜¯ --> D[è®¾ç½® errno ä¸º ENOMEM] --> E[è¿”å› -1, åˆå§‹åŒ–å¤±è´¥]
    C -- å¦ --> F[æ„é€  IMFS_mount_data ç»“æ„ä½“]
    F --> G[å¡«å…¥ fs_info æŒ‡é’ˆ<br>å¡«å…¥æ–‡ä»¶ç³»ç»Ÿæ“ä½œé›† &IMFS_ops<br>å¡«å…¥é»˜è®¤èŠ‚ç‚¹åˆ›å»ºæ§åˆ¶è¡¨ &IMFS_default_mknod_controls]
    G --> H[è°ƒç”¨ IMFS_initialize_support è¿›è¡Œå®é™…åˆå§‹åŒ–å’ŒæŒ‚è½½]
    H --> I[è¿”å›åˆå§‹åŒ–ç»“æœ]</pre> <p>å…¶ä¸­å¡«å…… IMFS_mount_data ç»“æ„ä½“çš„ä»£ç æˆªå–å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹å‡º rtems_filesystem_operations_table ç»“æ„ä½“çš„å›è°ƒå‡½æ•°æ˜¯åœ¨è¿™é‡Œè¢«æ³¨å†Œè¿›å»çš„ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    IMFS_fs_info_t *fs_info;</span><br><span class="line">    <span class="type">const</span> rtems_filesystem_operations_table *ops;</span><br><span class="line">    <span class="type">const</span> IMFS_mknod_controls *mknod_controls;</span><br><span class="line">&#125; IMFS_mount_data;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ æŒ‚è½½æ‰€éœ€çš„åˆå§‹åŒ–æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬æ“ä½œé›†å’Œåˆ›å»ºèŠ‚ç‚¹æ§åˆ¶è¡¨ã€‚</span></span><br><span class="line">IMFS_mount_data mount_data = &#123;</span><br><span class="line">    .fs_info = fs_info,                            <span class="comment">// æ–‡ä»¶ç³»ç»Ÿå†…éƒ¨ä¿¡æ¯ã€‚</span></span><br><span class="line">    .ops = &amp;IMFS_ops,                              <span class="comment">// æ–‡ä»¶ç³»ç»Ÿæ“ä½œå‡½æ•°é›†åˆã€‚</span></span><br><span class="line">    .mknod_controls = &amp;IMFS_default_mknod_controls <span class="comment">// åˆ›å»ºèŠ‚ç‚¹æ§åˆ¶ä¿¡æ¯ã€‚</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><p>IMFS_initialize() æœ€åä¼šè°ƒç”¨ IMFS_initialize_support()ï¼ŒIMFS_initialize_support() çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <pre class="mermaid">flowchart TD
    A[å¼€å§‹ IMFS_initialize_support å‡½æ•°] --> B[å°† data è½¬ä¸º IMFS_mount_data æŒ‡é’ˆ]
    B --> C[æå– fs_info å’Œ mknod_controls]
    C --> D[è·å– node_control å’Œ root_node æŒ‡é’ˆ]
    D --> E[è®¾ç½®æŒ‚è½½ç‚¹ mt_entry çš„å„é¡¹å­—æ®µ, åŒ…æ‹¬ fs_info, ops, pathconf, root èŠ‚ç‚¹ä¿¡æ¯]
    E --> F[è°ƒç”¨ IMFS_initialize_node åˆå§‹åŒ–æ ¹ç›®å½•èŠ‚ç‚¹]
    F --> G[æ–­è¨€ root_node ä¸ä¸º NULL]
    G --> H[è¿”å› 0, è¡¨ç¤ºåˆå§‹åŒ–æˆåŠŸ]</pre> <p>è¿™å…¶ä¸­ä¹Ÿåšäº†å¾ˆå¤šèµ‹å€¼æ“ä½œï¼Œä»£ç ç‰‡æ®µæˆªå–å¦‚ä¸‹ã€‚å…¶ä¸­ _rtems_filesystem_file_handlers_r ç»“æ„ä½“çš„å›è°ƒå‡½æ•°æ˜¯åœ¨è¿™é‡Œæ³¨å†Œè¿›å»çš„ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è½¬æ¢ä¼ å…¥çš„ data å‚æ•°ä¸ºå…·ä½“ç±»å‹ã€‚</span></span><br><span class="line">mount_data = data;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æå–æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯å’Œ mknod æ§åˆ¶å™¨ã€‚</span></span><br><span class="line">fs_info = mount_data-&gt;fs_info;</span><br><span class="line">fs_info-&gt;mknod_controls = mount_data-&gt;mknod_controls;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ ¹ç›®å½•æ‰€ç”¨çš„èŠ‚ç‚¹æ§åˆ¶å™¨ã€‚</span></span><br><span class="line">node_control = &amp;mount_data-&gt;mknod_controls-&gt;directory-&gt;node_control;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æ ¹èŠ‚ç‚¹ç»“æ„ä½“çš„åœ°å€ã€‚</span></span><br><span class="line">root_node = &amp;fs_info-&gt;Root_directory.Node;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æŒ‚è½½ç‚¹ç»“æ„ mt_entry çš„åŸºæœ¬ä¿¡æ¯ã€‚</span></span><br><span class="line">mt_entry-&gt;fs_info = fs_info;                                      <span class="comment">// æ–‡ä»¶ç³»ç»Ÿç§æœ‰æ•°æ®ã€‚</span></span><br><span class="line">mt_entry-&gt;ops = mount_data-&gt;ops;                                  <span class="comment">// æ–‡ä»¶ç³»ç»Ÿæ“ä½œé›†ã€‚</span></span><br><span class="line">mt_entry-&gt;pathconf_limits_and_options = &amp;IMFS_LIMITS_AND_OPTIONS; <span class="comment">// è·¯å¾„ç›¸å…³é™åˆ¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æŒ‚è½½æ ¹ç›®å½•çš„èŠ‚ç‚¹è®¿é—®å’Œæ“ä½œå¤„ç†å‡½æ•°ã€‚</span></span><br><span class="line">mt_entry-&gt;mt_fs_root-&gt;location.node_access = root_node;</span><br><span class="line">mt_entry-&gt;mt_fs_root-&gt;location.handlers = node_control-&gt;handlers;</span><br></pre></td></tr></table></div></figure><h4 id="imfs_initialize_node"><a href="#imfs_initialize_node" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#imfs_initialize_node"></a> IMFS_initialize_node()</h4><p>IMFS_initialize_support() æœ€åä¼šè°ƒç”¨ IMFS_initialize_node() å‡½æ•°ã€‚è¯¥å‡½æ•°ç”¨äºåˆå§‹åŒ–ä¸€ä¸ª IMFS èŠ‚ç‚¹ï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç›®å½•æˆ–æ–‡ä»¶èŠ‚ç‚¹ï¼‰ã€‚æ ¹æ®ä¼ å…¥çš„ä¿¡æ¯å¡«å……èŠ‚ç‚¹ç»“æ„ä½“çš„åŸºæœ¬å­—æ®µï¼Œå¹¶è°ƒç”¨èŠ‚ç‚¹ç±»å‹æ§åˆ¶å™¨æä¾›çš„åˆå§‹åŒ–å›è°ƒã€‚æˆåŠŸè¿”å›å·²åˆå§‹åŒ–çš„èŠ‚ç‚¹æŒ‡é’ˆï¼Œå¤±è´¥è¿”å› NULL å¹¶è®¾ç½® errnoã€‚</p><p>IMFS_initialize_node() çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <pre class="mermaid">flowchart TD
    A[å¼€å§‹ IMFS_initialize_node å‡½æ•°] --> B{namelen æ˜¯å¦è¶…è¿‡ IMFS_NAME_MAX}
    B -- æ˜¯ --> C[è®¾ç½® errno ä¸º ENAMETOOLONG<br>è¿”å› NULL]
    B -- å¦ --> D[å¡«å……èŠ‚ç‚¹åŸºæœ¬å­—æ®µ name, namelen, reference_count, st_nlink, control]
    D --> E[è®¾ç½®æƒé™å’Œå±ä¸»ä¿¡æ¯ mode, uid, gid]
    E --> F[è·å–å½“å‰æ—¶é—´ now]
    F --> G[è®¾ç½®æ—¶é—´æˆ³ atime, mtime, ctime]
    G --> H[è°ƒç”¨ node_control çš„ node_initialize å›è°ƒ]
    H --> I[è¿”å›åˆå§‹åŒ–åçš„èŠ‚ç‚¹æŒ‡é’ˆ]</pre> <p>è¯¥å‡½æ•°åœ¨è®¾ç½®äº†èŠ‚ç‚¹ node çš„ä¿¡æ¯ä»¥åï¼Œä¼šè°ƒç”¨ node_control ç»“æ„ä½“çš„ node_initialize å›è°ƒå‡½æ•°è¿›è¡Œ node åˆå§‹åŒ–ã€‚ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨èŠ‚ç‚¹æ§åˆ¶å™¨ä¸­å®šä¹‰çš„åˆå§‹åŒ–å‡½æ•°ä»¥æ‰§è¡Œå…·ä½“ç±»å‹çš„åˆå§‹åŒ–ã€‚</span></span><br><span class="line"><span class="keyword">return</span> (*node_control-&gt;node_initialize)(node, arg);</span><br></pre></td></tr></table></div></figure><h3 id="struct-imfs_jnode_tt"><a href="#struct-imfs_jnode_tt" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-imfs_jnode_tt"></a> struct IMFS_jnode_tt</h3><p>IMFS_jnode_tt æ˜¯ IMFS è‡ªå·±è®¾è®¡çš„ inode ç»“æ„ï¼Œä½œç”¨å’Œ Linux ä¸­æ–‡ä»¶ç³»ç»Ÿè‡ªå·±çš„ inode ç»“æ„æ•ˆæœç›¸åŒï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IMFS_jnode_tt æ˜¯ IMFS æ–‡ä»¶ç³»ç»Ÿä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•çš„èŠ‚ç‚¹ç»“æ„ä½“ã€‚è¿™æ˜¯å†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼ˆIMFSï¼‰ä¸­æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„ä¹‹ä¸€ï¼ŒåŒ…å«åç§°ã€æƒé™ã€æ‰€æœ‰è€…ã€æ—¶é—´æˆ³ç­‰å…ƒæ•°æ®ï¼Œä»¥åŠæŒ‡å‘çˆ¶èŠ‚ç‚¹å’Œæ§åˆ¶æ“ä½œçš„æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IMFS_jnode_tt</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// ç”¨äºå°†è¯¥èŠ‚ç‚¹é“¾æ¥å…¥é“¾è¡¨ä¸­ã€‚</span></span><br><span class="line">    rtems_chain_node Node;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡å‘çˆ¶èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚</span></span><br><span class="line">    IMFS_jnode_t *Parent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹åç§°ï¼Œä¸ä»¥ \0 ç»“å°¾ï¼ˆå³ä¸æ˜¯ C å­—ç¬¦ä¸²ï¼‰ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹åç§°çš„é•¿åº¦ï¼ˆå¯¹åº”ä¸Šé¢çš„ nameï¼‰ã€‚</span></span><br><span class="line">    <span class="type">uint16_t</span> namelen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡ä»¶ç±»å‹å’Œæƒé™ä¿¡æ¯ï¼ˆå¦‚ç›®å½•ã€å¸¸è§„æ–‡ä»¶ã€æƒé™ä½ï¼‰ã€‚</span></span><br><span class="line">    <span class="type">mode_t</span> st_mode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹çš„å¼•ç”¨è®¡æ•°ï¼Œç”¨äºèµ„æºç®¡ç†ã€‚</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> reference_count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¡¬é“¾æ¥æ•°é‡ï¼ˆé“¾æ¥è®¡æ•°ï¼‰ã€‚</span></span><br><span class="line">    <span class="type">nlink_t</span> st_nlink;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹¥æœ‰è€…çš„ç”¨æˆ· IDã€‚</span></span><br><span class="line">    <span class="type">uid_t</span> st_uid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹¥æœ‰è€…çš„ç»„ IDã€‚</span></span><br><span class="line">    <span class="type">gid_t</span> st_gid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åä¸€æ¬¡è®¿é—®æ—¶é—´ã€‚</span></span><br><span class="line">    <span class="type">time_t</span> stat_atime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åä¸€æ¬¡ä¿®æ”¹å†…å®¹çš„æ—¶é—´ã€‚</span></span><br><span class="line">    <span class="type">time_t</span> stat_mtime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åä¸€æ¬¡å±æ€§æ›´æ”¹ï¼ˆå¦‚æƒé™ã€æ‰€æœ‰è€…ç­‰ï¼‰çš„æ—¶é—´ã€‚</span></span><br><span class="line">    <span class="type">time_t</span> stat_ctime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹æ§åˆ¶å™¨ï¼Œå®šä¹‰èŠ‚ç‚¹çš„è¡Œä¸ºå’Œæ“ä½œå‡½æ•°ã€‚</span></span><br><span class="line">    <span class="type">const</span> IMFS_node_control *control;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><h4 id="struct-imfs_node_control"><a href="#struct-imfs_node_control" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-imfs_node_control"></a> struct IMFS_node_control</h4><p>struct IMFS_jnode_tt ä¸­é™¤äº† inode çš„åŸºæœ¬ä¿¡æ¯ä»¥å¤–ï¼Œéœ€è¦å…³æ³¨çš„ä¸€ç‚¹å°±æ˜¯ struct IMFS_node_controlã€‚è¯¥ç»“æ„ä½“å®šä¹‰äº† IMFS inode èŠ‚ç‚¹çš„æ“ä½œå‡½æ•°ï¼Œå¹¶ä½œç»Ÿä¸€æ§åˆ¶ç®¡ç†ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief IMFS node control.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// IMFS_node_controlï¼šå®šä¹‰ IMFS èŠ‚ç‚¹ç±»å‹çš„æ“ä½œæ§åˆ¶å™¨ã€‚</span></span><br><span class="line"><span class="comment">// æ¯ç§èŠ‚ç‚¹ç±»å‹ï¼ˆå¦‚æ™®é€šæ–‡ä»¶ã€ç›®å½•ã€ç¬¦å·é“¾æ¥ç­‰ï¼‰å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„ handlers å’Œåˆå§‹åŒ–ã€é”€æ¯ç­‰å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="comment">// è¯¥ç»“æ„ä½“å…è®¸ IMFS åœ¨æ“ä½œä¸åŒç±»å‹èŠ‚ç‚¹æ—¶é€šè¿‡å›è°ƒæœºåˆ¶å®ç°å¤šæ€è¡Œä¸ºã€‚</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// æ–‡ä»¶æ“ä½œå¤„ç†å™¨é›†åˆï¼ŒåŒ…å« openã€readã€writeã€ioctl ç­‰å‡½æ•°æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="comment">// æ¯ç§èŠ‚ç‚¹ç±»å‹å¯ä»¥å®šä¹‰ä¸åŒçš„ handlersã€‚</span></span><br><span class="line">    <span class="type">const</span> rtems_filesystem_file_handlers_r *handlers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨åˆ›å»ºè¯¥ç±»å‹èŠ‚ç‚¹æ—¶è°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="comment">// é€šå¸¸åœ¨ IMFS_initialize_node ä¸­è°ƒç”¨ï¼Œç”¨äºæ‰§è¡Œç±»å‹ç‰¹å®šçš„åˆå§‹åŒ–é€»è¾‘ã€‚</span></span><br><span class="line">    IMFS_node_control_initialize node_initialize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹åˆ é™¤å‡½æ•°ï¼Œåœ¨æ‰§è¡Œ unlink/remove æ“ä½œæ—¶è°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="comment">// ç”¨äºå¤„ç†èŠ‚ç‚¹ç±»å‹ç‰¹å®šçš„æ¸…ç†é€»è¾‘ï¼Œå¦‚ä»çˆ¶ç»“æ„ä¸­ç§»é™¤ç­‰ã€‚</span></span><br><span class="line">    IMFS_node_control_remove node_remove;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹é”€æ¯å‡½æ•°ï¼Œåœ¨é‡Šæ”¾èŠ‚ç‚¹å†…å­˜æˆ–å¼•ç”¨è®¡æ•°å½’é›¶æ—¶è°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="comment">// é€šå¸¸ç”¨äºé‡Šæ”¾èŠ‚ç‚¹ä¸­ç§æœ‰æ•°æ®æˆ–æ‰§è¡Œèµ„æºå›æ”¶ã€‚</span></span><br><span class="line">    IMFS_node_control_destroy node_destroy;</span><br><span class="line">&#125; IMFS_node_control;</span><br></pre></td></tr></table></div></figure><p>å‰é¢æåˆ°ï¼Œ_rtems_filesystem_file_handlers_r ç»“æ„ä½“çš„å›è°ƒå‡½æ•°æ˜¯åœ¨ IMFS_initialize_support() ä¸­æ³¨å†Œçš„ï¼Œæœ€ç»ˆå°±æ¥æºäº IMFS_node_control ä¸­çš„ rtems_filesystem_file_handlers_r *handlersã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mt_entry-&gt;mt_fs_root-&gt;location.handlers = node_control-&gt;handlers;</span><br></pre></td></tr></table></div></figure><p>ä¸‹ä¸€æ­¥å°±æ˜¯æ‰¾åˆ°è¿™äº›å‡½æ•°æœ€å¼€å§‹æ˜¯åœ¨å“ªé‡Œè¢«æ³¨å†Œçš„ã€‚æœ€ç»ˆåœ¨ cpukit/libfs/src/imfs/imfs_linfile.c ä¸­æ‰¾åˆ°äº†ç­”æ¡ˆï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> rtems_filesystem_file_handlers_r IMFS_linfile_handlers = &#123;</span><br><span class="line">    .open_h = IMFS_linfile_open,</span><br><span class="line">    .close_h = rtems_filesystem_default_close,</span><br><span class="line">    .read_h = IMFS_linfile_read,</span><br><span class="line">    .write_h = rtems_filesystem_default_write,</span><br><span class="line">    .ioctl_h = rtems_filesystem_default_ioctl,</span><br><span class="line">    .lseek_h = rtems_filesystem_default_lseek_file,</span><br><span class="line">    .fstat_h = IMFS_stat_file,</span><br><span class="line">    .ftruncate_h = rtems_filesystem_default_ftruncate,</span><br><span class="line">    .fsync_h = rtems_filesystem_default_fsync_or_fdatasync_success,</span><br><span class="line">    .fdatasync_h = rtems_filesystem_default_fsync_or_fdatasync_success,</span><br><span class="line">    .fcntl_h = rtems_filesystem_default_fcntl,</span><br><span class="line">    .kqfilter_h = rtems_filesystem_default_kqfilter,</span><br><span class="line">    .mmap_h = rtems_filesystem_default_mmap,</span><br><span class="line">    .poll_h = rtems_filesystem_default_poll,</span><br><span class="line">    .readv_h = rtems_filesystem_default_readv,</span><br><span class="line">    .writev_h = rtems_filesystem_default_writev&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> IMFS_node_control IMFS_node_control_linfile = &#123;</span><br><span class="line">    .handlers = &amp;IMFS_linfile_handlers,</span><br><span class="line">    .node_initialize = IMFS_node_initialize_linfile,</span><br><span class="line">    .node_remove = IMFS_node_remove_default,</span><br><span class="line">    .node_destroy = IMFS_node_destroy_default&#125;;</span><br></pre></td></tr></table></div></figure><h1 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡æ¡£"></a> å‚è€ƒæ–‡æ¡£</h1><ol><li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://docs.rtems.org/docs/6.1/filesystem/index.html">RTEMS Filesystem Design Guide (6.1). â€” RTEMS Filesystem Design Guide 6.1 (22nd January 2025) documentation</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li><li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://geekdaxue.co/read/linggs@qnf7q6/pnhxbw">rtemsæ–‡ä»¶ç³»ç»Ÿéƒ¨åˆ† - ã€Šext4æ–‡ä»¶ç³»ç»Ÿç§»æ¤ã€‹ - æå®¢æ–‡æ¡£</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li></ol></div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ æœ¬æ–‡ç»“æŸï¼Œæ„Ÿè°¢æ‚¨çš„é˜…è¯» ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">æœ¬æ–‡ä½œè€…: </span><span class="copyright-author__value"><a href="https://blog.davidingplus.cn">DavidingPlus</a></span></div><div class="copyright-link"><span class="copyright-link__name">æœ¬æ–‡é“¾æ¥: </span><span class="copyright-link__value"><a href="https://blog.davidingplus.cn/posts/4936fe45.html">https://blog.davidingplus.cn/posts/4936fe45.html</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">ç‰ˆæƒå£°æ˜: </span><span class="copyright-notice__value">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</span></div></div><div class="post-reward reward"><div class="reward-button">å¤§çˆ·ï¼Œèµä¸ªé“œæ¿å‘—~~~</div><div class="reward-qrcode"><span class="reward-qrcode-alipay"><img class="reward-qrcode-alipay__img" src="/images/reward/alipay.webp"><div class="reward-qrcode-alipay__text">æ”¯ä»˜å®</div></span><span class="reward-qrcode-wechat"><img class="reward-qrcode-wechat__img" src="/images/reward/wechat-pay.webp"><div class="reward-qrcode-wechat__text">å¾®ä¿¡</div></span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/posts/1b712153.html"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">è®¡ç®—æœºé«˜çº§å›¾å½¢å­¦ æœŸæœ«å¤ä¹ </span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/posts/69869e7f.html"><span class="paginator-prev__text">Block Device Drivers</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="utterances-container"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">æ–‡ç« ç›®å½•</span><span class="sidebar-nav-ov">ç«™ç‚¹æ¦‚è§ˆ</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#rtems-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"><span class="toc-number">1.</span> <span class="toc-text">Rtems æºç é˜…è¯»</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.</span> <span class="toc-text">æ–‡ä»¶ç³»ç»Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">2.1.</span> <span class="toc-text">ç³»ç»Ÿè°ƒç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#open"><span class="toc-number">2.1.1.</span> <span class="toc-text">open()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#struct-rtems_libio_t"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">struct rtems_libio_t</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#struct-rtems_filesystem_location_info_t"><span class="toc-number">2.1.1.1.1.</span> <span class="toc-text">struct rtems_filesystem_location_info_t</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#struct-rtems_filesystem_file_handlers_r"><span class="toc-number">2.1.1.1.2.</span> <span class="toc-text">struct rtems_filesystem_file_handlers_r</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#struct-rtems_filesystem_mount_table_entry_tt"><span class="toc-number">2.1.1.1.3.</span> <span class="toc-text">struct rtems_filesystem_mount_table_entry_tt</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rtems_libio_allocate"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">rtems_libio_allocate()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#rtems_libio_iop_free_head"><span class="toc-number">2.1.1.2.1.</span> <span class="toc-text">rtems_libio_iop_free_head</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#do_open"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">do_open()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">2.1.1.3.1.</span> <span class="toc-text">è·¯å¾„è§£æè¿‡ç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%95%E5%B1%82%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84-open-%E5%87%BD%E6%95%B0"><span class="toc-number">2.1.1.3.2.</span> <span class="toc-text">åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„ open å‡½æ•°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#close"><span class="toc-number">2.1.2.</span> <span class="toc-text">close()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#read"><span class="toc-number">2.1.3.</span> <span class="toc-text">read()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#write"><span class="toc-number">2.1.4.</span> <span class="toc-text">write()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.</span> <span class="toc-text">æ–‡ä»¶ç³»ç»Ÿå¯åŠ¨æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rtems_filesystem_initialize"><span class="toc-number">2.2.1.</span> <span class="toc-text">rtems_filesystem_initialize()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#struct-rtems_filesystem_mount_configuration"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">struct rtems_filesystem_mount_configuration</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rtems_filesystem_register"><span class="toc-number">2.2.2.</span> <span class="toc-text">rtems_filesystem_register()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#struct-filesystem_node"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">struct filesystem_node</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#struct-rtems_filesystem_table_t"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">struct rtems_filesystem_table_t</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rtems_filesystem_fsmount_me_t"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">rtems_filesystem_fsmount_me_t</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rtems_fsmount"><span class="toc-number">2.2.3.</span> <span class="toc-text">rtems_fsmount()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#struct-rtems_fstab_entry"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">struct rtems_fstab_entry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mount"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">mount()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#imfs-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.3.</span> <span class="toc-text">IMFS æ–‡ä»¶ç³»ç»Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rtems_filesystem_get_mount_handler"><span class="toc-number">2.3.1.</span> <span class="toc-text">rtems_filesystem_get_mount_handler()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#variable-rtems_filesystem_table"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">variable rtems_filesystem_table</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#imfs_initialize-%E5%92%8C-imfs_initialize_support"><span class="toc-number">2.3.2.</span> <span class="toc-text">IMFS_initialize() å’Œ IMFS_initialize_support()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#imfs_initialize_node"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">IMFS_initialize_node()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#struct-imfs_jnode_tt"><span class="toc-number">2.3.3.</span> <span class="toc-text">struct IMFS_jnode_tt</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#struct-imfs_node_control"><span class="toc-number">2.3.3.1.</span> <span class="toc-text">struct IMFS_node_control</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-number">3.</span> <span class="toc-text">å‚è€ƒæ–‡æ¡£</span></a></li></ol></section><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/assets/android-chrome-512x512.webp" alt="avatar"></div><p class="sidebar-ov-author__text">Self-discipline is key in life.</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/DavidingPlus" target="_blank" rel="noopener" data-popover="GitHub" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="/qq/" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="/wechat/" target="_blank" rel="noopener" data-popover="å¾®ä¿¡" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weixin"></i></span></a><a class="sidebar-ov-social-item" href="mailto:davidingplus@qq.com" target="_blank" rel="noopener" data-popover="davidingplus@qq.com" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fas fa-envelope"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">38</div><div class="sidebar-ov-state-item__name">å½’æ¡£</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">21</div><div class="sidebar-ov-state-item__name">åˆ†ç±»</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="çŸ¥è¯†å…±äº«è®¸å¯åè®®" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">æ‚¨å·²é˜…è¯»äº† </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright Â© 2023~2025</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>DavidingPlus</span><span class="footer__devider">|</span><span>èœ€ ICP å¤‡ 2024088070 å·</span></div><div><span>ç”± <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> å¼ºåŠ›é©±åŠ¨</span><span> v7.2.0</span><span class="footer__devider">|</span><span>ä¸»é¢˜ - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.8.6</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">è®¿é—®äººæ•°</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">æµè§ˆæ€»é‡</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div><div><span id="timeDate">è½½å…¥å¤©æ•°...</span><span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("09/18/2023 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="å°ç ´ç«™å·²ç»å®‰å…¨è¿è¡Œ "+dnum+" å¤© ",document.getElementById("times").innerHTML=hnum+" å°æ—¶ "+mnum+" åˆ† "+snum+" ç§’å•¦ï¼"}setInterval("createtime()",250)</script></div><script type="text/javascript" id="maid-script" mermaidoptioins="{&quot;theme&quot;:&quot;default&quot;}" src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/mermaid.min.js"></script><script>if(window.mermaid){var options=JSON.parse(document.getElementById("maid-script").getAttribute("mermaidoptioins"));mermaid.initialize(options)}</script></div></footer><div class="loading-animation" id="loading-animation"><div class="loading-animation__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-thumbs-up"></i></span></div><div class="back2bottom" id="back2bottom"><span class="back2bottom__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="æœç´¢æ–‡ç« ï¼ˆæ”¯æŒå¤šå…³é”®è¯ï¼Œè¯·ç”¨ç©ºæ ¼åˆ†éš”ï¼‰"><div class="search-btns">ä½¿ç”¨æœç´¢ï¼š<span class="search-btns-item search-btns-item--bing"><i></i>å¿…åº”</span><span class="search-btns-item search-btns-item--baidu"><i></i>ç™¾åº¦</span></div></div><div class="search-results"></div></div><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/jquery.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/velocity.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/velocity-ui.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/canvas-nest.js" color="255,255,255" opacity="1" count="99" zindex="-1"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/fancybox.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/masonry.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/lazyload.js"></script><script>function initSearch(){var e=!0,t="search.json";t?/json$/i.test(t)&&(e=!1):t="search.xml";var n="/"+t;$.ajax({url:n,dataType:e?"xml":"json",async:!0,success:function(t){var n=e?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,o=$(".search-input input"),i=$(".search-results"),c=100,r=1,a=function(){var e=o.val().toLowerCase().trim(),t=e.split(/[\s]+/),a=[];t.length>1&&t.push(e),e.length>0&&n.forEach(function(e){var n=!1,o=e.title&&e.title.trim()||"[ æ–‡ç« æ— æ ‡é¢˜ ]",i=o&&o.toLowerCase(),s=e.content&&e.content.replace(/<[^>]+>/g,""),l=s&&s.toLowerCase(),u=e.url&&decodeURI(e.url).replace(/\/{2,}/g,"/"),h=[],d=[];t.forEach(function(e){function t(e,t,n,o){if(!e||!t)return[];var i=0,c=-1,r=[];for(n||(e=e.toLowerCase(),t=t.toLowerCase());-1!==(c=t.indexOf(e,i));){var a=!1;h.forEach(function(t){t.index===c&&t.word.length<e.length&&(t.word=e,a=!0)}),i=c+e.length,!a&&r.push({index:c,word:e,weight:o})}return r}h=h.concat(t(e,i,!1,c)),d=d.concat(t(e,l,!1,r))});var f=h.length,p=d.length;if((f>0||p>0)&&(n=!0),n){function w(e,t,n,o){if(e&&t&&t.length){var i="",c=n,r=o;return t.forEach(function(t){if(!(t.index<c)){var n=t.index+t.word.length;i+=e.slice(c,t.index),i+="<b>"+e.slice(t.index,n)+"</b>",c=n}}),i+=e.slice(c,r)}}[h,d].forEach(function(e){e.sort(function(e,t){return e.index-t.index})});var v,g={},x=h.length*c+d.length*r,y=w(o,h,0,o.length)||o;if(d.length>0){var S=d[0].index;v=w(s,d,S>20?S-20:0,S+180)}else v=s.slice(0,200);g.title=y,g.content=v,g.url=u,g.weight=x,a.push(g)}});var s="";a.length?(a.sort(function(e,t){return t.weight-e.weight}),s+="<ul>",a.forEach(function(e){s+='<li><a class="search-results-title" href="'+e.url+'">',s+=e.title,s+='</a><div class="search-results-content">',s+=e.content,s+="</div></li>"}),s+="</ul>"):s+='<div class="search-results-none"><i class="far fa-meh"></i></div>',i.html(s)};o.on("input",a),o.on("keyup",function(e){e.keyCode===Stun.utils.codeToKeyCode("Enter")&&a()})}})}function closeSearch(){$("body").css({overflow:"auto"}),$(".search-popup").css({display:"none"}),$(".search-mask").css({display:"none"})}function safeOpenUrl(e){var t=window.open();t.opener=null,t.location=e}function extSearch(e){var t=window.location.host,n=$(".search-input input").val().toLowerCase().trim();n?safeOpenUrl({google:"https://www.google.com/search?q=",bing:"https://cn.bing.com/search?q=",baidu:"https://www.baidu.com/s?ie=UTF-8&wd="}[e]+n+" site:"+t):Stun.utils.popAlert("warning","è¯·è¾“å…¥å­—ç¬¦")}window.addEventListener("DOMContentLoaded",function(){Stun.utils.pjaxReloadLocalSearch=function(){$(".header-nav-search").on("click",function(e){e.stopPropagation(),$("body").css("overflow","hidden"),$(".search-popup").velocity("stop").velocity("transition.expandIn",{duration:300,complete:function(){$(".search-popup input").focus()}}),$(".search-mask").velocity("stop").velocity("transition.fadeIn",{duration:300}),initSearch()}),$(".search-mask, .search-close").on("click",function(){closeSearch()}),$(document).on("keydown",function(e){e.keyCode===Stun.utils.codeToKeyCode("Escape")&&closeSearch()})},Stun.utils.pjaxReloadLocalSearch()},!1);var assistSearchList=window.CONFIG.assistSearch;Array.isArray(assistSearchList)&&assistSearchList.forEach(function(e){document.querySelector(".search-btns-item--"+e).addEventListener("click",function(){extSearch(e)},!1)})</script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/pjax.js"></script><script>window.addEventListener("DOMContentLoaded",function(){new Pjax({selectors:["head title","#main",".pjax-reload",".header-banner"],history:!0,scrollTo:!1,scrollRestoration:!1,cacheBust:!1,debug:!1,currentUrlFullReload:!1,timeout:0});document.addEventListener("pjax:send",function(){$(".header-nav-menu").removeClass("show"),CONFIG.pjax&&CONFIG.pjax.avoidBanner&&$("html").velocity("scroll",{duration:500,offset:$("#header").height(),easing:"easeInOutCubic"}),$(".loading-animation").addClass("loading")},!1),window.addEventListener("pjax:complete",function(){if($(".loading-animation").removeClass("loading"),$("link[rel=prefetch], script[data-pjax-rm]").each(function(){$(this).remove()}),$("script[data-pjax], #pjax-reload script").each(function(){$(this).parent().append($(this).remove())}),Stun.utils.pjaxReloadBoot&&Stun.utils.pjaxReloadBoot(),Stun.utils.pjaxReloadScroll&&Stun.utils.pjaxReloadScroll(),Stun.utils.pjaxReloadSidebar&&Stun.utils.pjaxReloadSidebar(),"undefined"!=typeof mermaid){const e=Array.from(document.querySelectorAll(".mermaid")).filter(e=>!e.dataset.processed);mermaid.init(void 0,e)}},!1)},!1)</script><div id="pjax-reload"><link href="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/css/katex.min.css" rel="stylesheet" type="text/css"><link href="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/css/copy-tex.css" rel="stylesheet" type="text/css"><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/copy-tex.min.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/quicklink.js"></script><script>function initQuicklink(){quicklink({timeout:"10000",priority:!0,ignores:[i=>i.includes("#"),i=>"https://blog.davidingplus.cn/posts/4936fe45.html"===i,/\/api\/?/,i=>i.includes(".xml"),i=>i.includes(".zip"),(i,t)=>t.hasAttribute("nofollow"),(i,t)=>t.hasAttribute("noprefetch")]})}initQuicklink()</script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/busuanzi.js" async></script></div><script src="/js/utils.js?v=2.8.6"></script><script src="/js/stun-boot.js?v=2.8.6"></script><script src="/js/scroll.js?v=2.8.6"></script><script src="/js/header.js?v=2.8.6"></script><script src="/js/sidebar.js?v=2.8.6"></script><script type="application/json" src="/search.json"></script><script data-pjax="">function loadUtterances(){var t=document,e=t.createElement("script"),s=t.getElementById("utterances-container"),r=Stun.utils.getNightMode()?"photon-dark":"github-light";s&&(e.src="https://utteranc.es/client.js",e.setAttribute("repo","DavidingPlus/blog-comments"),e.setAttribute("issue-term","title"),e.setAttribute("label","utterances"),e.setAttribute("theme",r),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),e.setAttribute("data-pjax-rm",""),s.append(e))}loadUtterances()</script><script async src="/js/cursor/text.js"></script><script src="/js/activate-power-mode.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,document.body.addEventListener("input",POWERMODE)</script><script>var titleTime,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="ğŸ¤¡å¿«å›æ¥,ç²—å¤§äº‹äº†~~"+OriginTitile,clearTimeout(titleTime)):(document.title="ğŸ˜šæ¬¢è¿å›æ¥!~"+OriginTitile,titleTime=setTimeout(function(){document.title=OriginTitile},2e3))})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"left",width:160,height:290},mobile:{show:!0},log:!1})</script></body></html>