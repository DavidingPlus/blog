<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><script>window.MSInputMethodContext&&document.documentMode&&(window.location.href="https://support.dmeng.net/upgrade-your-browser.html")</script><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/assets/favicon-16x16.webp?v=2.8.6" type="image/png" sizes="16x16"><link rel="icon" href="/assets/favicon-32x32.webp?v=2.8.6" type="image/png" sizes="32x32"><link rel="apple-touch-icon" href="/assets/apple-touch-icon.webp?v=2.8.6" sizes="180x180"><meta name="description" content="ç¬”è®°æ‘˜æŠ„è‡ª Linux å†…æ ¸æ•™å­¦ â€” Linux ç³»ç»Ÿå†…æ ¸æ–‡æ¡£ çš„ VFS éƒ¨åˆ†ï¼Œå¹¶æ€»ç»“è®°å½•ã€‚                      è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰        è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰æ˜¯å†…æ ¸çš„ç»„ä»¶ï¼Œå¤„ç†æ‰€æœ‰ä¸æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ã€‚VFS æ˜¯ç”¨æˆ·ä¸ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿä¹‹é—´çš„é€šç”¨æ¥å£ã€‚è¿™ç§æŠ½è±¡ç®€åŒ–äº†æ–‡ä»¶ç³»ç»Ÿçš„å®ç°ï¼Œä½¿å¾—å„ç§æ–‡ä»¶ç³»ç»Ÿæ›´å®¹æ˜“é›†æˆã€‚å„ç§æ–‡ä»¶ç³»ç»Ÿé€šè¿‡ä½¿ç”¨ VFS æä¾›çš„ API"><meta property="og:type" content="article"><meta property="og:title" content="Virtual Filesystem"><meta property="og:url" content="https://blog.davidingplus.cn/posts/68b0f3fd.html"><meta property="og:site_name" content="DavidingPlus&#39;s Blog"><meta property="og:description" content="ç¬”è®°æ‘˜æŠ„è‡ª Linux å†…æ ¸æ•™å­¦ â€” Linux ç³»ç»Ÿå†…æ ¸æ–‡æ¡£ çš„ VFS éƒ¨åˆ†ï¼Œå¹¶æ€»ç»“è®°å½•ã€‚                      è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰        è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰æ˜¯å†…æ ¸çš„ç»„ä»¶ï¼Œå¤„ç†æ‰€æœ‰ä¸æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ã€‚VFS æ˜¯ç”¨æˆ·ä¸ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿä¹‹é—´çš„é€šç”¨æ¥å£ã€‚è¿™ç§æŠ½è±¡ç®€åŒ–äº†æ–‡ä»¶ç³»ç»Ÿçš„å®ç°ï¼Œä½¿å¾—å„ç§æ–‡ä»¶ç³»ç»Ÿæ›´å®¹æ˜“é›†æˆã€‚å„ç§æ–‡ä»¶ç³»ç»Ÿé€šè¿‡ä½¿ç”¨ VFS æä¾›çš„ API"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20241227142615377.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20241227143348812.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20241227120407496.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20241227141716401.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20241227145405084.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20241230094606623.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20241230101507978.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20241230102023524.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20241230104309655.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20241230103801350.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20241230102953331.png"><meta property="article:published_time" content="2024-12-24T16:05:00.000Z"><meta property="article:modified_time" content="2024-12-31T16:00:00.000Z"><meta property="article:author" content="DavidingPlus"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20241227142615377.png"><title>Virtual Filesystem | DavidingPlus's Blog</title><link ref="canonical" href="https://blog.davidingplus.cn/posts/68b0f3fd.html"><link rel="dns-prefetch" href="https://cdn.davidingplus.cn"><link rel="stylesheet" href="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/css/fontawesome.css" type="text/css"><link rel="stylesheet" href="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/css/fancybox.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.8.6"><script>var Stun=window.Stun||{},CONFIG={root:"/",algolia:void 0,assistSearch:["bing","baidu"],fontIcon:{prompt:{success:"fas fa-check-circle",info:"fas fa-arrow-circle-right",warning:"fas fa-exclamation-circle",error:"fas fa-times-circle"},copyBtn:"fas fa-copy"},sidebar:{offsetTop:"55px",tocMaxDepth:6},header:{enable:!0,showOnPost:!0,scrollDownIcon:!0},postWidget:{endText:!0},nightMode:{enable:!0},back2top:{enable:!0},back2bottom:{enable:!0},codeblock:{style:"default",highlight:"light",wordWrap:!0},reward:!0,fancybox:!0,zoomImage:{gapAside:"20px"},galleryWaterfall:{colWidth:"255px",gapX:"65px"},lazyload:!0,pjax:{avoidBanner:!0},externalLink:{icon:{enable:!0,name:"fas fa-external-link-alt"}},shortcuts:void 0,prompt:{copyButton:"å¤åˆ¶",copySuccess:"æ­å–œäº²äº²ï¼Œå¤åˆ¶æˆåŠŸå’§",copyError:"å“å‘€ï¼Œå¤åˆ¶å¤±è´¥äº†"},sourcePath:{js:"js",css:"css",images:"images"},utterancesTheme:{light:"github-light",dark:"photon-dark"}};window.CONFIG=CONFIG</script><meta name="generator" content="Hexo 7.2.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">é¦–é¡µ</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">å½’æ¡£</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">åˆ†ç±»</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return!1"><span class="header-nav-menu-item__icon"><i class="fas fa-bars"></i></span><span class="header-nav-menu-item__text">å…¶ä»–</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/friends/"><span class="header-nav-submenu-item__icon"><i class="fas fa-users"></i></span><span class="header-nav-submenu-item__text">å‹é“¾</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/gallery/"><span class="header-nav-submenu-item__icon"><i class="fas fa-images"></i></span><span class="header-nav-submenu-item__text">ç›¸å†Œ</span></a></div></div></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">å…³äº</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" target="_blank" rel="noopener" href="https://davidingplus.cn/"><span class="header-nav-menu-item__icon"><i class="fas fa-pager"></i></span><span class="header-nav-menu-item__text">ç«™ç‚¹ä¸»é¡µ</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">æœç´¢</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">DavidingPlus's Blog</div><div class="header-banner-info__subtitle">ğŸ•Šï¸ world peace</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">Virtual Filesystem</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">å‘è¡¨äº</span><span class="post-meta-item__value">2024-12-24</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">æ›´æ–°äº</span><span class="post-meta-item__value">2024-12-31</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">å­—æ•°ç»Ÿè®¡</span><span class="post-meta-item__value">13.7k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">é˜…è¯»æ—¶é•¿</span><span class="post-meta-item__value">91åˆ†</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">é˜…è¯»æ¬¡æ•°</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><meta name="referrer" content="no-referrer"><p>ç¬”è®°æ‘˜æŠ„è‡ª <span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://linux-kernel-labs-zh.xyz/">Linux å†…æ ¸æ•™å­¦ â€” Linux ç³»ç»Ÿå†…æ ¸æ–‡æ¡£</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> çš„ VFS éƒ¨åˆ†ï¼Œå¹¶æ€»ç»“è®°å½•ã€‚</p><h1 id="è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿvfs"><a href="#è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿvfs" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿvfs"></a> è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</h1><p>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰æ˜¯å†…æ ¸çš„ç»„ä»¶ï¼Œå¤„ç†æ‰€æœ‰ä¸æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ã€‚VFS æ˜¯ç”¨æˆ·ä¸ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿä¹‹é—´çš„é€šç”¨æ¥å£ã€‚è¿™ç§æŠ½è±¡ç®€åŒ–äº†æ–‡ä»¶ç³»ç»Ÿçš„å®ç°ï¼Œä½¿å¾—å„ç§æ–‡ä»¶ç³»ç»Ÿæ›´å®¹æ˜“é›†æˆã€‚å„ç§æ–‡ä»¶ç³»ç»Ÿé€šè¿‡ä½¿ç”¨ VFS æä¾›çš„ API æ¥å®ç°æ–‡ä»¶ç³»ç»Ÿï¼Œé€šç”¨ç¡¬ä»¶ä»¥åŠ I/O å­ç³»ç»Ÿçš„é€šä¿¡éƒ¨åˆ†ç”± VFS å¤„ç†ã€‚</p><p>æ–‡ä»¶ç³»ç»ŸæŒ‰ç…§åŠŸèƒ½å¯åˆ†ä¸ºï¼š</p><ol><li>ç£ç›˜æ–‡ä»¶ç³»ç»Ÿï¼ˆext3ã€ext4ã€xfsã€fat ä»¥åŠ ntfs ç­‰ï¼‰ã€‚</li><li>ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼ˆnfsã€smbfs/cifsã€ncp ç­‰ï¼‰ã€‚</li><li>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆprocfsã€sysfsã€sockfsã€pipefs ç­‰ï¼‰ã€‚</li></ol><span id="more"></span><p>Linux å†…æ ¸ä½¿ç”¨ VFS å¤„ç†ç›®å½•å’Œæ–‡ä»¶çš„å±‚æ¬¡ç»“æ„ï¼ˆå…¶å®æ˜¯ä¸€æ£µæ ‘ï¼‰ã€‚é€šè¿‡æŒ‚è½½æ“ä½œï¼Œæ–°çš„æ–‡ä»¶ç³»ç»Ÿè¢«æ·»åŠ ä¸º VFS å­æ ‘ã€‚æ–‡ä»¶ç³»ç»Ÿé€šå¸¸æ˜¯ä»å…¶æ‰€å¯¹åº”çš„ç¯å¢ƒä¸­æŒ‚è½½çš„ï¼ˆä»å—ç±»å‹è®¾å¤‡ã€ç½‘ç»œç­‰ï¼‰ã€‚<strong>ç„¶è€Œ VFS å¯ä»¥å°†æ™®é€šæ–‡ä»¶ä½œä¸ºè™šæ‹Ÿå—è®¾å¤‡ä½¿ç”¨ï¼Œå¯ä»¥å°†æ™®é€šæ–‡ä»¶æŒ‚è½½ä¸ºç£ç›˜æ–‡ä»¶ç³»ç»Ÿã€‚</strong></p><p>VFS çš„åŸºæœ¬æ€æƒ³æ˜¯æä¾›å¯ä»¥è¡¨ç¤ºä»»ä½•æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶çš„å•ä¸€æ–‡ä»¶æ¨¡å‹ã€‚æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ç¨‹åºéœ€è¦éµå®ˆå…¬å…±çš„åŸºå‡†ã€‚è¿™æ ·ï¼Œå†…æ ¸å¯ä»¥åˆ›å»ºåŒ…å«æ•´ä¸ªç³»ç»Ÿçš„å•ä¸€ç›®å½•ç»“æ„ã€‚å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå°†ä½œä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå…¶ä»–æ–‡ä»¶ç³»ç»Ÿå°†æŒ‚è½½åœ¨å…¶å„ä¸ªç›®å½•ä¸‹ã€‚</p><h1 id="å­˜å‚¨æ ˆæ•´ä½“ç»“æ„"><a href="#å­˜å‚¨æ ˆæ•´ä½“ç»“æ„" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#å­˜å‚¨æ ˆæ•´ä½“ç»“æ„"></a> å­˜å‚¨æ ˆæ•´ä½“ç»“æ„</h1><p>Linux å­˜å‚¨æ ˆçš„æ•´ä½“ç»“æ„å›¾å¦‚ä¸‹ã€‚ä»ä¸Šåˆ°ä¸‹åˆ†åˆ«æ˜¯ï¼š<strong>VFSã€é€šç”¨å—å±‚ã€SCSI å±‚ã€å—è®¾å¤‡å±‚</strong>ã€‚</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20241227142615377.png" alt="image-20241227142615377" style="zoom:75%"><p>å„ä¸ªå±‚æ¬¡çš„ä½œç”¨å¦‚ä¸‹ã€‚</p><ol><li><p>VFSï¼šVFS å±‚æ˜¯ Linux æœ€ä¸ºæ´¥æ´¥ä¹é“çš„è®¾è®¡ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ä¸€åˆ‡çš†æ–‡ä»¶ã€‚å®ƒé€šè¿‡ç»Ÿä¸€çš„æ¥å£ï¼Œåº•å±‚å°è£…äº†å„ç§å„æ ·çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p></li><li><p>é€šç”¨å—å±‚ï¼šæ–‡ä»¶ç³»ç»Ÿå°†è¯»/å†™è¯·æ±‚è½¬æ¢æˆ bio å’Œ requestï¼Œæäº¤ç»™é€šç”¨å—å±‚ï¼Œé€šç”¨å—å±‚å¯¹ request è¿›è¡Œè°ƒåº¦ï¼Œå‘å¾€ä¸‹ä¸€å±‚ã€‚</p></li></ol><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20241227143348812.png" alt="image-20241227143348812" style="zoom:80%"><ol start="3"><li><p>SCSI å±‚ï¼šSCSIï¼ˆSmall Computer Systems Interfaceï¼‰æ˜¯ä¸€ç»„æ ‡å‡†é›†ï¼Œå®šä¹‰äº†ä¸å¤§é‡è®¾å¤‡ï¼ˆä¸»è¦æ˜¯ä¸å­˜å‚¨ç›¸å…³çš„è®¾å¤‡ï¼‰é€šä¿¡æ‰€éœ€çš„æ¥å£å’Œåè®®ã€‚Linux æä¾›äº†ä¸€ç§ SCSI å­ç³»ç»Ÿï¼Œç”¨äºä¸è¿™äº›è®¾å¤‡é€šä¿¡ã€‚</p></li><li><p>å—è®¾å¤‡å±‚ï¼šå—è®¾å¤‡å±‚è´Ÿè´£å¯¹æŸç§å…·ä½“çš„ç‰©ç†è®¾å¤‡è¿›è¡Œå¤„ç†ï¼Œå®Œæˆç›¸åº”çš„è¯»å†™è¯·æ±‚ã€‚</p></li></ol><h1 id="å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿæ¨¡å‹"><a href="#å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿæ¨¡å‹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿæ¨¡å‹"></a> å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿæ¨¡å‹</h1><p>ä»»ä½•å®ç°çš„æ–‡ä»¶ç³»ç»Ÿéƒ½éœ€è¦åŒ…å«è¿™å‡ ç§æ˜ç¡®å®šä¹‰çš„ç±»å‹ï¼šsuper_blockã€inodeã€file å’Œ dentryã€‚è¿™äº›ä¹Ÿæ˜¯æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®ã€‚</p><p>æ¨¡å‹å®ä½“é—´é€šè¿‡æŸäº› VFS å­ç³»ç»Ÿæˆ–å†…æ ¸å­ç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼šdentry cacheï¼ˆç›®å½•é¡¹ç¼“å­˜ï¼‰ã€inode cacheï¼ˆç´¢å¼•èŠ‚ç‚¹ç¼“å­˜ï¼‰å’Œ buffer cacheï¼ˆç¼“å†²åŒºç¼“å­˜ï¼‰ã€‚æ¯ä¸ªå®ä½“éƒ½è¢«è§†ä¸ºå¯¹è±¡ï¼Œå…·æœ‰å…³è”çš„æ•°æ®ç»“æ„å’ŒæŒ‡å‘æ–¹æ³•è¡¨çš„æŒ‡é’ˆã€‚é€šè¿‡æ›¿æ¢å…³è”çš„æ–¹æ³•æ¥ä¸ºæ¯ä¸ªç»„ä»¶å¼•å…¥ç‰¹å®šçš„è¡Œä¸ºï¼ˆç±»ä¼¼äº C++ çš„å¤šæ€ï¼‰ã€‚</p><h2 id="super_block"><a href="#super_block" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#super_block"></a> super_block</h2><p>**super_block è¶…çº§å—å­˜å‚¨æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿéœ€è¦çš„ä¿¡æ¯ã€‚**å…·ä½“å¦‚ä¸‹ï¼š</p><ol><li>inode å’Œå—çš„ä½ç½®ã€‚</li><li>æ–‡ä»¶ç³»ç»Ÿå—å¤§å°ã€‚</li><li>æœ€å¤§æ–‡ä»¶åé•¿åº¦ã€‚</li><li>æœ€å¤§æ–‡ä»¶å¤§å°ã€‚</li><li>æ ¹ inode çš„ä½ç½®ã€‚</li></ol><p>ç£ç›˜ä¸Šçš„ super_block é€šå¸¸å­˜å‚¨åœ¨ç£ç›˜çš„ç¬¬ä¸€ä¸ªå—ä¸­ï¼Œå³æ–‡ä»¶ç³»ç»Ÿæ§åˆ¶å—ã€‚</p><p>åœ¨ VFS ä¸­ï¼Œsuper_block å®ä½“éƒ½ä¿ç•™åœ¨ç±»å‹ä¸º <code>struct super_block</code> çš„ç»“æ„åˆ—è¡¨ä¸­ï¼Œæ–¹æ³•åˆ™ä¿ç•™åœ¨ç±»å‹ä¸º <code>struct super_operations</code> çš„ç»“æ„ä¸­ã€‚</p><h2 id="inode"><a href="#inode" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#inode"></a> inode</h2><p>**inode ç´¢å¼•èŠ‚ç‚¹å­˜å‚¨æœ‰å…³æ–‡ä»¶çš„ä¿¡æ¯ã€‚**è¿™é‡Œçš„æ–‡ä»¶æ³›æŒ‡æ„ä¹‰ä¸Šçš„æ–‡ä»¶ï¼Œå¸¸è§„æ–‡ä»¶ã€ç›®å½•ã€ç‰¹æ®Šæ–‡ä»¶ï¼ˆå¦‚ç®¡é“ã€fifo ç­‰ï¼‰ã€å—è®¾å¤‡ã€å­—ç¬¦è®¾å¤‡ã€é“¾æ¥æˆ–å¯ä»¥æŠ½è±¡ä¸ºæ–‡ä»¶çš„ä»»ä½•å†…å®¹éƒ½åŒ…æ‹¬åœ¨å†…ã€‚</p><p>inode å­˜å‚¨äº†ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ol><li>æ–‡ä»¶ç±»å‹ã€‚</li><li>æ–‡ä»¶å¤§å°ã€‚</li><li>è®¿é—®æƒé™ã€‚</li><li>è®¿é—®æˆ–ä¿®æ”¹æ—¶é—´ã€‚</li><li>æ•°æ®åœ¨ç£ç›˜ä¸Šçš„ä½ç½®ï¼ˆæŒ‡å‘åŒ…å«æ•°æ®çš„ç£ç›˜å—çš„æŒ‡é’ˆï¼‰ã€‚</li></ol><blockquote><p>inode é€šå¸¸ä¸åŒ…å«æ–‡ä»¶åã€‚æ–‡ä»¶åç”± dentry å­˜å‚¨ã€‚ä¸€ä¸ª inode å¯ä»¥æœ‰å¤šä¸ªåç§°ï¼ˆå¦‚å¤šä¸ªç¡¬é“¾æ¥æ–‡ä»¶æŒ‡å‘åŒä¸€ä¸ª inodeï¼‰ã€‚</p></blockquote><p>ç£ç›˜ä¸Šçš„ inode é€šå¸¸åˆ†ç»„å­˜å‚¨åœ¨ä¸€ä¸ªä¸“ç”¨çš„ inode åŒºåŸŸä¸­ï¼Œä¸æ•°æ®åŒºåŸŸåˆ†å¼€ã€‚</p><p>åœ¨ VFS ä¸­ï¼Œinode å®ä½“ç”± <code>struct inode</code> ç»“æ„è¡¨ç¤ºï¼Œç”± <code>struct inode_operations</code> ç»“æ„å®šä¹‰ä¸ä¹‹ç›¸å…³çš„æ“ä½œã€‚</p><h2 id="file"><a href="#file" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#file"></a> file</h2><p>file æ˜¯æ–‡ä»¶ç³»ç»Ÿæ¨¡å‹ä¸­è·ç¦»ç”¨æˆ·æœ€è¿‘çš„ç»„ä»¶ã€‚**inode æŠ½è±¡äº†ç£ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œfile æŠ½è±¡äº†è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ã€‚**ä¸å…¶ä»–ç»“æ„ä¸åŒçš„æ˜¯ï¼Œfile ç»“æ„ä½“åœ¨å†…å­˜ä¸­ä½œä¸º VFS çš„å®ä½“å­˜åœ¨ï¼Œä½†æ²¡æœ‰åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†ç‰©å¯¹åº”ã€‚</p><p>file å­˜å‚¨äº†ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ol><li>æ–‡ä»¶æ¸¸æ ‡ä½ç½®ã€‚</li><li>æ–‡ä»¶æ‰“å¼€æƒé™ã€‚</li><li>æŒ‡å‘å…³è” inode çš„æŒ‡é’ˆï¼ˆinode çš„ç´¢å¼•ï¼‰ã€‚</li></ol><p>åœ¨ VFS ä¸­ï¼Œfile å®ä½“ç”± <code>struct file</code> ç»“æ„è¡¨ç¤ºï¼Œä¸ä¹‹ç›¸å…³çš„æ“ä½œç”± <code>struct file_operations</code> ç»“æ„è¡¨ç¤ºã€‚</p><h2 id="dentry"><a href="#dentry" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#dentry"></a> dentry</h2><p>**dentry å°† inode å’Œ æ–‡ä»¶åå…³è”èµ·æ¥ã€‚**å­˜å‚¨ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ol><li>ç”¨äºæ ‡è¯† inode çš„æ•´æ•°ã€‚</li><li>è¡¨ç¤ºæ–‡ä»¶åçš„å­—ç¬¦ä¸²ã€‚</li></ol><p>dentry æ˜¯ç›®å½•æˆ–æ–‡ä»¶è·¯å¾„çš„ç‰¹å®šéƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œå¯¹äºè·¯å¾„ <code>/bin/vi</code>ï¼Œä¸º <code>/</code>ã€<code>bin</code> å’Œ <code>vi</code> åˆ›å»ºå…± 3 ä¸ª dentry å¯¹è±¡ã€‚</p><p>dentry åœ¨ç£ç›˜ä¸Šæœ‰å¯¹åº”ç‰©ï¼Œä½†å¯¹åº”å…³ç³»ä¸æ˜¯ç›´æ¥çš„ã€‚æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½æœ‰ç‰¹å®šçš„æ–¹å¼ç»´æŠ¤ dentryã€‚</p><p>åœ¨ VFS ä¸­ï¼Œdentry å®ä½“ç”± <code>struct dentry</code> ç»“æ„è¡¨ç¤ºï¼Œä¸ä¹‹ç›¸å…³çš„æ“ä½œåœ¨ <code>struct dentry_operations</code> ç»“æ„ä¸­å®šä¹‰ã€‚</p><h2 id="å…¶ä»–æ•°æ®ç»“æ„"><a href="#å…¶ä»–æ•°æ®ç»“æ„" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#å…¶ä»–æ•°æ®ç»“æ„"></a> å…¶ä»–æ•°æ®ç»“æ„</h2><p>é™¤äº†ä¸Šè¿°ï¼ŒVFS ä¸­è¿˜æœ‰ä¸€äº›æ•°æ®ç»“æ„ã€‚</p><ol><li>address_space/mappingï¼šè¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶ç¼“å­˜ï¼Œç»“æ„ä½“çš„åå­—ç§°ä¸º address_spaceã€‚ä½†åœ¨å…¶å®ƒç»“æ„ä½“ä¸­è¢«å¼•ç”¨æ—¶ï¼Œè¯¥æŒ‡é’ˆçš„åå­—é€šå¸¸æ˜¯ mappingã€‚</li><li>mountï¼šè¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè¢«æŒ‚è½½çš„ä¿¡æ¯ã€‚</li><li>file_system_typeï¼šè¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œä¾‹å¦‚ ext4ã€procã€sys ç­‰ã€‚</li></ol><h1 id="æ³¨å†Œå’Œæ³¨é”€æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ³¨å†Œå’Œæ³¨é”€æ–‡ä»¶ç³»ç»Ÿ" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#æ³¨å†Œå’Œæ³¨é”€æ–‡ä»¶ç³»ç»Ÿ"></a> æ³¨å†Œå’Œæ³¨é”€æ–‡ä»¶ç³»ç»Ÿ</h1><h2 id="struct-file_system_type"><a href="#struct-file_system_type" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-file_system_type"></a> struct file_system_type</h2><p>Linux å†…æ ¸æ”¯æŒå¾ˆå¤šæ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…æ‹¬ ext2/ext4ã€reiserfsã€xfsã€fatã€ntfs ç­‰ã€‚ä½†åœ¨å•ä¸ªç³»ç»Ÿä¸Šï¼Œä¸å¤ªå¯èƒ½è¶…è¿‡ 5/6 ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚æ–‡ä»¶ç³»ç»Ÿåœ¨å†…æ ¸ä¸­è¢«å®ç°ä¸ºå†…æ ¸æ¨¡å—ï¼Œå¯ä»¥åŠ¨æ€çš„åŠ è½½å’Œå¸è½½ã€‚</p><p>æè¿°ç‰¹å®šæ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„æ˜¯ <code>struct file_system_type</code>ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// linux/fs.h</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºè¯¥æ–‡ä»¶ç³»ç»Ÿçš„åç§°ï¼ˆä¼ é€’ç»™ mount -t çš„å‚æ•°ï¼‰ã€‚</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡å®šæ–‡ä»¶ç³»ç»Ÿå¿…é¡»ä»¥å“ªäº›æ ‡å¿—æŒ‚è½½ã€‚ä¾‹å¦‚æ ‡å¿— FS_REQUIRES_DEVï¼ŒæŒ‡å®š VFS æ–‡ä»¶ç³»ç»Ÿéœ€è¦ä¸€ä¸ªç£ç›˜ï¼ˆè€Œä¸æ˜¯è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰</span></span><br><span class="line">    <span class="type">int</span> fs_flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨åŠ è½½æ–‡ä»¶ç³»ç»Ÿæ—¶ä»ç£ç›˜ä¸­è¯»å–è¶…çº§å—åˆ°å†…å­˜ä¸­ã€‚æ¯ç§æ–‡ä»¶ç³»ç»Ÿçš„å‡½æ•°éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *(*<span class="title">mount</span>)(<span class="keyword">struct</span> <span class="title">file_system_type</span> *, <span class="title">int</span>, <span class="title">const</span> <span class="title">char</span> *, <span class="title">void</span> *);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾å†…å­˜ä¸­çš„è¶…çº§å—ã€‚</span></span><br><span class="line">    <span class="type">void</span> (*kill_sb)(<span class="keyword">struct</span> super_block *);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯å†…æ ¸æ¨¡å—å®ç°ï¼Œåˆ™ä¸º THIS_MODULEã€‚å¦‚æœç›´æ¥å†™åœ¨å†…æ ¸ä¸­ï¼Œåˆ™ä¸º NULLã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«ä¸è¯¥æ–‡ä»¶ç³»ç»Ÿå…³è”çš„æ‰€æœ‰è¶…çº§å—ã€‚ç”±äºåŒä¸€æ–‡ä»¶ç³»ç»Ÿå¯èƒ½ä¼šè¢«å¤šæ¬¡æŒ‚è½½ï¼Œå› æ­¤æ¯ä¸ªæŒ‚è½½ç‚¹éƒ½ä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„è¶…çº§å—ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">fs_supers</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">s_lock_key</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span> <span class="title">s_umount_key</span>;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><p>å†…æ ¸ä¸­çš„æ‰€æœ‰ file_system_type éƒ½æ˜¯é€šè¿‡ä¸€æ ¹å•å‘é“¾è¡¨ç»„ç»‡èµ·æ¥çš„ï¼Œregister_filesystem() å‡½æ•°è´Ÿè´£å°†æ–°çš„ file_system_type åŠ å…¥åˆ°è¿™ä¸ªé“¾è¡¨ä¸­ã€‚</p><p>æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿç±»å‹ä¸‹éƒ½æŒ‚è½½äº†å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œæ¯”å¦‚ sdaã€sdb éƒ½æ˜¯ ext4 æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™äº› super_block ä»¥é“¾è¡¨çš„å½¢å¼è¿æ¥åˆ° <code>file_system_type-&gt;fs_supers</code> å­—æ®µä¸­ã€‚ç³»ç»Ÿä¸­æ‰€æœ‰çš„ super_block ä¹Ÿæ˜¯é€šè¿‡ä¸€æ ¹åŒå‘é“¾è¡¨è¿›è¡Œè¿æ¥ã€‚</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20241227120407496.png" alt="image-20241227120407496" style="zoom:75%"><p>åœ¨æ¨¡å—åŠ è½½å‡½æ•°ä¸­ï¼Œå°†æ–‡ä»¶ç³»ç»Ÿæ³¨å†Œåˆ°å†…æ ¸ï¼Œéœ€è¦åšä»¥ä¸‹å‡ æ­¥ï¼š</p><ol><li>åˆå§‹åŒ– <code>struct file_system_type</code> ç»“æ„ä½“ç±»å‹çš„å®ä½“ï¼Œå¹¶å¡«å……ç›¸åº”çš„å­—æ®µä»¥åŠå›è°ƒå‡½æ•°ã€‚</li><li>è°ƒç”¨ register_filesystem() å‡½æ•°ã€‚</li></ol><p>ä¾‹å¦‚ï¼Œramfs çš„éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> <span class="title">ramfs_fs_type</span> =</span> &#123;</span><br><span class="line">    .name = <span class="string">&quot;ramfs&quot;</span>,</span><br><span class="line">    .mount = ramfs_mount,</span><br><span class="line">    .kill_sb = ramfs_kill_sb,</span><br><span class="line">    .fs_flags = FS_USERNS_MOUNT,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">init_ramfs_fs</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (test_and_set_bit(<span class="number">0</span>, &amp;once)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> register_filesystem(&amp;ramfs_fs_type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><h2 id="mount-å’Œ-kill_sb"><a href="#mount-å’Œ-kill_sb" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mount-å’Œ-kill_sb"></a> mount() å’Œ kill_sb()</h2><p>åŠ è½½æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œå†…æ ¸è°ƒç”¨ <code>struct file_system_type</code> ç»“æ„å®šä¹‰çš„ mount() å‡½æ•°ã€‚æ­¤å‡½æ•°å¯¹æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½æ˜¯å”¯ä¸€çš„ï¼Œè¿›è¡Œåˆå§‹åŒ–æ“ä½œä»¥åè¿”å›æŒ‚è½½ç‚¹çš„ç›®å½• dentry æŒ‡é’ˆã€‚mount() å‡½æ•°ä¸€èˆ¬ä¼šè°ƒç”¨ä»¥ä¸‹å‡½æ•°ä¹‹ä¸€ï¼š</p><ol><li>mount_bdev()ï¼šæŒ‚è½½å­˜å‚¨åœ¨å—è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿã€‚</li><li>mount_single()ï¼šæŒ‚è½½ä¸€ä¸ªåœ¨æ‰€æœ‰æŒ‚è½½æ“ä½œä¹‹é—´æ˜¯å…±äº«å®ä¾‹çš„æ–‡ä»¶ç³»ç»Ÿã€‚</li><li>mount_nodev()ï¼šæŒ‚è½½ä¸åœ¨ç‰©ç†è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿã€‚</li><li>mount_pseudo()ï¼šç”¨äºä¼ªæ–‡ä»¶ç³»ç»Ÿçš„è¾…åŠ©å‡½æ•°ï¼ˆå¦‚ sockfsã€pipefs ç­‰æ— æ³•è¢«æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚</li></ol><p>è¿™äº›å‡½æ•°çš„å…¶ä¸­ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å‘ fill_super() å‡½æ•°çš„æŒ‡é’ˆï¼Œè¯¥å‡½æ•°åœ¨è¶…çº§å—åˆå§‹åŒ–åè¢«è°ƒç”¨ï¼Œå€ŸåŠ©é©±åŠ¨ç¨‹åºå®Œæˆè¶…çº§å—çš„åˆå§‹åŒ–ã€‚</p><p>å¸è½½æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œå†…æ ¸è°ƒç”¨ kill_sb() å‡½æ•°ï¼Œæ‰§è¡Œæ¸…ç†åŠ¨ä½œã€‚kill_sb() å‡½æ•°ä¸€èˆ¬ä¼šè°ƒç”¨ä»¥ä¸‹å‡½æ•°ä¹‹ä¸€ï¼š</p><ol><li>kill_block_super()ï¼šå¸è½½å—è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿã€‚</li><li>kill_anon_super()ï¼šå¸è½½è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆå½“è¯·æ±‚æ—¶ç”Ÿæˆä¿¡æ¯ï¼‰ã€‚</li><li>kill_litter_super()ï¼šå¸è½½ä¸åœ¨ç‰©ç†è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆä¿¡æ¯ä¿å­˜åœ¨å†…å­˜ä¸­ï¼‰ã€‚</li></ol><p>å¯¹æ²¡æœ‰ç£ç›˜æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸€ä¸ªå®ä¾‹æ˜¯ ramfs æ–‡ä»¶ç³»ç»Ÿçš„ ramfs_mount() å‡½æ•°ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> dentry *<span class="title function_">ramfs_mount</span><span class="params">(<span class="keyword">struct</span> file_system_type *fs_type, <span class="type">int</span> flags, <span class="type">const</span> <span class="type">char</span> *dev_name, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> mount_nodev(fs_type, flags, data, ramfs_fill_super);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>å¯¹æ¥è‡ªç£ç›˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸€ä¸ªå®ä¾‹æ˜¯ minix æ–‡ä»¶ç³»ç»Ÿçš„ minix_mount() å‡½æ•°ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> dentry *<span class="title function_">minix_mount</span><span class="params">(<span class="keyword">struct</span> file_system_type *fs_type, <span class="type">int</span> flags, <span class="type">const</span> <span class="type">char</span> *dev_name, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">     <span class="keyword">return</span> mount_bdev(fs_type, flags, dev_name, data, minix_fill_super);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><h1 id="super_block-2"><a href="#super_block-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#super_block-2"></a> super_block</h1><h2 id="struct-super_block"><a href="#struct-super_block" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-super_block"></a> struct super_block</h2><p>è¶…çº§å—ä½œä¸ºç‰©ç†å®ä½“ï¼ˆç£ç›˜ä¸Šçš„å®ä½“ï¼‰å­˜åœ¨ï¼Œä¹Ÿä½œä¸º VFS å®ä½“ï¼ˆ<code>struct super_block</code> ç»“æ„ï¼‰å­˜åœ¨ã€‚è¶…çº§å—ä»…åŒ…å«å…ƒä¿¡æ¯ï¼Œå¹¶ç”¨äºä»ç£ç›˜ä¸­è¯»å–å’Œå†™å…¥å…ƒæ•°æ®ï¼ˆå¦‚ inodeã€ç›®å½•é¡¹ï¼‰ã€‚è¶…çº§å—åŠ <code>struct super_block</code> ç»“æ„åŒ…å«æœ‰å…³æ‰€ä½¿ç”¨çš„å—è®¾å¤‡ã€inode åˆ—è¡¨ã€æ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•çš„ inode æŒ‡é’ˆä»¥åŠè¶…çº§å—æ“ä½œçš„æŒ‡é’ˆçš„ä¿¡æ¯ã€‚</p><p>struct super_block å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="type">dev_t</span> s_dev;                     <span class="comment">// æ ‡è¯†ç¬¦</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> s_blocksize_bits;  <span class="comment">// å—å¤§å°ï¼ˆä»¥ä½ä¸ºå•ä½ï¼‰</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> s_blocksize;       <span class="comment">// å—å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> s_dirt;            <span class="comment">// è„æ ‡å¿—</span></span><br><span class="line">    <span class="type">loff_t</span> s_maxbytes;               <span class="comment">// æœ€å¤§æ–‡ä»¶å¤§å°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> *<span class="title">s_type</span>;</span> <span class="comment">// æ–‡ä»¶ç³»ç»Ÿç±»å‹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">super_operations</span> *<span class="title">s_op</span>;</span>   <span class="comment">// è¶…çº§å—æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> s_flags; <span class="comment">// æŒ‚è½½æ ‡å¿—</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> s_magic; <span class="comment">// æ–‡ä»¶ç³»ç»Ÿçš„é­”æ•°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">s_root</span>;</span> <span class="comment">// ç›®å½•æŒ‚è½½ç‚¹</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> s_id[<span class="number">32</span>];   <span class="comment">// ä¿¡æ¯æ ‡è¯†ç¬¦</span></span><br><span class="line">    <span class="type">void</span> *s_fs_info; <span class="comment">// æ–‡ä»¶ç³»ç»Ÿç§æœ‰ä¿¡æ¯</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><p>è¶…çº§å—å­˜å‚¨äº†æ–‡ä»¶ç³»ç»Ÿçš„å…¨å±€ä¿¡æ¯ï¼š</p><ol><li>æ‰€ä½¿ç”¨çš„ç‰©ç†è®¾å¤‡ã€‚</li><li>å—å¤§å°ã€‚</li><li>æ–‡ä»¶çš„æœ€å¤§å¤§å°ã€‚</li><li>æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚</li><li>æ”¯æŒçš„æ“ä½œã€‚</li><li>é­”æ•°ï¼ˆç”¨äºæ ‡è¯†æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚</li><li>æ ¹ç›®å½•çš„ dentryã€‚</li></ol><p>å¦å¤–ï¼Œ<code>void *s_fs_info</code> å¯ç”¨äºå­˜å‚¨æ–‡ä»¶ç³»ç»Ÿçš„ç§æœ‰æ•°æ®ï¼Œå…·ä½“å®ç°æ—¶å€™å¯åŠ å…¥è‡ªå·±çš„æ•°æ®ã€‚ç±»ä¼¼äº <code>struct file</code> çš„ <code>void *private_data</code>ã€‚</p><h2 id="super_block-æ“ä½œ"><a href="#super_block-æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#super_block-æ“ä½œ"></a> super_block æ“ä½œ</h2><p>è¶…çº§å—æ“ä½œç”± super_block æè¿°ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_operations</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥ä¸ inode ç›¸å…³çš„èµ„æºã€‚</span></span><br><span class="line">    <span class="type">int</span> (*write_inode)(<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> writeback_control *wbc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…ä¸ inode ç›¸å…³çš„èµ„æºã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *(*<span class="title">alloc_inode</span>)(<span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">sb</span>);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾ä¸ inode ç›¸å…³çš„èµ„æºã€‚</span></span><br><span class="line">    <span class="type">void</span> (*destroy_inode)(<span class="keyword">struct</span> inode *);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸è½½æ—¶è°ƒç”¨ï¼Œé‡Šæ”¾æ–‡ä»¶ç³»ç»Ÿç§æœ‰æ•°æ®çš„ä»»ä½•èµ„æºï¼ˆé€šå¸¸æ˜¯å†…å­˜ï¼‰ã€‚</span></span><br><span class="line">    <span class="type">void</span> (*put_super)(<span class="keyword">struct</span> super_block *);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æ‰§è¡Œ statfs ç³»ç»Ÿè°ƒç”¨æ—¶è°ƒç”¨ï¼ˆå°è¯• stat - f æˆ– dfï¼‰ã€‚æ­¤è°ƒç”¨å¿…é¡»å¡«å…… struct kstatfs ç»“æ„çš„å­—æ®µï¼Œå°±åƒåœ¨ ext4_statfs() å‡½æ•°ä¸­æ‰€åšçš„é‚£æ ·ã€‚</span></span><br><span class="line">    <span class="type">int</span> (*statfs)(<span class="keyword">struct</span> dentry *, <span class="keyword">struct</span> kstatfs *);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨å†…æ ¸æ£€æµ‹åˆ°é‡æ–°æŒ‚è½½å°è¯•ï¼ˆæŒ‚è½½æ ‡å¿— MS_REMOUNTMï¼‰æ—¶è°ƒç”¨ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œéœ€è¦æ£€æµ‹æ˜¯å¦å°è¯•ä»åªè¯»åˆ‡æ¢åˆ°è¯»å†™æˆ–åä¹‹ã€‚è¿™å¯ä»¥ç®€å•åœ°é€šè¿‡è®¿é—®æ—§æ ‡å¿—ï¼ˆåœ¨ sb-&gt;s_flags ä¸­ï¼‰å’Œæ–°æ ‡å¿— (flags å‚æ•°) æ¥å®Œæˆã€‚data æ˜¯ç”± mount() å‘é€çš„è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿç‰¹å®šé€‰é¡¹çš„æ•°æ®çš„æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="type">int</span> (*remount_fs)(<span class="keyword">struct</span> super_block *, <span class="type">int</span> *, <span class="type">char</span> *);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><h1 id="fill_super"><a href="#fill_super" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#fill_super"></a> fill_super()</h1><p>fill_super() å‡½æ•°ç”¨äºåœ¨æ–‡ä»¶ç³»ç»ŸåŠ è½½æ—¶çš„ mount() å‡½æ•°ä¸­è°ƒç”¨ï¼Œ<strong>ç”¨äºè¶…çº§å—åˆå§‹åŒ–çš„æœ€åä¸€æ®µï¼ŒåŒ…æ‹¬å¡«å…… struct super_block å­—æ®µå’Œæ ¹ç›®å½•çš„ inode ç»“æ„çš„åˆå§‹åŒ–</strong>ã€‚</p><p>ä¸€ä¸ªå®ä¾‹æ˜¯ ramfs_fill_super() å‡½æ•°ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/pagemap.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RAMFS_MAGIC 0x858458f6</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">super_operations</span> <span class="title">ramfs_ops</span> =</span> &#123;</span><br><span class="line">    .statfs = simple_statfs,</span><br><span class="line">    .drop_inode = generic_delete_inode,</span><br><span class="line">    .show_options = ramfs_show_options,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ramfs_fill_super</span><span class="params">(<span class="keyword">struct</span> super_block *sb, <span class="type">void</span> *data, <span class="type">int</span> silent)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ramfs_fs_info</span> *<span class="title">fsi</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">    save_mount_options(sb, data);</span><br><span class="line"></span><br><span class="line">    fsi = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> ramfs_fs_info), GFP_KERNEL);</span><br><span class="line">    sb-&gt;s_fs_info = fsi;</span><br><span class="line">    <span class="keyword">if</span> (!fsi)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    err = ramfs_parse_options(data, &amp;fsi-&gt;mount_opts);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    sb-&gt;s_maxbytes = MAX_LFS_FILESIZE;</span><br><span class="line">    sb-&gt;s_blocksize = PAGE_SIZE;</span><br><span class="line">    sb-&gt;s_blocksize_bits = PAGE_SHIFT;</span><br><span class="line">    sb-&gt;s_magic = RAMFS_MAGIC;</span><br><span class="line">    sb-&gt;s_op = &amp;ramfs_ops;</span><br><span class="line">    sb-&gt;s_time_gran = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    inode = ramfs_get_inode(sb, <span class="literal">NULL</span>, S_IFDIR | fsi-&gt;mount_opts.mode, <span class="number">0</span>);</span><br><span class="line">    sb-&gt;s_root = d_make_root(inode);</span><br><span class="line">    <span class="keyword">if</span> (!sb-&gt;s_root)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>å†…æ ¸æä¾›äº†ä¸€äº›å®ç°æ–‡ä»¶ç³»ç»Ÿç»“æ„çš„é€šç”¨å‡½æ•°ï¼Œä¾‹å¦‚ä¸Šé¢çš„ generic_delete_inode() å’Œ simple_statfs()ã€‚</p><p>ä¸Šé¢çš„ ramfs_fill_super() å‡½æ•°å¡«å……äº†è¶…çº§å—ä¸­çš„ä¸€äº›å­—æ®µï¼Œç„¶åè¯»å–æ ¹ inode å¹¶åˆ†é…æ ¹ dentryã€‚è¯»å–æ ¹ inode åœ¨ ramfs_get_inode() å‡½æ•°ä¸­å®Œæˆï¼ŒåŒ…æ‹¬ä½¿ç”¨ new_inode() å‡½æ•°åˆ†é…æ–°çš„ inode å¹¶è¿›è¡Œåˆå§‹åŒ–ã€‚ä¸ºäº†é‡Šæ”¾ inodeï¼Œä½¿ç”¨äº† iput()ï¼Œå¹¶ä½¿ç”¨ d_make_root() å‡½æ•°åˆ†é…æ ¹ dentryã€‚</p><p>VFS å‡½æ•°é€šå¸¸ä»¥è¶…çº§å—ã€ç´¢å¼•èŠ‚ç‚¹æˆ–åŒ…å«æŒ‡å‘è¶…çº§å—çš„æŒ‡é’ˆçš„ç›®å½•é¡¹ä½œä¸ºå®å‚ï¼Œä»¥ä¾¿èƒ½å¤Ÿè½»æ¾è®¿é—®è¿™äº›ç§æœ‰æ•°æ®ã€‚</p><h1 id="ç¼“å†²åŒºç¼“å­˜"><a href="#ç¼“å†²åŒºç¼“å­˜" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#ç¼“å†²åŒºç¼“å­˜"></a> ç¼“å†²åŒºç¼“å­˜</h1><p>**ç¼“å†²åŒºç¼“å­˜æ˜¯å¤„ç†å—è®¾å¤‡è¯»å†™ç¼“å­˜çš„å†…æ ¸å­ç³»ç»Ÿã€‚**ç£ç›˜æ–‡ä»¶ç³»ç»Ÿçš„åŠŸèƒ½ä¸è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œå”¯ä¸€åŒºåˆ«æ˜¯ä½¿ç”¨äº†ç¼“å†²åŒºç¼“å­˜ã€‚åŸºæœ¬ç»“æ„ä½“æ˜¯ <code>struct buffer_head</code>ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> b_state;           <span class="comment">// ç¼“å†²åŒºçš„çŠ¶æ€ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> *<span class="title">b_this_page</span>;</span> <span class="comment">// circular list of page&#x27;s buffers</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">b_page</span>;</span>             <span class="comment">// the page this bh is mapped to</span></span><br><span class="line"></span><br><span class="line">    <span class="type">sector_t</span> b_blocknr; <span class="comment">// å·²åŠ è½½æˆ–éœ€è¦ä¿å­˜åœ¨ç£ç›˜ä¸Šçš„è®¾å¤‡çš„å—å·ã€‚</span></span><br><span class="line">    <span class="type">size_t</span> b_size;      <span class="comment">// ç¼“å†²åŒºå¤§å°ã€‚</span></span><br><span class="line">    <span class="type">char</span> *b_data;       <span class="comment">// æŒ‡å‘è¯»å–æ•°æ®æˆ–å†™å…¥æ•°æ®çš„å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">block_device</span> *<span class="title">b_bdev</span>;</span>       <span class="comment">// å—è®¾å¤‡ã€‚</span></span><br><span class="line">    <span class="type">bh_end_io_t</span> *b_end_io;             <span class="comment">// I/O completion</span></span><br><span class="line">    <span class="type">void</span> *b_private;                   <span class="comment">// reserved for b_end_io</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">b_assoc_buffers</span>;</span>  <span class="comment">// associated with another mapping</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">b_assoc_map</span>;</span> <span class="comment">// mapping this buffer is associated with</span></span><br><span class="line">    <span class="type">atomic_t</span> b_count;                  <span class="comment">// users using this buffer_head</span></span><br><span class="line">    <span class="type">spinlock_t</span> b_uptodate_lock;        <span class="comment">// Used by the first bh in a page, to serialise IO completion of other buffers in the page</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><p>ä»¥ä¸‹å‡½æ•°ä¸€èˆ¬ä¼šä¸ <code>struct buffer_head</code> ä¸€èµ·ä½¿ç”¨ï¼š</p><ol><li><code>__bread()</code>ï¼šè¯»å–å…·æœ‰ç»™å®šç¼–å·å’Œç»™å®šå¤§å°çš„å—åˆ°ä¸€ä¸ª <code>struct buffer_head</code> ä¸­ã€‚å¦‚æœæˆåŠŸï¼Œåˆ™è¿”å›æŒ‡å‘ <code>struct buffer_head</code> çš„æŒ‡é’ˆï¼Œå¦åˆ™è¿”å› NULLã€‚</li><li>sb_bread()ï¼šä¸å‰ä¸€ä¸ªå‡½æ•°ç›¸åŒï¼Œä½†è¯»å–çš„å—çš„å¤§å°ä»è¶…çº§å—ä¸­è·å–ï¼Œè¯»å–çš„è®¾å¤‡ä¹Ÿä»è¶…çº§å—ä¸­è·å–ã€‚</li><li>mark_buffer_dirty()ï¼šå°†ç¼“å†²åŒºæ ‡è®°ä¸ºè„ï¼ˆè®¾ç½® BH_Dirty ä½ï¼‰ã€‚ç¼“å†²åŒºå°†åœ¨ç¨åçš„æ—¶é—´å†™å…¥ç£ç›˜ (bdflush å†…æ ¸çº¿ç¨‹ä¼šå®šæœŸå”¤é†’å¹¶å°†ç¼“å†²åŒºå†™å…¥ç£ç›˜)ã€‚</li><li>brelse()ï¼šåœ¨å…ˆå‰å°†ç¼“å†²åŒºå†™å…¥ç£ç›˜ï¼ˆå¦‚æœéœ€è¦ï¼‰åï¼Œé‡Šæ”¾ç¼“å†²åŒºä½¿ç”¨çš„å†…å­˜ã€‚</li><li>map_bh()ï¼šå°† buffer-head ä¸ç›¸åº”çš„æ‰‡åŒºå…³è”ã€‚</li></ol><h1 id="å‡½æ•°å’Œæœ‰ç”¨çš„å®"><a href="#å‡½æ•°å’Œæœ‰ç”¨çš„å®" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#å‡½æ•°å’Œæœ‰ç”¨çš„å®"></a> å‡½æ•°å’Œæœ‰ç”¨çš„å®</h1><p>è¶…çº§å—é€šå¸¸åŒ…å«ä»¥ä½å›¾ï¼ˆä½å‘é‡ï¼‰å½¢å¼è¡¨ç¤ºçš„å ç”¨å—çš„æ˜ å°„ï¼ˆç´¢å¼•èŠ‚ç‚¹ã€ç›®å½•æ¡ç›®ã€æ•°æ®å ç”¨ï¼‰ã€‚ä¸ºå¤„ç†è¿™ç§æ˜ å°„ï¼Œå»ºè®®ä½¿ç”¨ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ol><li>find_first_zero_bit()ï¼šç”¨äºåœ¨å†…å­˜åŒºåŸŸä¸­æŸ¥æ‰¾ç¬¬ä¸€ä¸ªä¸ºé›¶çš„ä½ã€‚size å‚æ•°è¡¨ç¤ºæœç´¢åŒºåŸŸä¸­çš„ä½æ•°ã€‚</li><li>test_and_set_bit()ï¼šè®¾ç½®ä½å¹¶è·å–æ—§å€¼ã€‚</li><li>test_and_clear_bit()ï¼šåˆ é™¤ä½å¹¶è·å–æ—§å€¼ã€‚</li><li>test_and_change_bit()ï¼šå–åä½çš„å€¼å¹¶è·å–æ—§å€¼ã€‚</li></ol><p>ä»¥ä¸‹å®å®šä¹‰å¯ç”¨äºéªŒè¯ç´¢å¼•èŠ‚ç‚¹çš„ç±»å‹ï¼š</p><ol><li>S_ISDIR(inode-&gt;i_mode)ï¼šç”¨äºæ£€æŸ¥ç´¢å¼•èŠ‚ç‚¹æ˜¯å¦ä¸ºç›®å½•ã€‚</li><li>S_ISREG(inode-&gt;i_mode)ï¼šç”¨äºæ£€æŸ¥ç´¢å¼•èŠ‚ç‚¹æ˜¯å¦ä¸ºæ™®é€šæ–‡ä»¶ï¼ˆéé“¾æ¥æˆ–è®¾å¤‡æ–‡ä»¶ï¼‰ã€‚</li></ol><h1 id="inode-2"><a href="#inode-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#inode-2"></a> inode</h1><p>inode æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®ï¼ˆå®ƒåŒ…å«ä¿¡æ¯çš„ä¿¡æ¯ï¼‰ã€‚inode æ˜¯ç£ç›˜ä¸Šæ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†ï¼Œä¿å­˜æ–‡ä»¶çš„ä¿¡æ¯ï¼ˆuidã€gidã€è®¿é—®æƒé™ã€è®¿é—®æ—¶é—´ä»¥åŠæŒ‡å‘æ•°æ®å—çš„æŒ‡é’ˆç­‰ï¼‰ã€‚é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œinode ä¸ä¿å­˜æ–‡ä»¶åä¿¡æ¯ï¼Œæ–‡ä»¶åç”±ç›¸å…³çš„ <code>struct dentry</code> ç»“æ„ä¿å­˜ã€‚</p><p>inode ç”¨äºå¼•ç”¨ç£ç›˜ä¸Šçš„æ–‡ä»¶ã€‚å¯¹äºè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼Œä½¿ç”¨ <code>struct file</code> ç»“æ„ã€‚ä¸€ä¸ª inode å¯ä»¥å…³è”ä¸€ä¸ªæˆ–å¤šä¸ª <code>struct file</code> ç»“æ„ã€‚å¤šä¸ªè¿›ç¨‹å¯ä»¥æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¤šæ¬¡æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶ã€‚</p><p>inode æ—¢å­˜åœ¨äºå†…å­˜ä¸­çš„ VFS ç»“æ„ï¼Œä¹Ÿå­˜åœ¨äºç£ç›˜ä¸­ï¼ˆUNIXã€HFS ä»¥åŠ NTFS ç­‰ï¼‰ã€‚VFS ä¸­çš„ inode ç”± <code>struct inode</code> ç»“æ„è¡¨ç¤ºã€‚å’Œ VFS ä¸­çš„å…¶ä»–ç»“æ„ä¸€æ ·ï¼Œ<code>struct inode</code> æ˜¯é€šç”¨ç»“æ„ï¼Œæ¶µç›–äº†æ‰€æœ‰æ”¯æŒçš„æ–‡ä»¶ç±»å‹çš„é€‰é¡¹ï¼Œç”šè‡³åŒ…æ‹¬é‚£äº›æ²¡æœ‰å…³è”ç£ç›˜å®ä½“çš„æ–‡ä»¶ç±»å‹ï¼ˆä¾‹å¦‚ FAT æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚</p><h2 id="struct-inode"><a href="#struct-inode" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-inode"></a> struct inode</h2><p><code>struct inode</code> å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">umode_t</span> i_mode; <span class="comment">// i_uid ä»¥åŠ i_gidï¼šè®¿é—®æƒé™ã€uid ä»¥åŠ gidã€‚</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> i_opflags;</span><br><span class="line">    <span class="type">kuid_t</span> i_uid;</span><br><span class="line">    <span class="type">kgid_t</span> i_gid;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> i_flags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_POSIX_ACL</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span> *<span class="title">i_acl</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">posix_acl</span> *<span class="title">i_default_acl</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span> *<span class="title">i_op</span>;</span> <span class="comment">// æŒ‡å‘ç»“æ„ inode_operations çš„æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">i_sb</span>;</span>            <span class="comment">// inode æ‰€å±çš„æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—ç»“æ„ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">i_mapping</span>;</span>     <span class="comment">// i_mapping-&gt;a_ops åŒ…å«æŒ‡å‘ struct address_space_operations çš„æŒ‡é’ˆã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">    <span class="type">void</span> *i_security;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Stat data, not accessed from path walking */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> i_ino; <span class="comment">// inode çš„ç¼–å·ï¼ˆåœ¨æ–‡ä»¶ç³»ç»Ÿå†…å”¯ä¸€æ ‡è¯† inodeï¼‰ã€‚</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Filesystems may only read i_nlink directly.  They shall use the</span></span><br><span class="line"><span class="comment">     * following functions for modification:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *    (set|clear|inc|drop)_nlink</span></span><br><span class="line"><span class="comment">     *    inode_(inc|dec)_link_count</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨æ­¤ inode çš„åç§°æ¡ç›®ï¼ˆdentryï¼‰çš„æ•°é‡ï¼›å¯¹äºæ²¡æœ‰é“¾æ¥ï¼ˆæ—¢æ²¡æœ‰ç¡¬é“¾æ¥ä¹Ÿæ²¡æœ‰ç¬¦å·é“¾æ¥ï¼‰çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸ªå€¼æ€»æ˜¯è®¾ç½®ä¸º 1ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> i_nlink;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> __i_nlink;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">dev_t</span> i_rdev;              <span class="comment">// æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿæ‰€åœ¨çš„è®¾å¤‡ã€‚</span></span><br><span class="line">    <span class="type">loff_t</span> i_size;             <span class="comment">// æ–‡ä»¶/ç›®å½•ç­‰çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span> <span class="title">i_atime</span>;</span> <span class="comment">// è®¿é—®æ—¶é—´ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span> <span class="title">i_mtime</span>;</span> <span class="comment">// ä¿®æ”¹æ—¶é—´ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec64</span> <span class="title">i_ctime</span>;</span> <span class="comment">// åˆ›å»ºæ—¶é—´ã€‚</span></span><br><span class="line">    <span class="type">spinlock_t</span> i_lock;         <span class="comment">/* i_blocks, i_bytes, maybe i_size */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> i_bytes;</span><br><span class="line">    u8 i_blkbits; <span class="comment">// å—å¤§å°ä½¿ç”¨çš„æ¯”ç‰¹æ•° == log2(å—å¤§å°)ã€‚</span></span><br><span class="line">    u8 i_write_hint;</span><br><span class="line">    <span class="type">blkcnt_t</span> i_blocks; <span class="comment">// æ–‡ä»¶ä½¿ç”¨çš„å—æ•°ï¼ˆæ‰€æœ‰å—ï¼Œä¸ä»…ä»…æ˜¯æ•°æ®å—ï¼‰ã€‚è¿™ä»…ç”±é…é¢å­ç³»ç»Ÿä½¿ç”¨ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __NEED_I_SIZE_ORDERED</span></span><br><span class="line">    <span class="type">seqcount_t</span> i_size_seqcount;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Misc */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> i_state;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">i_rwsem</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> dirtied_when; <span class="comment">/* jiffies of first dirtying */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> dirtied_time_when;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">i_hash</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">i_io_list</span>;</span> <span class="comment">/* backing dev IO list */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CGROUP_WRITEBACK</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bdi_writeback</span> *<span class="title">i_wb</span>;</span> <span class="comment">/* the associated cgroup wb */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* foreign inode detection, see wbc_detach_inode() */</span></span><br><span class="line">    <span class="type">int</span> i_wb_frn_winner;</span><br><span class="line">    u16 i_wb_frn_avg_time;</span><br><span class="line">    u16 i_wb_frn_history;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">i_lru</span>;</span> <span class="comment">/* inode LRU list */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">i_sb_list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">i_wb_list</span>;</span> <span class="comment">/* backing dev writeback list */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">i_dentry</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">i_rcu</span>;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">atomic64_t</span> i_version;</span><br><span class="line">    <span class="type">atomic64_t</span> i_sequence; <span class="comment">/* see futex */</span></span><br><span class="line">    <span class="type">atomic_t</span> i_count;      <span class="comment">// inode è®¡æ•°å™¨ï¼ŒæŒ‡ç¤ºæœ‰å¤šå°‘å†…æ ¸ç»„ä»¶åœ¨ä½¿ç”¨å®ƒã€‚</span></span><br><span class="line">    <span class="type">atomic_t</span> i_dio_count;</span><br><span class="line">    <span class="type">atomic_t</span> i_writecount;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_IMA) || defined(CONFIG_FILE_LOCKING)</span></span><br><span class="line">    <span class="type">atomic_t</span> i_readcount; <span class="comment">/* struct files open RO */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">i_fop</span>;</span> <span class="comment">// æŒ‡å‘ç»“æ„ file_operations çš„æŒ‡é’ˆã€‚former -&gt;i_op-&gt;default_file_ops</span></span><br><span class="line">        <span class="type">void</span> (*free_inode)(<span class="keyword">struct</span> inode *);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_lock_context</span> *<span class="title">i_flctx</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> <span class="title">i_data</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">i_devices</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> *<span class="title">i_pipe</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> *<span class="title">i_cdev</span>;</span></span><br><span class="line">        <span class="type">char</span> *i_link;</span><br><span class="line">        <span class="type">unsigned</span> i_dir_seq;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    __u32 i_generation;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FSNOTIFY</span></span><br><span class="line">    __u32 i_fsnotify_mask; <span class="comment">/* all events this inode cares about */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fsnotify_mark_connector</span> __<span class="title">rcu</span> *<span class="title">i_fsnotify_marks</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_ENCRYPTION</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fscrypt_info</span> *<span class="title">i_crypt_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FS_VERITY</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fsverity_info</span> *<span class="title">i_verity_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *i_private; <span class="comment">/* fs or device private pointer */</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></div></figure><p>æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿéƒ½ç¼“å­˜äº†ä¸€å®šçš„ inode æ•°é‡åˆ°å†…å­˜ä¸­ã€‚åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ inode ä»¥åŒå‘é“¾è¡¨è¿æ¥èµ·æ¥ï¼ŒæŒ‚åœ¨ <code>super_block-&gt;s_inodes</code> å­—æ®µä¸­ã€‚åŒæ—¶ï¼Œå†…æ ¸ä¸­æ‰€æœ‰çš„ inode è¢«ç»„ç»‡åœ¨äº†ä¸€ä¸ªå“ˆå¸Œè¡¨ inode_hashtable ä¸Šã€‚</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20241227141716401.png" alt="image-20241227141716401" style="zoom:75%"><p>ä¸€äº›å¯ç”¨äºå¤„ç† inode çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><ol><li>new_inode()ï¼šåˆ›å»ºæ–°çš„ inodeï¼Œå°† i_nlink å­—æ®µè®¾ç½®ä¸º 1ï¼Œå¹¶åˆå§‹åŒ– i_blkbits, i_sb å’Œ i_devã€‚</li><li>insert_inode_hash()ï¼šå°† inode æ·»åŠ åˆ° inode å“ˆå¸Œè¡¨ä¸­ã€‚è¿™ä¸ªè°ƒç”¨çš„ä¸€ä¸ªæœ‰è¶£çš„æ•ˆæœæ˜¯ï¼Œå¦‚æœ inode è¢«æ ‡è®°ä¸ºè„ï¼Œå®ƒå°†è¢«å†™å…¥ç£ç›˜ã€‚</li><li>mark_inode_dirty()ï¼šå°† inode æ ‡è®°ä¸ºè„ï¼Œç¨åå®ƒå°†è¢«å†™å…¥ç£ç›˜ã€‚</li><li>iget_locked()ï¼šä»ç£ç›˜åŠ è½½å…·æœ‰ç»™å®šç¼–å·çš„ inodeï¼Œå¦‚æœå®ƒå°šæœªåŠ è½½ã€‚</li><li>unlock_new_inode()ï¼šä¸ iget_locked() ä¸€èµ·ä½¿ç”¨ï¼Œé‡Šæ”¾å¯¹ inode çš„é”å®šã€‚</li><li>iput()ï¼šå‘Šè¯‰å†…æ ¸å¯¹ inode çš„æ“ä½œå·²ç»å®Œæˆã€‚è‹¥æ²¡æœ‰å…¶ä»–è¿›ç¨‹åœ¨ä½¿ç”¨ï¼Œå®ƒå°†è¢«é”€æ¯ï¼ˆå¦‚æœè¢«æ ‡è®°ä¸ºè„ï¼Œåˆ™å†™å…¥ç£ç›˜åå†é”€æ¯ï¼‰ã€‚</li><li>make_bad_inode()ï¼šå‘Šè¯‰å†…æ ¸è¯¥ inode æ— æ³•ä½¿ç”¨ï¼›é€šå¸¸åœ¨ä»ç£ç›˜è¯»å– inode æ—¶å‘ç°æ— æ³•è¯»å–çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œè¡¨ç¤ºè¯¥ inode æ— æ•ˆã€‚</li></ol><h2 id="inode-æ“ä½œ"><a href="#inode-æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#inode-æ“ä½œ"></a> inode æ“ä½œ</h2><h3 id="è·å–-inode"><a href="#è·å–-inode" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#è·å–-inode"></a> è·å– inode</h3><p>è·å– inode æ˜¯ inode çš„ä¸»è¦æ“ä½œä¹‹ä¸€ã€‚Linux 2.6 ä»¥å‰ï¼Œå­˜åœ¨ read_inode() å‡½æ•°ã€‚Linux 2.6 ä»¥åï¼Œç¼–ç¨‹è€…å¿…é¡»è‡ªå·±å®šä¹‰ <code>&lt;fsname&gt;_get()</code> å‡½æ•°ï¼Œ<code>fsname</code> æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„åç§°ã€‚æ­¤å‡½æ•°è´Ÿè´£æŸ¥æ‰¾ VFS ä¸­çš„ inodeï¼Œå¦‚æœå­˜åœ¨åˆ™è·å–è¯¥ inodeï¼Œå¦åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ inodeï¼Œå¹¶ç”¨ç£ç›˜ä¸­çš„ä¿¡æ¯å¡«å……å®ƒã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨ iget_locked() ä» VFS ä¸­è·å– inode ç»“æ„ã€‚å¦‚æœ inode æ˜¯æ–°åˆ›å»ºçš„ï¼Œåˆ™éœ€è¦ä½¿ç”¨ sb_bread() ä»ç£ç›˜ä¸­è¯»å– inodeï¼Œå¹¶å¡«å……æœ‰ç”¨çš„ä¿¡æ¯ã€‚</p><p>å®ä¾‹å‡½æ•°æ˜¯ minix_iget()ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> inode *<span class="title function_">V1_minix_iget</span><span class="params">(<span class="keyword">struct</span> inode *inode)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">buffer_head</span> *<span class="title">bh</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">minix_inode</span> *<span class="title">raw_inode</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">minix_inode_info</span> *<span class="title">minix_inode</span> =</span> minix_i(inode);</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    raw_inode = minix_V1_raw_inode(inode-&gt;i_sb, inode-&gt;i_ino, &amp;bh);</span><br><span class="line">    <span class="keyword">if</span> (!raw_inode)</span><br><span class="line">    &#123;</span><br><span class="line">        iget_failed(inode);</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-EIO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­¤å‡½æ•°é€šè¿‡ iget_locked() è·å– inodeã€‚å¦‚æœ inode å·²ç»å­˜åœ¨å³ä¸æ˜¯æ–°å»ºçš„ï¼Œåˆ™å‡½æ•°è¿”å›ã€‚å¦åˆ™ä½¿ç”¨ V1_minix_iget() å‡½æ•°ä»ç£ç›˜è¯»å– inodeï¼Œç„¶åä½¿ç”¨è¯»å–çš„ä¿¡æ¯åˆå§‹åŒ– VFS inodeã€‚</span></span><br><span class="line"><span class="keyword">struct</span> inode *<span class="title function_">minix_iget</span><span class="params">(<span class="keyword">struct</span> super_block *sb, <span class="type">unsigned</span> <span class="type">long</span> ino)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line"></span><br><span class="line">    inode = iget_locked(sb, ino);</span><br><span class="line">    <span class="keyword">if</span> (!inode)</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line">    <span class="comment">// I_NEW æ ‡å¿—è¡¨ç¤º inode æ˜¯å¦ä¸ºæ–°å»ºçš„ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (!(inode-&gt;i_state &amp; I_NEW))</span><br><span class="line">        <span class="keyword">return</span> inode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (INODE_VERSION(inode) == MINIX_V1)</span><br><span class="line">        <span class="keyword">return</span> V1_minix_iget(inode);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><h3 id="è¶…çº§å—æ“ä½œ"><a href="#è¶…çº§å—æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#è¶…çº§å—æ“ä½œ"></a> è¶…çº§å—æ“ä½œ</h3><p>è®¸å¤šè¶…çº§å—æ“ä½œåœ¨å¤„ç† inode çš„æ—¶å€™ä½¿ç”¨ï¼Œå¦‚ä¸‹ï¼š</p><ol><li>alloc_inode()ï¼šåˆ†é… inode()ã€‚é€šå¸¸ï¼Œæ­¤å‡½æ•°ä¼šåˆ†é…ä¸€ä¸ª <code>struct &lt;fsname&gt;_inode_info</code> ç»“æ„ï¼Œå¹¶ä½¿ç”¨ inode_init_once() æ‰§è¡ŒåŸºæœ¬çš„ VFS inode åˆå§‹åŒ–ã€‚minix æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨ kmem_cache_alloc() å‡½æ•°è¿›è¡Œåˆ†é…ï¼Œè¯¥å‡½æ•°ä¸ SLAB å­ç³»ç»Ÿäº¤äº’ã€‚å¯¹äºæ¯ä¸ªåˆ†é…ï¼Œéƒ½ä¼šè°ƒç”¨ç¼“å­˜æ„é€ å‡½æ•°ï¼Œåœ¨ minix ä¸‹æ˜¯ init_once() å‡½æ•°ã€‚æˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ kmalloc()ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåº”è°ƒç”¨ inode_init_once() å‡½æ•°ã€‚alloc_inode() å‡½æ•°å°†ç”± new_inode() å’Œ iget_locked() å‡½æ•°è°ƒç”¨ã€‚</li><li>write_inode()ï¼šå°†ä½œä¸ºå‚æ•°æ¥æ”¶çš„ inode ä¿å­˜æˆ–æ›´æ–°åˆ°ç£ç›˜ã€‚æ­¤å‡½æ•°è¦æ›´æ–° inodeï¼Œå°½ç®¡æ•ˆç‡ä¸é«˜ã€‚å¯¹åˆå­¦è€…è€Œè¨€ï¼Œå»ºè®®ä½¿ç”¨ä»¥ä¸‹æ“ä½œï¼š<ul><li>ä½¿ç”¨ sb_bread() å‡½æ•°ä»ç£ç›˜åŠ è½½ inodeã€‚</li><li>æ ¹æ®ä¿å­˜çš„ inode ä¿®æ”¹ç¼“å†²åŒºã€‚</li><li>ä½¿ç”¨ mark_buffer_dirty() å°†ç¼“å†²åŒºæ ‡è®°ä¸ºè„ã€‚å†…æ ¸å°†å¤„ç†å…¶åœ¨ç£ç›˜ä¸Šçš„å†™å…¥ã€‚</li></ul></li><li>evict_inode()ï¼šä»ç£ç›˜å’Œå†…å­˜ä¸­ç§»é™¤é€šè¿‡ i_ino å­—æ®µæ¥æ”¶çš„ inode çš„ä»»ä½•ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç£ç›˜ä¸Šçš„ inode å’Œç›¸å…³çš„æ•°æ®å—ã€‚æ¶‰åŠä»¥ä¸‹æ“ä½œï¼š<ul><li>ä»ç£ç›˜ä¸­åˆ é™¤ inodeã€‚</li><li>æ›´æ–°ç£ç›˜ä½å›¾ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚</li><li>é€šè¿‡è°ƒç”¨ truncate_inode_pages() ä» page cache ä¸­åˆ é™¤ inodeã€‚</li><li>é€šè¿‡è°ƒç”¨ clear_inode() ä»å†…å­˜ä¸­åˆ é™¤ inodeã€‚</li></ul></li><li>destroy_inode()ï¼šé‡Šæ”¾ inode å ç”¨çš„å†…å­˜ã€‚</li></ol><h3 id="inode_operations"><a href="#inode_operations" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#inode_operations"></a> inode_operations</h3><p>inode ç´¢å¼•èŠ‚ç‚¹çš„ç›¸å…³æ“ä½œç”± <code>struct inode_operations</code> ç»“æ„æè¿°ã€‚</p><p>ç´¢å¼•èŠ‚ç‚¹åˆ†ä¸ºå¤šç§ç±»å‹ï¼šæ–‡ä»¶ã€ç›®å½•ã€ç‰¹æ®Šæ–‡ä»¶ï¼ˆç®¡é“ã€FIFOï¼‰ã€å—è®¾å¤‡ã€å­—ç¬¦è®¾å¤‡ä»¥åŠé“¾æ¥ç­‰ã€‚æ¯ç§ç±»å‹éœ€è¦å®ç°çš„æ“ä½œéƒ½ä¸åŒã€‚</p><p>è®¿é—® <code>struct inode</code> ä¸­çš„ i_op å­—æ®µå¯ä»¥å¯¹ç´¢å¼•èŠ‚ç‚¹çš„æ“ä½œè¿›è¡Œåˆå§‹åŒ–å’Œè®¿é—®ã€‚</p><h1 id="mount"><a href="#mount" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mount"></a> mount</h1><p>**mount ä»£è¡¨äº†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè¢«æŒ‚è½½åˆ°äº†æŸä¸ªåœ°æ–¹ã€‚**åªæœ‰è¢«æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰èƒ½é€šè¿‡ VFS çš„ç›®å½•æ ‘è¿›è¡Œè®¿é—®ã€‚</p><p>ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¯èƒ½è¢«å¤šæ¬¡ mount åˆ°ä¸åŒçš„åœ°æ–¹ï¼Œè¿™æ ·ä¸€ä¸ª super_block ä¼šå¯¹åº”å¤šä¸ªä¸åŒçš„ mount ç»“æ„ï¼Œè¿™äº› mount ä»¥åŒå‘é“¾è¡¨çš„å½¢å¼ç»„ç»‡èµ·æ¥ï¼ŒæŒ‚åœ¨ super_block-&gt;s_mounts å­—æ®µã€‚</p><p>è¢« mount çš„ç›®å½•ç§°ä¸ºä¸€ä¸ª mount ç‚¹ã€‚ç›®å½•ä¹Ÿæ˜¯ä¸€ä¸ª dentryï¼Œmount é€šè¿‡ mnt_mountpoint å­—æ®µæŒ‡å‘è¯¥ dentryã€‚</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20241227145405084.png" alt="image-20241227145405084" style="zoom:75%"><p>æŒ‚è½½ç‚¹ç”¨ mountpoint ç»“æ„ä½“è¡¨ç¤ºã€‚æ‰€æœ‰çš„æŒ‚è½½ç‚¹è¢«æ”¾åˆ°ä¸€ä¸ªå“ˆå¸Œè¡¨ mountpoint_hashtable ä¸­ï¼Œä»¥ dentry ä¸ºé”®ï¼ˆKeyï¼‰ï¼Œmountpoint ä¸ºå€¼ï¼ˆTï¼‰ã€‚</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20241230094606623.png" alt="image-20241230094606623" style="zoom:75%"><blockquote><p>æ³¨ï¼šè¿™é‡Œçš„ mountpoint æ˜¯ä¸€ä¸ªç»“æ„ä½“ã€‚ä¸ä¸Šé¢çš„ mount-&gt;mnt_mountpoint ä¸ä¸€æ ·ï¼Œä¸Šé¢çš„æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ dentryã€‚</p></blockquote><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mount</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">mnt_hash</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mount</span> *<span class="title">mnt_parent</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">mnt_mountpoint</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> <span class="title">mnt</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">mnt_rcu</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span> <span class="title">mnt_llist</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mnt_pcp</span> __<span class="title">percpu</span> *<span class="title">mnt_pcp</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="type">int</span> mnt_count;</span><br><span class="line">	<span class="type">int</span> mnt_writers;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_mounts</span>;</span>	<span class="comment">/* list of children, anchored here */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_child</span>;</span>	<span class="comment">/* and going through their mnt_child */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_instance</span>;</span>	<span class="comment">/* mount instance on sb-&gt;s_mounts */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *mnt_devname;	<span class="comment">/* Name of device e.g. /dev/dsk/hda1 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_expire</span>;</span>	<span class="comment">/* link in fs-specific expiry list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_share</span>;</span>	<span class="comment">/* circular list of shared mounts */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_slave_list</span>;</span><span class="comment">/* list of slave mounts */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_slave</span>;</span>	<span class="comment">/* slave list entry */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mount</span> *<span class="title">mnt_master</span>;</span>	<span class="comment">/* slave is on master-&gt;mnt_slave_list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mnt_namespace</span> *<span class="title">mnt_ns</span>;</span>	<span class="comment">/* containing namespace */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mountpoint</span> *<span class="title">mnt_mp</span>;</span>	<span class="comment">/* where is it mounted */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">mnt_mp_list</span>;</span>	<span class="comment">/* list mounts with the same mountpoint */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">mnt_umount</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_umounting</span>;</span> <span class="comment">/* list entry for umount propagation */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FSNOTIFY</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fsnotify_mark_connector</span> __<span class="title">rcu</span> *<span class="title">mnt_fsnotify_marks</span>;</span></span><br><span class="line">	__u32 mnt_fsnotify_mask;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">int</span> mnt_id;			<span class="comment">/* mount identifier */</span></span><br><span class="line">	<span class="type">int</span> mnt_group_id;		<span class="comment">/* peer group identifier */</span></span><br><span class="line">	<span class="type">int</span> mnt_expiry_mark;		<span class="comment">/* true if marked for expiry */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">mnt_pins</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">mnt_stuck_children</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mountpoint</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> <span class="title">m_hash</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">m_dentry</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">m_list</span>;</span></span><br><span class="line">	<span class="type">int</span> m_count;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><p>åŒä¸€ä¸ªç›®å½•å¯è¢«å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿ mountã€‚è¿™äº›æ–‡ä»¶ç³»ç»Ÿä¼šç›¸äº’è¦†ç›–ï¼Œé€šè¿‡ VFS åªèƒ½çœ‹åˆ°æœ€è¿‘é‚£ä¸ªè¢« mount çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>ä¸ºäº†å¤„ç†è¿™ç§æƒ…å†µï¼Œæ–‡ä»¶ç³»ç»Ÿä¸­æ‰€æœ‰çš„ mount éƒ½è¢«ç»„ç»‡åˆ°åŒä¸€ä¸ªå“ˆå¸Œè¡¨ mount_hashtable ä¸­ã€‚å“ˆå¸Œè¡¨ä»¥ <code>&lt;mount, dentry&gt;</code> ä¸ºé”®ï¼ˆKeyï¼‰ï¼Œä»¥æ–°çš„ mount ä½œä¸ºå€¼ï¼ˆValueï¼‰ï¼Œå°†å…¶ç»„ç»‡èµ·æ¥ã€‚</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20241230101507978.png" alt="image-20241230101507978" style="zoom:70%"><p>å°†ä¸Šè¿°æ•´ç†ä»¥åï¼Œèƒ½å¾—åˆ°ä¸€ä¸ªæ•´ä½“çš„æ¶æ„å›¾ï¼š</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20241230102023524.png" alt="image-20241230102023524" style="zoom:70%"><h1 id="file-2"><a href="#file-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#file-2"></a> file</h1><p>**file ç»“æ„å¯¹åº”äºç”±è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ï¼Œä»…å­˜åœ¨äºå†…å­˜ä¸­ï¼Œå¹¶ä¸ inode ç´¢å¼•èŠ‚ç‚¹å…³è”ã€‚**å®ƒæ˜¯æœ€æ¥è¿‘ç”¨æˆ·ç©ºé—´çš„ VFS å®ä½“ã€‚ç»“æ„å­—æ®µåŒ…å«ç”¨æˆ·ç©ºé—´æ–‡ä»¶çš„ç†Ÿæ‚‰ä¿¡æ¯ï¼ˆè®¿é—®æ¨¡å¼ã€æ–‡ä»¶ä½ç½®ç­‰ï¼‰ï¼Œä¸ä¹‹ç›¸å…³çš„æ“ä½œç”±å·²çŸ¥çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆread, write ç­‰ï¼‰æ‰§è¡Œã€‚</p><p>æ–‡ä»¶æ“ä½œç”± <code>struct file_operations</code> ç»“æ„æè¿°ã€‚æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶æ“ä½œä½¿ç”¨ <code>struct inode</code> ç»“æ„ä¸­çš„ i_fop å­—æ®µè¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨æ‰“å¼€æ–‡ä»¶æ—¶ï¼ŒVFS ä½¿ç”¨ inode-&gt;i_fop çš„åœ°å€åˆå§‹åŒ– <code>struct file</code> ç»“æ„çš„ f_op å­—æ®µã€‚åç»­çš„ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨å­˜å‚¨åœ¨ file-&gt;f_op ä¸­çš„å€¼ã€‚</p><p>file ä¸ inode çš„åŒºåˆ«åœ¨äºï¼Œä¸€ä¸ªæ–‡ä»¶çš„ inode åœ¨å†…æ ¸ä¸­æ˜¯å”¯ä¸€çš„ï¼Œä½† file å¯ä»¥æœ‰å¤šä¸ªã€‚</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20241230104309655.png" alt="image-20241230104309655" style="zoom:70%"><h1 id="å¸¸è§„æ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹"><a href="#å¸¸è§„æ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#å¸¸è§„æ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹"></a> å¸¸è§„æ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹</h1><p>ä½¿ç”¨ç´¢å¼•èŠ‚ç‚¹å¿…é¡»è¦å¡«å…… inode ç»“æ„çš„ i_op å’Œ i_fop å­—æ®µã€‚ç´¢å¼•èŠ‚ç‚¹çš„ç±»å‹å†³å®šäº†ä»–è¦å®ç°çš„æ“ä½œã€‚</p><p>ä¸€ä¸ªä¾‹å­æ˜¯ minix æ–‡ä»¶ç³»ç»Ÿçš„å¯¹è±¡å®ä¾‹ minix_file_operations å’Œ minix_file_inode_operationsã€‚</p><p>Linux å†…æ ¸å®ç°äº† generic_file_llseek()ã€generic_file_read_iter()ã€generic_file_write_iter()ã€generic_file_mmap() å‡½æ•°ï¼Œå®šä¹‰äº†ä¸€äº›é€šç”¨çš„ file æ“ä½œï¼Œå…·ä½“åšäº†å“ªäº›å¤„ç†å¯å‚è§æºç ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">minix_file_operations</span> =</span> &#123;</span><br><span class="line">    .llseek = generic_file_llseek,</span><br><span class="line">    .read_iter = generic_file_read_iter,</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    .write_iter = generic_file_write_iter,</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    .mmap = generic_file_mmap,</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span> <span class="title">minix_file_inode_operations</span> =</span> &#123;</span><br><span class="line">    .setattr = minix_setattr,</span><br><span class="line">    .getattr = minix_getattr,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (S_ISREG(inode-&gt;i_mode))</span><br><span class="line">    &#123;</span><br><span class="line">        inode-&gt;i_op = &amp;minix_file_inode_operations;</span><br><span class="line">        inode-&gt;i_fop = &amp;minix_file_operations;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>å¯¹äºç®€å•çš„æ–‡ä»¶ç³»ç»Ÿï¼Œåªéœ€å®ç°æˆªæ–­ truncate() ç³»ç»Ÿè°ƒç”¨ã€‚ä» Linux 3.14 å¼€å§‹ï¼Œè¯¥æ“ä½œå·²åµŒå…¥åˆ° setattr() ä¸­ã€‚å¦‚æœç²˜è´´å¤§å°ä¸ç´¢å¼•èŠ‚ç‚¹çš„å½“å‰å¤§å°ä¸åŒï¼Œåˆ™å¿…é¡»æ‰§è¡Œæˆªæ–­æ“ä½œã€‚</p><p>ä¸€ä¸ªä¾‹å­æ˜¯ minix_setattr() å‡½æ•°ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">minix_setattr</span><span class="params">(<span class="keyword">struct</span> dentry *dentry, <span class="keyword">struct</span> iattr *attr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> d_inode(dentry);</span><br><span class="line">    <span class="type">int</span> error;</span><br><span class="line"></span><br><span class="line">    error = setattr_prepare(dentry, attr);</span><br><span class="line">    <span class="keyword">if</span> (error)</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((attr-&gt;ia_valid &amp; ATTR_SIZE) &amp;&amp;</span><br><span class="line">        attr-&gt;ia_size != i_size_read(inode))</span><br><span class="line">    &#123;</span><br><span class="line">        error = inode_newsize_ok(inode, attr-&gt;ia_size);</span><br><span class="line">        <span class="keyword">if</span> (error)</span><br><span class="line">            <span class="keyword">return</span> error;</span><br><span class="line"></span><br><span class="line">        truncate_setsize(inode, attr-&gt;ia_size);</span><br><span class="line">        minix_truncate(inode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setattr_copy(inode, attr);</span><br><span class="line">    mark_inode_dirty(inode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>æˆªæ–­æ“ä½œæ¶‰åŠä»¥ä¸‹å†…å®¹ï¼š</p><ol><li>é‡Šæ”¾ç£ç›˜ä¸Šå¤šä½™çš„æ•°æ®å—ï¼ˆå¦‚æœæ–°å°ºå¯¸å°äºæ—§å°ºå¯¸ï¼‰ï¼Œæˆ–è€…åˆ†é…æ–°çš„æ•°æ®å—ï¼ˆå½“æ–°å°ºå¯¸è¾ƒå¤§æ—¶ï¼‰ã€‚</li><li>æ›´æ–°ç£ç›˜ä½å›¾ï¼ˆå¦‚æœä½¿ç”¨ï¼‰ã€‚</li><li>æ›´æ–°ç´¢å¼•èŠ‚ç‚¹ã€‚</li><li>ä½¿ç”¨ block_truncate_page() å‡½æ•°ï¼Œå°†ä¸Šä¸€ä¸ªå—ä¸­æœªä½¿ç”¨çš„ç©ºé—´å¡«å……ä¸ºé›¶ã€‚</li></ol><h1 id="page-cache"><a href="#page-cache" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#page-cache"></a> page cache</h1><p>ç¬”è®°æ‘˜æŠ„è‡ªæ–‡ç«  <span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.ywang-wnlo.xyz/posts/9ba60726/">https://blog.ywang-wnlo.xyz/posts/9ba60726/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ã€‚</p><p>ç”±äºç£ç›˜ HDD ä»¥åŠç°åœ¨å¹¿æ³›ä½¿ç”¨çš„å›ºæ€ç¡¬ç›˜ SSD çš„è¯»å†™é€Ÿåº¦éƒ½è¿œå°äºå†…å­˜ DRAM çš„è¯»å†™é€Ÿåº¦ã€‚ä¸ºé¿å…æ¯æ¬¡è¯»å–æ•°æ®éƒ½è¦ç›´æ¥è®¿é—®è¿™äº›ä½é€Ÿçš„åº•å±‚å­˜å‚¨è®¾å¤‡ï¼ŒLinux åˆ©ç”¨ DRAM å®ç°äº†ä¸€ä¸ªç¼“å­˜å±‚ï¼Œç¼“å­˜çš„ç²’åº¦æ˜¯ pageï¼Œä¹Ÿå« page cacheï¼Œä¹Ÿå°±æ˜¯é¡µï¼ˆé¢ï¼‰ç¼“å­˜ã€‚</p><p>ç»è¿‡è¿™å±‚ page cache çš„ä½œç”¨ï¼ŒI/O çš„æ€§èƒ½å¾—åˆ°äº†æ˜¾è‘—çš„æå‡ã€‚ä¸è¿‡ç”±äº DRAM å…·æœ‰æ˜“å¤±æ€§ï¼Œåœ¨æ‰ç”µåæ•°æ®ä¼šä¸¢å¤±ï¼Œå› æ­¤å†…æ ¸ä¸­çš„ å›å†™æœºåˆ¶å®šæ—¶å°† page cache ä¸­çš„æ•°æ®ä¸‹åˆ·åˆ°è®¾å¤‡ä¸Šï¼Œä¿è¯æ•°æ®çš„æŒä¹…åŒ–ã€‚æ­¤å¤–å†…æ ¸è¿˜åœ¨ page cache ä¸­å®ç°äº†å·§å¦™çš„é¢„è¯»æœºåˆ¶ï¼Œæå‡äº†é¡ºåºè¯»æ€§èƒ½ã€‚</p><p>å†™å…¥åˆ° page cache çš„æ•°æ®ä¸ä¼šç«‹åˆ»å†™å…¥åç«¯è®¾å¤‡ï¼Œè€Œæ˜¯æ ‡è®°ä¸ºâ€œè„â€ï¼Œå¹¶è¢«åŠ å…¥åˆ°è„é¡µé“¾è¡¨ï¼Œåç»­ç”±å†…æ ¸ä¸­çš„å›å†™è¿›ç¨‹å‘¨æœŸæ€§çš„å°†è„é¡µå†™å›åˆ°åº•å±‚å­˜å‚¨è®¾å¤‡ã€‚</p><p>åœ¨æ‹¥æœ‰ page cache è¿™ä¸€å±‚åï¼Œå†™æ•°æ®å°±æœ‰äº†ä¸‰ç§ä¸åŒçš„ç­–ç•¥ï¼š</p><ol><li><p><strong>ä¸ç»è¿‡ç¼“å­˜ï¼Œç›´æ¥å†™åº•å±‚å­˜å‚¨è®¾å¤‡ï¼Œä½†åŒæ—¶è¦ä½¿ç¼“å­˜ä¸­æ•°æ®å¤±æ•ˆï¼Œä¹Ÿå«ä¸ç¼“å­˜ï¼ˆnowriteï¼‰ã€‚</strong></p></li><li><p><strong>åªå†™ç¼“å­˜ï¼Œç¼“å­˜ä¸­æ•°æ®å®šæœŸåˆ·åˆ°åº•å±‚å­˜å‚¨è®¾å¤‡ä¸Šï¼Œä¹Ÿå«å†™å›ï¼ˆwrite backï¼‰ã€‚</strong></p></li><li><p><strong>åŒæ—¶å†™ç¼“å­˜å’Œåº•å±‚å­˜å‚¨è®¾å¤‡ï¼Œä¹Ÿå«å†™ç©¿ï¼ˆwrite throughï¼‰ã€‚</strong></p></li></ol><p>å‰ä¸¤ç§å°±æ˜¯ç›´æ¥ I/Oï¼ˆdirect_ioï¼‰å’Œç¼“å­˜ I/Oï¼ˆbuffer_ioï¼‰ã€‚</p><p>ç¬¬ä¸‰ç§ç­–ç•¥è™½ç„¶èƒ½éå¸¸ç®€å•ä¿è¯ç¼“å­˜å’Œåº•å±‚è®¾å¤‡çš„ä¸€è‡´æ€§ï¼Œä¸è¿‡åŸºäºæ—¶é—´å±€éƒ¨æ€§åŸç†ï¼Œpage cache ä¸­çš„æ•°æ®å¯èƒ½åªæ˜¯ä¸­é—´æ€ï¼Œä¼šè¢«é¢‘ç¹ä¿®æ”¹ï¼Œæ¯æ¬¡å†™ç©¿ä¼šäº§ç”Ÿå¤§é‡çš„å¼€é”€ã€‚</p><p>å…³äº page cache çš„å†™å›æœºåˆ¶ï¼ˆwrite backï¼‰ï¼Œå‚è€ƒ <span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.ywang-wnlo.xyz/posts/646202b9/">https://blog.ywang-wnlo.xyz/posts/646202b9/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ã€‚</p><h1 id="address_space"><a href="#address_space" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#address_space"></a> address_space</h1><p>**è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸æ–‡ä»¶ä¹‹é—´æœ‰ç€å¯†åˆ‡çš„è”ç³»ï¼šç¨‹åºçš„æ‰§è¡Œå‡ ä¹å®Œå…¨æ˜¯é€šè¿‡å°†æ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­è¿›è¡Œçš„ã€‚**è¿™ç§æ–¹æ³•éå¸¸æœ‰æ•ˆä¸”ç›¸å½“é€šç”¨ï¼Œä¹Ÿå¯ä»¥ç”¨äºå¸¸è§„çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚ read() å’Œ write()ã€‚</p><p>æè¿°åœ°å€ç©ºé—´çš„ç»“æ„æ˜¯ <code>struct address_space</code>ï¼Œä¸ä¹‹ç›¸å…³çš„æ“ä½œç”±ç»“æ„ <code>struct address_space_operations</code> æè¿°ã€‚åˆå§‹åŒ– <code>struct address_space_operations</code> éœ€å¡«å……æ–‡ä»¶ç±»å‹ç´¢å¼•èŠ‚ç‚¹çš„ <code>inode-&gt;i_mapping-&gt;a_ops</code>ã€‚</p><blockquote><p><code>struct address_space</code> æ˜¯ page cache çš„æ ¸å¿ƒç»“æ„ä½“ã€‚æ¯ä¸€ä¸ª address_space ä¸ä¸€ä¸ª inode å¯¹åº”ï¼ŒåŒæ—¶ file ä¸­çš„ f_mapping å­—æ®µé€šå¸¸ç”±è¯¥æ–‡ä»¶çš„ inode ä¸­ i_mapping èµ‹å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªæ–‡ä»¶éƒ½ä¼šæœ‰ç‹¬è‡ªçš„ fileã€inode ä»¥åŠ address_space ç»“æ„ä½“ã€‚</p><p><code>struct address_space</code> ä¸­çš„ <code>struct xarray i_pages</code> å°±æ˜¯è¯¥æ–‡ä»¶çš„ page cache ä¸­ç¼“å­˜çš„æ‰€æœ‰ç‰©ç†é¡µã€‚å®ƒæ˜¯é€šè¿‡åŸºæ•°æ ‘ç»“æ„è¿›è¡Œç®¡ç†çš„ï¼Œè€Œ xarray åªæ˜¯åœ¨åŸºæ•°æ ‘ä¸Šè¿›è¡Œäº†ä¸€å±‚å°è£…ã€‚</p><p>é€šå¸¸ <code>struct address_space</code> ä¸Šä¼šæŒ‚è½½ä¸€ä¸ª <code>struct address_space_operations</code>ï¼Œè‡ªå®šä¹‰å¯¹ page cache ä¸­çš„é¡µé¢æ“ä½œçš„å‡½æ•°ã€‚</p></blockquote><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span>		*<span class="title">host</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">xarray</span>		<span class="title">i_pages</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span>	<span class="title">invalidate_lock</span>;</span></span><br><span class="line">	<span class="type">gfp_t</span>			gfp_mask;</span><br><span class="line">	<span class="type">atomic_t</span>		i_mmap_writable;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_READ_ONLY_THP_FOR_FS</span></span><br><span class="line">	<span class="comment">/* number of thp, only for non-shmem files */</span></span><br><span class="line">	<span class="type">atomic_t</span>		nr_thps;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_root_cached</span>	<span class="title">i_mmap</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span>	<span class="title">i_mmap_rwsem</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		nrpages;</span><br><span class="line">	<span class="type">pgoff_t</span>			writeback_index;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">address_space_operations</span> *<span class="title">a_ops</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		flags;</span><br><span class="line">	<span class="type">errseq_t</span>		wb_err;</span><br><span class="line">	<span class="type">spinlock_t</span>		private_lock;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">private_list</span>;</span></span><br><span class="line">	<span class="type">void</span>			*private_data;</span><br><span class="line">&#125; __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="type">long</span>)))) __randomize_layout;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">address_space_operations</span> &#123;</span></span><br><span class="line">	<span class="type">int</span> (*writepage)(<span class="keyword">struct</span> page *page, <span class="keyword">struct</span> writeback_control *wbc);</span><br><span class="line">	<span class="type">int</span> (*readpage)(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> page *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Write back some dirty pages from this mapping. */</span></span><br><span class="line">    <span class="comment">// writepage() æˆ– writepages() è´Ÿè´£å¯¹è¿™äº›ç‰©ç†é¡µçš„å®é™…å†™å…¥ã€‚</span></span><br><span class="line">	<span class="type">int</span> (*writepages)(<span class="keyword">struct</span> address_space *, <span class="keyword">struct</span> writeback_control *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set a page dirty.  Return true if this dirtied it */</span></span><br><span class="line">	<span class="type">int</span> (*set_page_dirty)(<span class="keyword">struct</span> page *page);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Reads in the requested pages. Unlike -&gt;readpage(), this is</span></span><br><span class="line"><span class="comment">	 * PURELY used for read-ahead!.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> (*readpages)(<span class="keyword">struct</span> file *filp, <span class="keyword">struct</span> address_space *mapping,</span><br><span class="line">			<span class="keyword">struct</span> list_head *pages, <span class="type">unsigned</span> nr_pages);</span><br><span class="line">	<span class="type">void</span> (*readahead)(<span class="keyword">struct</span> readahead_control *);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸»è¦è´Ÿè´£æŸ¥æ‰¾ã€æˆ–è€…åˆ†é…æ–°çš„ç‰©ç†é¡µï¼Œå¹¶å°†å…¶é”å®šï¼Œæœ‰æ—¶è¿˜éœ€è¦å…ˆä»åº•å±‚è¯»å–æœ€æ–°çš„æ•°æ®é¡µã€‚</span></span><br><span class="line">	<span class="type">int</span> (*write_begin)(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> address_space *mapping,</span><br><span class="line">				<span class="type">loff_t</span> pos, <span class="type">unsigned</span> len, <span class="type">unsigned</span> flags,</span><br><span class="line">				<span class="keyword">struct</span> page **pagep, <span class="type">void</span> **fsdata);</span><br><span class="line">    <span class="comment">// ä¸»è¦è´Ÿè´£è§£é”è¿™äº›ç‰©ç†é¡µï¼Œå¹¶ä¸”æ›´æ–° inode ä¸­çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¾‹å¦‚ i_sizeã€‚</span></span><br><span class="line">	<span class="type">int</span> (*write_end)(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> address_space *mapping,</span><br><span class="line">				<span class="type">loff_t</span> pos, <span class="type">unsigned</span> len, <span class="type">unsigned</span> copied,</span><br><span class="line">				<span class="keyword">struct</span> page *page, <span class="type">void</span> *fsdata);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Unfortunately this kludge is needed for FIBMAP. Don&#x27;t use it */</span></span><br><span class="line">	<span class="type">sector_t</span> (*bmap)(<span class="keyword">struct</span> address_space *, <span class="type">sector_t</span>);</span><br><span class="line">	<span class="type">void</span> (*invalidatepage) (<span class="keyword">struct</span> page *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">	<span class="type">int</span> (*releasepage) (<span class="keyword">struct</span> page *, <span class="type">gfp_t</span>);</span><br><span class="line">	<span class="type">void</span> (*freepage)(<span class="keyword">struct</span> page *);</span><br><span class="line">	<span class="type">ssize_t</span> (*direct_IO)(<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *iter);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * migrate the contents of a page to the specified target. If</span></span><br><span class="line"><span class="comment">	 * migrate_mode is MIGRATE_ASYNC, it must not block.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> (*migratepage) (<span class="keyword">struct</span> address_space *,</span><br><span class="line">			<span class="keyword">struct</span> page *, <span class="keyword">struct</span> page *, <span class="keyword">enum</span> migrate_mode);</span><br><span class="line">	<span class="type">bool</span> (*isolate_page)(<span class="keyword">struct</span> page *, <span class="type">isolate_mode_t</span>);</span><br><span class="line">	<span class="type">void</span> (*putback_page)(<span class="keyword">struct</span> page *);</span><br><span class="line">	<span class="type">int</span> (*launder_page) (<span class="keyword">struct</span> page *);</span><br><span class="line">	<span class="type">int</span> (*is_partially_uptodate) (<span class="keyword">struct</span> page *, <span class="type">unsigned</span> <span class="type">long</span>,</span><br><span class="line">					<span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">	<span class="type">void</span> (*is_dirty_writeback) (<span class="keyword">struct</span> page *, <span class="type">bool</span> *, <span class="type">bool</span> *);</span><br><span class="line">	<span class="type">int</span> (*error_remove_page)(<span class="keyword">struct</span> address_space *, <span class="keyword">struct</span> page *);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* swapfile support */</span></span><br><span class="line">	<span class="type">int</span> (*swap_activate)(<span class="keyword">struct</span> swap_info_struct *sis, <span class="keyword">struct</span> file *file,</span><br><span class="line">				<span class="type">sector_t</span> *span);</span><br><span class="line">	<span class="type">void</span> (*swap_deactivate)(<span class="keyword">struct</span> file *file);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><p>address_space æ˜¯ä»¥åŸºæ•°æ ‘è¿›è¡Œç»„ç»‡çš„æ–‡ä»¶ Cacheã€‚ä»¥é¡µä¸ºå•ä½ï¼Œ<code>page-&gt;index = è¯¥é¡µåœ¨æ–‡ä»¶ä¸­çš„é€»è¾‘åç§» / page_size</code>ã€‚</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20241230103801350.png" alt="image-20241230103801350" style="zoom:30%"><p>ä¾‹å¦‚ minix æ–‡ä»¶ç³»ç»Ÿçš„ minix_aops ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">address_space_operations</span> <span class="title">minix_aops</span> =</span> &#123;</span><br><span class="line">    .readpage = minix_readpage,</span><br><span class="line">    .writepage = minix_writepage,</span><br><span class="line">    .write_begin = minix_write_begin,</span><br><span class="line">    .write_end = generic_write_end,</span><br><span class="line">    .bmap = minix_bmap&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (S_ISREG(inode-&gt;i_mode))</span><br><span class="line">    &#123;</span><br><span class="line">        inode-&gt;i_mapping-&gt;a_ops = &amp;minix_aops;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>å†…æ ¸å·²å®ç° generic_write_end() å‡½æ•°ã€‚å¹¶ä¸”ä¸Šè¿°çš„å¤§å¤šæ•°å‡½æ•°çš„å®ç°å…¶å®éƒ½éå¸¸ç®€å•ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">minix_writepage</span><span class="params">(<span class="keyword">struct</span> page *page, <span class="keyword">struct</span> writeback_control *wbc)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> block_write_full_page(page, minix_get_block, wbc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">minix_readpage</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="keyword">struct</span> page *page)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> block_read_full_page(page, minix_get_block);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">minix_write_failed</span><span class="params">(<span class="keyword">struct</span> address_space *mapping, <span class="type">loff_t</span> to)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> mapping-&gt;host;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (to &gt; inode-&gt;i_size)</span><br><span class="line">    &#123;</span><br><span class="line">        truncate_pagecache(inode, inode-&gt;i_size);</span><br><span class="line">        minix_truncate(inode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">minix_write_begin</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="keyword">struct</span> address_space *mapping,</span></span><br><span class="line"><span class="params">                             <span class="type">loff_t</span> pos, <span class="type">unsigned</span> len, <span class="type">unsigned</span> flags,</span></span><br><span class="line"><span class="params">                             <span class="keyword">struct</span> page **pagep, <span class="type">void</span> **fsdata)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = block_write_begin(mapping, pos, len, flags, pagep,</span><br><span class="line">                            minix_get_block);</span><br><span class="line">    <span class="keyword">if</span> (unlikely(ret))</span><br><span class="line">        minix_write_failed(mapping, pos + len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">sector_t</span> <span class="title function_">minix_bmap</span><span class="params">(<span class="keyword">struct</span> address_space *mapping, <span class="type">sector_t</span> block)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> generic_block_bmap(mapping, block, minix_get_block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>ä¸Šé¢å‡½æ•°ä¸­èƒ½ç»å¸¸è§åˆ° minix_get_block è¿™ä¸ªä¸œè¥¿ã€‚æŸ¥çœ‹ block_write_full_page() å‡½æ•°å®šä¹‰å‘ç°æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚</p><p>åœ¨ minix æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œminix_get_block() å‡½æ•°å°†æ–‡ä»¶çš„ä¸€ä¸ªæ•°æ®å—è½¬æ¢ä¸ºè®¾å¤‡ä¸Šçš„ä¸€ä¸ªæ•°æ®å—ã€‚å¦‚æœæ¥æ”¶åˆ°çš„ create æ ‡å¿—è¢«è®¾ç½®ï¼Œé‚£ä¹ˆå¿…é¡»åˆ†é…ä¸€ä¸ªæ–°çš„æ•°æ®å—ã€‚åœ¨åˆ›å»ºæ–°çš„æ•°æ®å—æ—¶ï¼Œå¿…é¡»ç›¸åº”åœ°æ›´æ–°ä½å›¾ã€‚ä¸ºé€šçŸ¥å†…æ ¸ä¸è¦ä»ç£ç›˜ä¸­è¯»å–è¯¥æ•°æ®å—ï¼Œå¿…é¡»ä½¿ç”¨ set_buffer_new() å‡½æ•°æ ‡è®° bhã€‚é€šè¿‡ map_bh() å‡½æ•°ï¼Œå°†ç¼“å†²åŒºä¸æ•°æ®å—å…³è”èµ·æ¥ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">block_write_full_page</span><span class="params">(<span class="keyword">struct</span> page *page, <span class="type">get_block_t</span> *get_block, <span class="keyword">struct</span> writeback_control *wbc)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(<span class="type">get_block_t</span>)</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="type">sector_t</span> iblock, <span class="keyword">struct</span> buffer_head *bh_result, <span class="type">int</span> create)</span>;</span><br></pre></td></tr></table></div></figure><h1 id="dentry-2"><a href="#dentry-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#dentry-2"></a> dentry</h1><h2 id="struct-dentry"><a href="#struct-dentry" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#struct-dentry"></a> struct dentry</h2><p>dentry å°† inode å’Œ æ–‡ä»¶åå…³è”èµ·æ¥ã€‚VFS ä¸­çš„ dentry å®ä½“ç”¨ <code>struct dentry</code> è¡¨ç¤ºï¼Œç›¸å…³æ“ä½œç”¨ <code>struct dentry_operations</code> è¡¨ç¤ºã€‚</p><p><code>struct dentry</code> é‡è¦å­—æ®µå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">d_inode</span>;</span> <span class="comment">// å…³è”çš„ç´¢å¼•èŠ‚ç‚¹ã€‚</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">d_parent</span>;</span> <span class="comment">// çˆ¶ç›®å½•çš„ dentry å¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">qstr</span> <span class="title">d_name</span>;</span>      <span class="comment">// dentry åç§°ï¼Œstruct qstr ç±»å‹ï¼ŒåŒ…å«å­—æ®µ nameï¼ˆåç§°ï¼‰å’Œ lenï¼ˆåç§°çš„é•¿åº¦ï¼‰ã€‚</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry_operations</span> *<span class="title">d_op</span>;</span> <span class="comment">// ä¸ dentry ç›¸å…³çš„æ“ä½œã€‚å†…æ ¸å®ç°äº†é»˜è®¤æ“ä½œï¼Œç†è®ºä¸Šæ— éœ€é‡æ–°å®ç°å®ƒä»¬ã€‚æŸäº›æ–‡ä»¶ç³»ç»Ÿå¯ä»¥æ ¹æ® dentry çš„ç‰¹å®šç»“æ„è¿›è¡Œä¼˜åŒ–ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *<span class="title">d_sb</span>;</span>       <span class="comment">// æ–‡ä»¶çš„è¶…çº§å—ã€‚</span></span><br><span class="line">    <span class="type">void</span> *d_fsdata;                 <span class="comment">// æ–‡ä»¶ç³»ç»Ÿç‰¹å®šçš„æ•°æ®ã€‚</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><p>dentry ä¹Ÿæœ‰ä¸€ä¸ªå…¨å±€å“ˆå¸Œè¡¨è¿›è¡Œç»„ç»‡ï¼Œä¸å®ƒå¯¹åº”çš„ inode äº’æŒ‡ã€‚</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20241230102953331.png" alt="image-20241230102953331" style="zoom:75%"><h2 id="dentry-æ“ä½œ"><a href="#dentry-æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#dentry-æ“ä½œ"></a> dentry æ“ä½œ</h2><p>dentry æœ€å¸¸è§çš„æ“ä½œåŒ…æ‹¬ï¼š</p><ol><li>d_make_root()ï¼šåˆ†é…æ ¹ dentryã€‚é€šå¸¸åœ¨è¯»å–è¶…çº§å—çš„å‡½æ•° fill_super() ä¸­ä½¿ç”¨ã€‚æ­¤å‡½æ•°å¿…é¡»åˆå§‹åŒ–æ ¹ç›®å½•ã€‚ä¸€èˆ¬ä»è¶…çº§å—è·å–æ ¹ç´¢å¼•èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶ä½œä¸ºå®å‚ä¼ é€’ç»™æ­¤å‡½æ•°ï¼Œä»¥å¡«å…… struct super_block ç»“æ„çš„ s_root å­—æ®µã€‚</li><li>d_add()ï¼šå°† dentry ä¸ç´¢å¼•èŠ‚ç‚¹å…³è”èµ·æ¥ã€‚ä½œä¸ºå‚æ•°ä¼ é€’çš„ dentry è¡¨ç¤ºéœ€è¦åˆ›å»ºçš„æ¡ç›®ï¼ˆåç§°ã€é•¿åº¦ï¼‰ã€‚åœ¨åˆ›å»ºæˆ–åŠ è½½å°šæœªä¸ä»»ä½• dentry å…³è”å¹¶å°šæœªæ·»åŠ åˆ°ç´¢å¼•èŠ‚ç‚¹å“ˆå¸Œè¡¨ä¸­çš„æ–°ç´¢å¼•èŠ‚ç‚¹æ—¶ï¼Œå°†ä½¿ç”¨æ­¤å‡½æ•°ï¼ˆåœ¨ lookup() å‡½æ•°ä¸­ï¼‰ã€‚</li><li>d_instantiate()ï¼šd_add() çš„è½»é‡çº§ç‰ˆæœ¬ï¼Œå…¶ä¸­ dentry å…ˆå‰å·²æ·»åŠ åˆ°å“ˆå¸Œè¡¨ä¸­ã€‚æ³¨æ„ï¼Œd_instantiate() å¿…é¡»ç”¨äºå®ç°åˆ›å»ºè°ƒç”¨ (mkdir, mknod, rename ä»¥åŠ symlink)ï¼Œè€Œä¸æ˜¯ d_addã€‚</li></ol><h1 id="ç›®å½•ç´¢å¼•èŠ‚ç‚¹"><a href="#ç›®å½•ç´¢å¼•èŠ‚ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#ç›®å½•ç´¢å¼•èŠ‚ç‚¹"></a> ç›®å½•ç´¢å¼•èŠ‚ç‚¹</h1><h2 id="ç›®å½•ç´¢å¼•èŠ‚ç‚¹æ“ä½œ"><a href="#ç›®å½•ç´¢å¼•èŠ‚ç‚¹æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#ç›®å½•ç´¢å¼•èŠ‚ç‚¹æ“ä½œ"></a> ç›®å½•ç´¢å¼•èŠ‚ç‚¹æ“ä½œ</h2><p>ç›®å½•ç´¢å¼•èŠ‚ç‚¹çš„æ“ä½œæ¯”å¸¸è§„æ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹çš„æ“ä½œè¦å¤æ‚çš„å¤šã€‚åœ¨ minix ä¸­ï¼Œç”±å¯¹è±¡å®ä¾‹ minix_dir_inode_operations å’Œ minix_dir_operations å®šä¹‰ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span> <span class="title">minix_dir_inode_operations</span> =</span> &#123;</span><br><span class="line">    .create = minix_create,</span><br><span class="line">    .lookup = minix_lookup,</span><br><span class="line">    .link = minix_link,</span><br><span class="line">    .unlink = minix_unlink,</span><br><span class="line">    .symlink = minix_symlink,</span><br><span class="line">    .mkdir = minix_mkdir,</span><br><span class="line">    .rmdir = minix_rmdir,</span><br><span class="line">    .mknod = minix_mknod,</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">minix_dir_operations</span> =</span> &#123;</span><br><span class="line">    .llseek = generic_file_llseek,</span><br><span class="line">    .read = generic_read_dir,</span><br><span class="line">    .iterate = minix_readdir,</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (S_ISDIR(inode-&gt;i_mode))</span><br><span class="line">    &#123;</span><br><span class="line">        inode-&gt;i_op = &amp;minix_dir_inode_operations;</span><br><span class="line">        inode-&gt;i_fop = &amp;minix_dir_operations;</span><br><span class="line">        inode-&gt;i_mapping-&gt;a_ops = &amp;minix_aops;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><h2 id="ç›¸å…³å‡½æ•°"><a href="#ç›¸å…³å‡½æ•°" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#ç›¸å…³å‡½æ•°"></a> ç›¸å…³å‡½æ•°</h2><p>ç›®å½•ç´¢å¼•èŠ‚ç‚¹æ“ä½œçš„ç›¸å…³å‡½æ•°å¦‚ä¸‹æ‰€è¿°ã€‚</p><h3 id="åˆ›å»ºç´¢å¼•èŠ‚ç‚¹"><a href="#åˆ›å»ºç´¢å¼•èŠ‚ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#åˆ›å»ºç´¢å¼•èŠ‚ç‚¹"></a> åˆ›å»ºç´¢å¼•èŠ‚ç‚¹</h3><p>ç”± inode_operations çš„ create å­—æ®µï¼ˆå›è°ƒå‡½æ•°ï¼‰è¡¨ç¤ºã€‚æ­¤å‡½æ•°ç”± open() å’Œ creat() ç³»ç»Ÿè°ƒç”¨è°ƒç”¨ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li>åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†ç»“æ„ä¸­å¼•å…¥æ–°æ¡ç›®ã€‚ä¸è¦å¿˜è®°æ›´æ–°ç£ç›˜ä¸Šçš„ä½å›¾ã€‚</li><li>ä½¿ç”¨ä¼ å…¥å‡½æ•°çš„è®¿é—®æƒé™é…ç½®è®¿é—®æƒé™ã€‚</li><li>ä½¿ç”¨ mark_inode_dirty() å‡½æ•°å°†ç´¢å¼•èŠ‚ç‚¹æ ‡è®°ä¸ºè„ã€‚</li><li>ä½¿ç”¨ d_instantiate() å‡½æ•°å®ä¾‹åŒ–ç›®å½•æ¡ç›® (dentry)ã€‚</li></ol><h3 id="åˆ›å»ºç›®å½•"><a href="#åˆ›å»ºç›®å½•" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#åˆ›å»ºç›®å½•"></a> åˆ›å»ºç›®å½•</h3><p>ç”± mkdir å­—æ®µè¡¨ç¤ºï¼Œç”± mkdir() ç³»ç»Ÿè°ƒç”¨è°ƒç”¨ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li>è°ƒç”¨ create å­—æ®µå¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚</li><li>ä¸ºç›®å½•åˆ†é…ä¸€ä¸ªæ•°æ®å—ã€‚</li><li>åˆ›å»º <code>&quot;.&quot;</code> å’Œ <code>&quot;..&quot;</code> æ¡ç›®ã€‚</li></ol><h3 id="åˆ›å»ºé“¾æ¥"><a href="#åˆ›å»ºé“¾æ¥" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#åˆ›å»ºé“¾æ¥"></a> åˆ›å»ºé“¾æ¥</h3><p>ç”± link å­—æ®µè¡¨ç¤ºï¼Œç”± link() ç³»ç»Ÿè°ƒç”¨è°ƒç”¨ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li>å°†æ–°çš„ dentry ç»‘å®šåˆ°ç´¢å¼•èŠ‚ç‚¹ã€‚</li><li>é€’å¢ç´¢å¼•èŠ‚ç‚¹çš„ i_nlink å­—æ®µã€‚</li><li>ä½¿ç”¨ mark_inode_dirty() å‡½æ•°å°†ç´¢å¼•èŠ‚ç‚¹æ ‡è®°ä¸ºè„ã€‚</li></ol><h3 id="åˆ›å»ºç¬¦å·é“¾æ¥"><a href="#åˆ›å»ºç¬¦å·é“¾æ¥" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#åˆ›å»ºç¬¦å·é“¾æ¥"></a> åˆ›å»ºç¬¦å·é“¾æ¥</h3><p>ç”± symlink å­—æ®µè¡¨ç¤ºï¼Œç”± symlink() ç³»ç»Ÿè°ƒç”¨è°ƒç”¨ã€‚æ‰§è¡Œæ“ä½œä¸ link çš„å›è°ƒå‡½æ•°ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºæ­¤å‡½æ•°åˆ›å»ºçš„æ˜¯ç¬¦å·é“¾æ¥ã€‚</p><h3 id="åˆ é™¤é“¾æ¥"><a href="#åˆ é™¤é“¾æ¥" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#åˆ é™¤é“¾æ¥"></a> åˆ é™¤é“¾æ¥</h3><p>ç”± unlink å­—æ®µè¡¨ç¤ºï¼Œç”± unlink() ç³»ç»Ÿè°ƒç”¨è°ƒç”¨ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li>ä»ç‰©ç†ç£ç›˜ç»“æ„ä¸­åˆ é™¤ä½œä¸ºå‚æ•°ç»™å‡ºçš„ dentryã€‚</li><li>å°†æ¡ç›®æŒ‡å‘çš„ç´¢å¼•èŠ‚ç‚¹çš„ i_nlink è®¡æ•°å™¨å‡ä¸€ï¼Œå¦åˆ™è¯¥ç´¢å¼•èŠ‚ç‚¹å°†æ°¸è¿œä¸ä¼šè¢«åˆ é™¤ï¼ˆå¼•ç”¨è®¡æ•°æ— æ³•å‡åˆ° 0ï¼‰ã€‚</li></ol><h3 id="åˆ é™¤ç›®å½•"><a href="#åˆ é™¤ç›®å½•" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#åˆ é™¤ç›®å½•"></a> åˆ é™¤ç›®å½•</h3><p>ç”± rmdir å­—æ®µè¡¨ç¤ºï¼Œç”± rmdir() ç³»ç»Ÿè°ƒç”¨è°ƒç”¨ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li>æ‰§è¡Œ unlink å­—æ®µå¯¹åº”å›è°ƒå‡½æ•°å®Œæˆçš„æ“ä½œã€‚</li><li>ç¡®ä¿ç›®å½•ä¸ºç©ºï¼Œå¦åˆ™è¿”å› ENOTEMPTYã€‚</li><li>åŒæ—¶åˆ é™¤æ•°æ®å—ã€‚</li></ol><h3 id="åœ¨ç›®å½•ä¸­æœç´¢ç´¢å¼•èŠ‚ç‚¹"><a href="#åœ¨ç›®å½•ä¸­æœç´¢ç´¢å¼•èŠ‚ç‚¹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#åœ¨ç›®å½•ä¸­æœç´¢ç´¢å¼•èŠ‚ç‚¹"></a> åœ¨ç›®å½•ä¸­æœç´¢ç´¢å¼•èŠ‚ç‚¹</h3><p>ç”± lookup å­—æ®µè¡¨ç¤ºã€‚å½“éœ€è¦æœ‰å…³ä¸ç›®å½•ä¸­æ¡ç›®å…³è”çš„ç´¢å¼•èŠ‚ç‚¹çš„ä¿¡æ¯æ—¶ï¼Œä¼šé—´æ¥è°ƒç”¨æ­¤å‡½æ•°ã€‚æ­¤å‡½æ•°æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li>åœ¨ç”± dir æŒ‡ç¤ºçš„ç›®å½•ä¸­æœç´¢å…·æœ‰åç§° <code>dentry-&gt;d_name.name</code> çš„æ¡ç›®ã€‚</li><li>å¦‚æœæ‰¾åˆ°æ¡ç›®ï¼Œåˆ™è¿”å› NULL å¹¶ä½¿ç”¨ d_add() å‡½æ•°å°†ç´¢å¼•èŠ‚ç‚¹ä¸åç§°å…³è”ã€‚</li><li>å¦åˆ™ï¼Œè¿”å› ERR_PTRã€‚</li></ol><h3 id="éå†ç›®å½•ä¸­çš„æ¡ç›®"><a href="#éå†ç›®å½•ä¸­çš„æ¡ç›®" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#éå†ç›®å½•ä¸­çš„æ¡ç›®"></a> éå†ç›®å½•ä¸­çš„æ¡ç›®</h3><p>ç”± iterate å­—æ®µè¡¨ç¤ºï¼Œç”± readdir() ç³»ç»Ÿè°ƒç”¨è°ƒç”¨ã€‚</p><p>æ­¤å‡½æ•°è¿”å›ç›®å½•ä¸­çš„æ‰€æœ‰æ¡ç›®ï¼Œæˆ–è€…å½“ä¸ºå…¶åˆ†é…çš„ç¼“å†²åŒºä¸å¯ç”¨æ—¶ï¼Œä»…è¿”å›éƒ¨åˆ†æ¡ç›®ã€‚å¯èƒ½çš„è¿”å›å¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœå¯¹åº”çš„ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºæœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ™è¿”å›ä¸ç°æœ‰æ¡ç›®æ•°ç›¸ç­‰çš„æ•°å­—ã€‚</li><li>å°äºå®é™…æ¡ç›®æ•°çš„æ•°å­—ï¼Œå¯¹åº”çš„ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºä¸­æœ‰å¤šå°‘ç©ºé—´ï¼Œå°±è¿”å›å¤šå°‘ã€‚</li><li>0ï¼Œè¡¨ç¤ºæ²¡æœ‰æ›´å¤šæ¡ç›®å¯è¯»å–ã€‚</li></ol><p>æ­¤å‡½æ•°ä¼šè¿ç»­è°ƒç”¨ï¼ŒçŸ¥é“è¯»å–å®Œæ‰€æœ‰å¯ç”¨çš„æ¡ç›®ï¼Œå¹¶ä¸”è‡³å°‘ä¼šè°ƒç”¨ 2 æ¬¡ã€‚</p><ol><li>åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä»…è°ƒç”¨ä¸¤æ¬¡ï¼š<ul><li>ç¬¬ä¸€æ¬¡è°ƒç”¨è¯»å–æ‰€æœ‰æ¡ç›®å¹¶è¿”å›å®ƒä»¬çš„æ•°é‡ã€‚</li><li>ç¬¬äºŒæ¬¡è°ƒç”¨è¿”å› 0ï¼Œè¡¨ç¤ºæ²¡æœ‰å…¶ä»–æ¡ç›®å¯è¯»å–ã€‚</li></ul></li><li>å¦‚æœç¬¬ä¸€æ¬¡è°ƒç”¨æœªè¿”å›æ€»æ¡ç›®æ•°ï¼Œåˆ™ä¼šå¤šæ¬¡è°ƒç”¨è¯¥å‡½æ•°ã€‚</li></ol><p>æ­¤å‡½æ•°æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li>éå†å½“å‰ç›®å½•ä¸­çš„æ¡ç›®ï¼ˆdentryï¼‰ã€‚</li><li>å¯¹äºæ‰¾åˆ°çš„æ¯ä¸ª dentryï¼Œé€’å¢ <code>ctx-&gt;pos</code>ã€‚</li><li>å¯¹äºæ¯ä¸ªæœ‰æ•ˆçš„ dentryï¼ˆä¾‹å¦‚ï¼Œé™¤äº† 0 ä¹‹å¤–çš„ç´¢å¼•èŠ‚ç‚¹ï¼‰ï¼Œè°ƒç”¨ dir_emit() å‡½æ•°ã€‚</li><li>å¦‚æœ dir_emit() å‡½æ•°è¿”å›éé›¶å€¼ï¼Œè¡¨ç¤ºç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºå·²æ»¡ï¼Œå‡½æ•°å°†è¿”å›ã€‚</li></ol><p>dir_emit() å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ctxï¼šç›®å½•éå†ä¸Šä¸‹æ–‡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ç»™ iterate å‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment">// nameï¼šæ¡ç›®çš„åç§°ã€‚</span></span><br><span class="line"><span class="comment">// namelenï¼šæ¡ç›®åç§°çš„é•¿åº¦ã€‚</span></span><br><span class="line"><span class="comment">// inoï¼šä¸æ¡ç›®å…³è”çš„ inode ç´¢å¼•èŠ‚ç‚¹å·ã€‚</span></span><br><span class="line"><span class="comment">// typeï¼šæ ‡å¿—æ¡ç›®ç±»å‹ï¼ŒDT_REGï¼ˆæ–‡ä»¶ï¼‰ã€DT_DIRï¼ˆç›®å½•ï¼‰ã€DT_UNKNOWNï¼ˆæœªçŸ¥ï¼‰ç­‰ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">dir_emit</span><span class="params">(<span class="keyword">struct</span> dir_context *ctx, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">int</span> namelen, u64 ino, <span class="type">unsigned</span> type)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> ctx-&gt;actor(ctx, name, namelen, ctx-&gt;pos, ino, type) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><h1 id="ä½å›¾æ“ä½œ"><a href="#ä½å›¾æ“ä½œ" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#ä½å›¾æ“ä½œ"></a> ä½å›¾æ“ä½œ</h1><p>å¤„ç†æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œç®¡ç†ä¿¡æ¯ï¼ˆå“ªä¸ªå—æ˜¯ç©ºé—²çš„æˆ–å¿™ç¢Œçš„ï¼Œå“ªä¸ªç´¢å¼•èŠ‚ç‚¹æ˜¯ç©ºé—²çš„æˆ–å¿™ç¢Œçš„ï¼‰ä½¿ç”¨ä½å›¾å­˜å‚¨ã€‚å› æ­¤éœ€è¦ä½¿ç”¨ä½æ“ä½œï¼ŒåŒ…æ‹¬ï¼š</p><ol><li>æœç´¢ç¬¬ä¸€ä¸ªä¸º 0 çš„ä½ï¼šè¡¨ç¤ºä¸€ä¸ªç©ºé—²çš„å—æˆ–ç´¢å¼•èŠ‚ç‚¹ã€‚</li><li>å°†ä½æ ‡è®°ä¸º 1ï¼šæ ‡è®°å¿™ç¢Œçš„å—æˆ–ç´¢å¼•èŠ‚ç‚¹ã€‚</li></ol><p>ä½å›¾æ“ä½œå¸¸è§çš„å‡½æ•°å¦‚ä¸‹ã€‚è¿™äº›å‡½æ•°å®šä¹‰åœ¨å†…æ ¸æºç  include/asm-generic/bitops/ ç›®å½•ä¸‹ï¼Œç‰¹åˆ«æ˜¯ find.h å’Œ atomic.h ä¸­ã€‚</p><ol><li>find_first_zero_bit()</li><li>find_first_bit()</li><li>set_bit()</li><li>clear_bit()</li><li>test_and_set_bit()</li><li>test_and_clear_bit()</li></ol><p>è¿™äº›å‡½æ•°é€šå¸¸æ¥æ”¶ä½å›¾çš„åœ°å€ï¼Œå¯èƒ½è¿˜æœ‰å…¶å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚å¦‚æœéœ€è¦ï¼Œè¿˜è¦æŒ‡å®šéœ€è¦æ¿€æ´»ï¼ˆè®¾ç½®ï¼‰æˆ–åœç”¨ï¼ˆæ¸…é™¤ï¼‰çš„ä½çš„ç´¢å¼•ã€‚</p><p>ä¸€ä¸ªä½¿ç”¨å®ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="built_in">map</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> array_map[NUM_BYTES];</span><br><span class="line"><span class="type">size_t</span> idx;</span><br><span class="line"><span class="type">int</span> changed;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åœ¨ 32 ä½æ•´æ•°ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸º 0 çš„ä½ã€‚ */</span></span><br><span class="line">idx = find_first_zero_bit(&amp;<span class="built_in">map</span>, <span class="number">32</span>);</span><br><span class="line">printk(KERN_ALERT <span class="string">&quot;ç¬¬ %zu ä½æ˜¯ç¬¬ä¸€ä¸ªä¸º 0 çš„ä½ã€‚\n&quot;</span>, idx);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åœ¨ NUM_BYTES å­—èŠ‚çš„æ•°ç»„ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸º 1 çš„ä½ã€‚ */</span></span><br><span class="line">idx = find_first_bit(array_map, NUM_BYTES * <span class="number">8</span>);</span><br><span class="line">printk(KERN_ALERT <span class="string">&quot;ç¬¬ %zu ä½æ˜¯ç¬¬ä¸€ä¸ªä¸º 1 çš„ä½ã€‚\n&quot;</span>, idx);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ¸…é™¤æ•´æ•°ä¸­çš„ç¬¬ idx ä½ã€‚</span></span><br><span class="line"><span class="comment"> * å‡è®¾ idx å°äºæ•´æ•°çš„ä½æ•°ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">clear_bit(idx, &amp;<span class="built_in">map</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æµ‹è¯•å¹¶è®¾ç½®æ•°ç»„ä¸­çš„ç¬¬ idx ä½ã€‚</span></span><br><span class="line"><span class="comment"> * å‡è®¾ idx å°äºæ•°ç»„çš„ä½æ•°ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">changed = __test_and_set_bit(idx, &amp;sbi-&gt;imap);</span><br><span class="line"><span class="keyword">if</span> (changed)</span><br><span class="line">    printk(KERN_ALERT <span class="string">&quot;%zu ä½å·²æ›´æ”¹\n&quot;</span>, idx);</span><br></pre></td></tr></table></div></figure><h1 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#æµç¨‹åˆ†æ"></a> æµç¨‹åˆ†æ</h1><h2 id="æ–‡ä»¶ç³»ç»Ÿæ•´ä½“è¿è¡Œæµç¨‹"><a href="#æ–‡ä»¶ç³»ç»Ÿæ•´ä½“è¿è¡Œæµç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#æ–‡ä»¶ç³»ç»Ÿæ•´ä½“è¿è¡Œæµç¨‹"></a> æ–‡ä»¶ç³»ç»Ÿæ•´ä½“è¿è¡Œæµç¨‹</h2><ol><li><p>åŠ è½½æ–‡ä»¶ç³»ç»Ÿçš„å†…æ ¸æ¨¡å—ï¼Œåœ¨ init ä¸­ï¼Œæ³¨å†Œéœ€è¦çš„ file_system_typeã€‚æ ¼å¼åŒ–è¿‡ç¨‹åœ¨å†…æ ¸ä»£ç æ²¡æœ‰ä»»ä½•ä½“ç°ã€‚</p></li><li><p>è°ƒç”¨ mount()ï¼ŒæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿï¼Œé€šè¿‡ file_system_type çš„ mount() å›è°ƒåŠ è½½å¯¹åº”çš„ super_blockã€‚</p></li><li><p>é€šè¿‡ super_block çš„ <code>s_op-&gt;alloc_inode()</code> åˆ†é…ä¸€ä¸ª inodeã€‚</p></li><li><p>åˆ†é… root çš„ dentryï¼Œè°ƒç”¨ <code>dentry-&gt;d_op</code> åˆå§‹åŒ– dentryã€‚inode_operation å’Œ dentry_operation éƒ½è¢«è®°å½•åœ¨ super_block ä¸­ï¼Œinode å’Œ dentry å„è‡ªåœ¨åˆå§‹åŒ–æ—¶æ‹·è´äº†è¯¥æŒ‡é’ˆã€‚</p></li><li><p>è®¾ç½®å¯¹åº”çš„æŒ‚è½½ç‚¹ï¼Œmount è¿‡ç¨‹å®Œæˆã€‚</p></li><li><p>åº”ç”¨ç¨‹åº open æ–‡ä»¶ï¼Œä»æŒ‡å®šè·¯å¾„ä¸€çº§ä¸€çº§å‘ä¸‹è¯»å–å¯¹åº”çš„ dentryï¼Œç›´åˆ°æ‰¾åˆ°éœ€è¦çš„æ–‡ä»¶çš„ dentryã€‚æŸ¥æ‰¾æ—¶ä¼˜å…ˆä» dentry çš„å…¨å±€å”¯ä¸€å“ˆå¸Œè¡¨ä¸ŠæŸ¥ã€‚å¦‚æœå“ˆå¸Œè¡¨æ²¡æœ‰æ•°æ®ï¼Œåˆ™è°ƒç”¨ <code>inode-&gt;i_op-&gt;lookup()</code> æŸ¥æ‰¾ã€‚å¦‚æœæœ€åå‘ç°æ²¡æœ‰è¿™æ ·çš„æ–‡ä»¶ï¼Œåˆ™å¯èƒ½è°ƒç”¨ <code>inode-&gt;i_op-&gt;atomic_open()</code> å’Œ <code>inode-&gt;i_op-&gt;create()</code>ã€‚åœ¨ç¡®ä¿æœ‰æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ <code>file-&gt;f_op-&gt;open()</code> æ¥æ‰“å¼€æ–‡ä»¶ã€‚file çš„ address_space å’Œ f_op ç”± inode èµ‹äºˆã€‚</p></li><li><p>read æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶åŠ äº†èŒƒå›´é”ï¼Œåˆ™éœ€åˆ¤æ–­æ˜¯å¦æœ‰å†²çªï¼Œç„¶åè°ƒç”¨ <code>file-&gt;f_op-&gt;read()</code> æˆ–è€… <code>file-&gt;f_op-&gt;read_iter()</code>ã€‚</p></li><li><p>write æ–‡ä»¶ã€‚å¦‚æœæ–‡ä»¶åŠ äº†èŒƒå›´é”ï¼Œåˆ™éœ€åˆ¤æ–­æ˜¯å¦æœ‰å†²çªï¼Œç„¶åè°ƒç”¨ <code>file-&gt;f_op-&gt;write()</code> æˆ–è€… <code>file-&gt;f_op-&gt;write_iter()</code>ã€‚</p></li><li><p>close æ–‡ä»¶ï¼Œå…ˆè°ƒç”¨ <code>file-&gt;f_op-&gt;flush()</code> åˆ·æ•°æ®ï¼Œç„¶åè¿›è¡Œå¼‚æ­¥å…³é—­æ“ä½œã€‚</p></li></ol><blockquote><p>å¦‚æœå½“å‰è¿›ç¨‹ä¸åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸”ä¸æ˜¯ kthread çº¿ç¨‹ï¼Œå°†è¯¥æ–‡ä»¶çš„ close() æ“ä½œæ³¨å†Œåˆ° current-&gt;task_works ä¸­ã€‚å¦åˆ™ï¼Œå°†è¯¥æ–‡ä»¶çš„ close() æ“ä½œæ³¨å†Œåˆ°å…¨å±€çš„ delayed_fput_work ä¸­ã€‚æœ€ç»ˆï¼Œä¸¤ä¸ªå¼‚æ­¥çº¿ç¨‹ä¼šè°ƒåˆ°ç›¸åŒçš„å›æ”¶ä»£ç ä¸­æ¥ã€‚å¦‚æœæ–‡ä»¶è®¾ç½®äº† FASYNC æ ‡å¿—ï¼Œè°ƒç”¨ <code>file-&gt;f_op-&gt;fasync()</code> å‡½æ•°ï¼Œå¦åˆ™è°ƒç”¨ <code>file-&gt;f_op-&gt;release()</code> å‡½æ•°ã€‚</p></blockquote><ol start="10"><li>è°ƒç”¨ umount()ï¼Œå¸è½½æ–‡ä»¶ç³»ç»Ÿï¼Œè§¦å‘ <code>super_block-&gt;s_op-&gt;kill_sb()</code> å›è°ƒã€‚</li></ol><h2 id="path-lookup-è¿‡ç¨‹"><a href="#path-lookup-è¿‡ç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#path-lookup-è¿‡ç¨‹"></a> path lookup è¿‡ç¨‹</h2><p>path lookup æ˜¯é€šè¿‡ç”¨æˆ·ä¼ é€’çš„ä¸€ä¸ªç»å¯¹æˆ–ç›¸å¯¹è·¯å¾„ï¼Œæ¥æ‰¾åˆ°å¯¹åº”æ–‡ä»¶çš„ inode çš„è¿‡ç¨‹ã€‚å…¸å‹çš„åº”ç”¨å¦‚ open() å’Œ mount() çš„æŸ¥æ‰¾ã€‚</p><p><strong>path lookup æ€»å…±å¯åˆ†ä¸º ref-walk å’Œ rcu-walk ä¸¤ç§æ¨¡å¼ã€‚</strong></p><p>RCU æ¨¡å¼å¯¹é”çš„äº‰ç”¨æ›´å°‘ï¼Œå¹¶å‘æ›´å¥½ï¼Œä½†ä¸é€‚åˆæ‰€æœ‰åœºæ™¯ï¼ˆå› ä¸º RCU å¯èƒ½ä¼šå¯¼è‡´è¿›ç¨‹ç¡çœ ï¼‰ã€‚ref æ¨¡å¼æ˜¯ä¼ ç»Ÿçš„ path lookup æ–¹å¼ï¼Œä¸å®¹æ˜“å¤±è´¥ã€‚</p><p>RCU æ¨¡å¼ä¸ºäº†æ£€æµ‹ dentry çš„ä¿®æ”¹ï¼ˆrenameï¼‰å¸¦æ¥çš„æŸ¥è¯¢å¤±è´¥ï¼Œæ¯æ¬¡æŸ¥è¯¢éƒ½ä¼šè®°å½• dentry-&gt;d_seqï¼Œåœ¨æŸ¥è¯¢ç»“æŸåä¼šæ£€æµ‹å½“å‰ dentry å’Œçˆ¶ç›®å½• dentry çš„ d_seq æ˜¯å¦æ”¹å˜ã€‚é’ˆå¯¹ ref æ¨¡å¼ï¼Œæ¯æ¬¡éƒ½ä¼šé”ä½å½“å‰ dentry çš„ d_lockï¼Œåœ¨æˆåŠŸæŸ¥è¯¢åˆ°éœ€è¦çš„ dentry åï¼Œä¼šå°†å…¶å¼•ç”¨è®¡æ•°åŠ ä¸€ã€‚</p><p>å½“ä»å½“å‰ç›®å½•è·³è½¬åˆ°ä¸‹ä¸€å±‚ç›®å½•æ—¶ï¼ŒRCU æ¨¡å¼ä¼šä¸¢å¼ƒæ‰åŸæ¥çš„çˆ¶ç›®å½•çš„ d_seq è®°å½•ï¼ˆå› ä¸ºä¸ç”¨å…³å¿ƒç¥–çˆ¶ç›®å½•çš„å¼•ç”¨è®¡æ•°ï¼‰ï¼Œè€Œ ref æ¨¡å¼åˆ™ä¼šä¸¢å¼ƒå¯¹å½“å‰ç›®å½•çš„å¼•ç”¨ã€‚</p><h2 id="mount-è¿‡ç¨‹"><a href="#mount-è¿‡ç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mount-è¿‡ç¨‹"></a> mount è¿‡ç¨‹</h2><p>mount ç³»ç»Ÿè°ƒç”¨å®šä¹‰å¦‚ä¸‹ã€‚æ›´å¤šç»†èŠ‚å‚è€ƒåšå®¢ <span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.csdn.net/bingyu880101/article/details/50481507">https://blog.csdn.net/bingyu880101/article/details/50481507</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>ã€‚</p><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mount.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// sourceï¼šè¦æŒ‚ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿçš„åå­—ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè®¾å¤‡åã€‚</span></span><br><span class="line"><span class="comment">// targetï¼šæ–‡ä»¶ç³»ç»Ÿè¦æŒ‚åœ¨çš„ç›®æ ‡ç›®å½•ã€‚</span></span><br><span class="line"><span class="comment">// filesystemtypeï¼šæŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œå¦‚ &quot;ext4&quot;ã€&quot;btrfs&quot;ã€&quot;msdos&quot;ã€&quot;proc&quot;ã€&quot;nfs&quot;ã€&quot;iso9660&quot;ã€&quot;vfat&quot; ç­‰ã€‚</span></span><br><span class="line"><span class="comment">// mountflagsï¼šæŒ‡å®šæ–‡ä»¶ç³»ç»Ÿçš„è¯»å†™è®¿é—®æ ‡å¿—ã€‚</span></span><br><span class="line"><span class="comment">// dataï¼šæ–‡ä»¶ç³»ç»ŸæŒæœ‰çš„å‚æ•°ã€‚</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mount</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *source, <span class="type">const</span> <span class="type">char</span> *target, <span class="type">const</span> <span class="type">char</span> *filesystemtype, <span class="type">unsigned</span> <span class="type">long</span> mountflags, <span class="type">const</span> <span class="type">void</span> *_Nullable data)</span>;</span><br></pre></td></tr></table></div></figure><p>mount çš„è¿‡ç¨‹å…·ä½“å¦‚ä¸‹ï¼š</p><ol><li><p>æ ¹æ® dir_nameï¼Œè¿›è¡Œ path lookupã€‚</p></li><li><p>æ ¹æ® typeï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ file_system_typeã€‚</p></li><li><p>æ‹¿åˆ° file_system_typeï¼Œè°ƒ mount() å›è°ƒï¼Œå°† dev_name å¯¹åº”çš„å—è®¾å¤‡å’Œ data ä¼ é€’ç»™å®ƒï¼Œmount() å›è°ƒå°†å»ºç«‹å¥½å¯¹åº”çš„ root çš„ dentryï¼Œsuper_block å’Œ root çš„ inodeã€‚</p></li><li><p>æ–°å»º mount ç»“æ„ä½“ï¼Œå°† dentry ä¸ mount ç»“æ„ä½“ç»‘å®šã€‚</p></li><li><p>åœ¨ mount_hashtable ä¸­ä¸æ–­æŸ¥æ‰¾ã€‚å¦‚æœæ‰¾åˆ°åŒ¹é…çš„ mount ç»“æ„ä½“ï¼Œè¯´æ˜è¯¥æŒ‚è½½ç‚¹å·²è¢«ä½¿ç”¨ï¼Œéœ€è¦ç»§ç»­æŸ¥æ‰¾ã€‚ç›´åˆ°æ‰¾ä¸åˆ°å¯¹åº”çš„ mount ç»“æ„ä½“ï¼Œè¯´æ˜å½“å‰æŒ‚è½½ç‚¹å°šæœªè¢«å ç”¨ï¼Œç³»ç»Ÿå¯ä»¥åœ¨æ­¤æŒ‚è½½æ–°çš„æ–‡ä»¶ç³»ç»Ÿã€‚æ­¤æ—¶ç³»ç»Ÿæœ€åå¾—åˆ°æœ‰æ•ˆçš„ mount ç»“æ„ä½“å°±ä½œä¸ºå½“å‰ mount ç»“æ„ä½“çš„çˆ¶æŒ‚è½½ç‚¹ï¼Œå¾—åˆ°çš„ dentry ä½œä¸ºå½“å‰ mount ç»“æ„ä½“çš„ mountpointã€‚</p></li><li><p>å»ºç«‹çˆ¶ mount ä¸å½“å‰ mount çš„è”ç³»ï¼Œå»ºç«‹ mountpoint ä¸å½“å‰ mount çš„è”ç³»ã€‚</p></li></ol><h2 id="open-è¿‡ç¨‹"><a href="#open-è¿‡ç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#open-è¿‡ç¨‹"></a> open è¿‡ç¨‹</h2><p>open ä¸»è¦çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p>åˆ†æ open ä¼ è¿›æ¥çš„ flagsã€‚</p></li><li><p>åˆ†é… fdã€‚</p></li><li><p>å¯¹æ–‡ä»¶æ‰§è¡Œ openã€create ç­‰æ“ä½œï¼ˆè§†å…·ä½“æƒ…å†µè€Œå®šï¼‰ã€‚</p></li><li><p>é€šçŸ¥ç›‘æ§æ–‡ä»¶æ‰“å¼€çš„å›è°ƒã€‚</p></li><li><p>å°†æ‰“å¼€å¾—åˆ°çš„ file ç»“æ„ä½“æ”¾åˆ° fdtable çš„ fd æ•°ç»„ä¸­ã€‚</p></li></ol><p>open å…·ä½“æŸ¥æ‰¾æ–‡ä»¶ inode çš„è¿‡ç¨‹ï¼Œå³æ˜¯ path lookup çš„è¿‡ç¨‹ã€‚</p><p><code>file-&gt;f_op</code> æœ‰ä¸€ä¸ª atomic_open() å›è°ƒï¼Œå…è®¸æ–‡ä»¶ç³»ç»Ÿä»¥ä¸åŸå­çš„æ–¹å¼æŸ¥æ‰¾æŸä¸ªæ–‡ä»¶ã€‚å¦‚æœè¯¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™æ–‡ä»¶ç³»ç»Ÿå°è¯•åˆ›å»ºè¯¥æ–‡ä»¶ï¼ˆå½“è®¾ç½®äº† O_CREAT æ ‡å¿—æ—¶ï¼‰ã€‚æ•…åœ¨å°è¯•æŸ¥æ‰¾å’Œåˆ›å»ºæ–‡ä»¶æ—¶ï¼ŒVFS ä¼˜å…ˆä½¿ç”¨ atomic_open()ï¼Œå½“æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒè¯¥æ“ä½œæ—¶ï¼Œæ‰å›å½’åˆ°å…ˆ lookupï¼ŒæŸ¥æ‰¾å¤±è´¥å† create çš„æ¨¡å¼ã€‚</p><h2 id="é€šç”¨-read-æµç¨‹"><a href="#é€šç”¨-read-æµç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#é€šç”¨-read-æµç¨‹"></a> é€šç”¨ read æµç¨‹</h2><p>è¿™é‡Œä¸è€ƒè™‘æ–‡ä»¶çš„å¼‚æ­¥è¯»å†™ï¼Œä¹Ÿå°±æ˜¯ aio ç³»åˆ—çš„ read å’Œ writeã€‚</p><p>æ‰€è°“é€šç”¨ï¼Œæ˜¯æŒ‡æŸäº›æ–‡ä»¶ç³»ç»Ÿä¸å•ç‹¬å†™ read() æˆ– read_iter() å›è°ƒï¼Œè€Œæ˜¯è°ƒ VFS å®ç°çš„é»˜è®¤ read å‡½æ•° generic_file_read_iter()ã€‚</p><p>åœ¨è¯»ç¼“å­˜çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸å…è®¸è¿›ç¨‹é˜»å¡ï¼Œä¸”éœ€è¦çš„æ•°æ®ä¸åœ¨å†…å­˜ä¸­ï¼Œä¼šç«‹å³è¿”å›å¤±è´¥ã€‚</p><p>è¯»åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯ direct_ioï¼Œå¦ä¸€ç§æ˜¯èµ° address_spaceã€‚</p><p>å¦‚æœèµ° direct_ioï¼š</p><ol><li><p>å¦‚æœè¿™ä¸ª read æ“ä½œä¸èƒ½é™·å…¥ç­‰å¾…ï¼ˆNO_WAITï¼‰ï¼Œä¸”è¦è¯»å–çš„æ–‡ä»¶èŒƒå›´å†…æœ‰ç¼“å­˜ï¼Œåˆ™è¿”å› -EAGAINã€‚</p></li><li><p>å¦åˆ™ï¼Œå…ˆé€šè¿‡ address_space å°†ç¼“å­˜çš„æ•°æ®åˆ·ä¸‹å»ã€‚</p></li><li><p>å†è°ƒç”¨ <code>mapping-&gt;a_ops-&gt;direct_io()</code> è¯»å–æ•°æ®ã€‚</p></li></ol><p>å¦‚æœèµ° address_spaceï¼Œç”¨æˆ·éœ€è¦çš„æ•°æ®é‡å¯èƒ½å¾ˆå¤§ï¼Œéœ€è¦ä¸€é¡µä¸€é¡µåœ°å¤„ç†ã€‚å¯¹äºæ¯ä¸€é¡µï¼š</p><ol><li><p>ä» address_space ä¸­æŸ¥æ‰¾å¯¹åº” pageã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ä»¥åŒæ­¥æ–¹å¼è¿›è¡Œé¢„è¯»ï¼Œå¦‚æœè¿™æ ·ä¹Ÿæ‹¿ä¸åˆ° pageï¼Œè·³è½¬åˆ°æ­¥éª¤ 6ã€‚</p></li><li><p>å¦‚æœæ‹¿åˆ°çš„ page å¸¦æœ‰ readahead æ ‡è®°ï¼Œè¯´æ˜æˆ‘ä»¬éœ€è¦è‡ªå·±é¢„è¯»ä¸€äº›é¡µé¢ã€‚</p></li><li><p>å¦‚æœ page å¸¦æœ‰ uptodate æ ‡å¿—ï¼Œåˆ™è·³åˆ°ä¸‹ä¸€æ­¥ï¼Œå¦åˆ™ï¼š</p><ul><li>ç­‰å¾… page çš„ lock æ ‡å¿—è¢«æ¸…é›¶ï¼ˆç­‰å¾… page è¢«è§£é”ï¼‰ã€‚</li><li>å¦‚æœ page å¸¦æœ‰ uptodate æ ‡å¿—ï¼Œåˆ™è·³è½¬åˆ°æ­¥éª¤ 4ã€‚</li><li>ç°åœ¨ï¼Œæ–‡ä»¶å¯èƒ½è¢« truncate äº†ï¼Œéœ€è¦è¿›è¡Œæ£€æŸ¥ã€‚å¦‚æœæœ‰ <code>mapping-&gt;a_ops-&gt;is_partially_uptodate()</code> å›è°ƒï¼Œä¸”é€šè¿‡è¯¥å›è°ƒå‘ç°æˆ‘ä»¬éœ€è¦è¯»çš„èŒƒå›´å†…æ•°æ®æ˜¯ uptodate çš„ï¼Œåˆ™è·³è½¬åˆ°æ­¥éª¤ 4ï¼Œå¦åˆ™è·³è½¬åˆ°æ­¥éª¤ 5ã€‚</li></ul></li><li><p>ç°åœ¨ï¼Œæ•°æ®æ˜¯ç¡®ä¿åœ¨å†…å­˜ä¸­çš„ï¼Œä¸”æ˜¯ uptodate çš„ã€‚å°† page é‡Œé¢çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·çš„ buffer é‡Œé¢ï¼Œç„¶åè¿›è¡Œä¸‹ä¸ª page çš„å¤„ç†æˆ–è€…é€€å‡ºå¾ªç¯ã€‚</p></li><li><p>åˆ°è¿™ä¸€æ­¥ï¼Œè¯´æ˜æœ‰ pageï¼Œä½†æ•°æ®æ²¡æœ‰ uptodateã€‚</p><ul><li>å¦‚æœ <code>page-&gt;mapping</code> ä¸ºç©ºï¼Œåˆ™è¯´æ˜è¿™æ•´ä¸ªé¡µéƒ½è¢« truncate äº†ï¼Œå³å¯ä»¥è€ƒè™‘ä¸‹ä¸€å—é¡µé¢çš„å¤„ç†ï¼ˆè¿›å…¥ continueï¼‰ã€‚</li><li>æ¥ä¸‹æ¥éœ€è¦è°ƒç”¨ <code>mapping-&gt;a_ops-&gt;readpage()</code> è¯»å–æ•°æ®ã€‚</li><li>å›åˆ°æ­¥éª¤ 4ï¼Œè¿›è¡Œæ•°æ®æ‹·è´ã€‚</li></ul></li><li><p>åˆ°è¿™ä¸€æ­¥ï¼Œè¯´æ˜æ²¡æœ‰å¯¹åº”çš„ pageï¼Œéœ€è¦å…ˆåˆ†é…ä¸€ä¸ª pageï¼ŒåŠ å…¥åˆ° address_space å’Œ lru ç»“æ„ä¸­ï¼Œç„¶åå›åˆ°æ­¥éª¤ 5ã€‚</p></li></ol><h2 id="é€šç”¨-write-æµç¨‹"><a href="#é€šç”¨-write-æµç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#é€šç”¨-write-æµç¨‹"></a> é€šç”¨ write æµç¨‹</h2><p>write æ“ä½œä¼šæ›´æ–° inode çš„ mtime å’Œ ctimeï¼Œä»¥åŠ versionã€‚åŒç†åˆ†ä¸º direct_io å’Œ address_space ä¸¤ç§ã€‚</p><p>å¦‚æœèµ° direct_ioï¼š</p><ol><li><p>å¦‚æœ address_space ä¸­ç¼“å­˜æœ‰è¦å†™å…¥èŒƒå›´çš„æ•°æ®ï¼Œä¸”å½“å‰è¿›ç¨‹ä¸èƒ½é˜»å¡ï¼Œåˆ™ç«‹å³è¿”å›é”™è¯¯ã€‚</p></li><li><p>å¦åˆ™ï¼Œå…ˆé€šè¿‡ address_space å°†ç¼“å­˜çš„æ•°æ®åˆ·ä¸‹å»ã€‚</p></li><li><p>ç°åœ¨å¤„ç†ç¼“å­˜æ•°æ®çš„å…¶ä»–é—®é¢˜ã€‚å¯¹äºå¤„äº write èŒƒå›´å†…çš„æ¯ä¸€ä¸ªè¢«ç¼“å­˜çš„ page è€Œè¨€ï¼š</p><ul><li>é¦–å…ˆï¼Œç¡®ä¿ page çš„æ•°æ®è¢«åˆ·åˆ°äº†ç£ç›˜ä¸Šï¼ˆä¸Šä¸€æ­¥å·²ç»ç¡®ä¿äº†è¿™ä¸€æ­¥ï¼‰ã€‚</li><li>å¦‚æœè¿™ä¸ª page åšäº† mmapï¼Œå–æ¶ˆè¿™ä¸€é¡µçš„ mmapã€‚</li><li>æ¥ä¸‹æ¥å°†è¿™ä¸ª page ä» address_page ä¸­å–ä¸‹ï¼Œåˆ†ä¸ºä¸¤æ­¥ï¼š<ul><li>å¦‚æœè¿™ä¸ªé¡µæ˜¯ dirty çš„è¯ï¼Œå…ˆè°ƒç”¨ <code>mapping-&gt;a_ops-&gt;launder_page()</code> å°†è„æ•°æ®åˆ·ä¸‹å»ã€‚è¿™ä¸€å›è°ƒä¸ writepage() å›è°ƒçš„ä¸åŒåœ¨äºï¼Œå®ƒä¸å…è®¸æ–‡ä»¶ç³»ç»Ÿé€šè¿‡ redirty çš„æ–¹å¼è·³è¿‡å¯¹è¿™ä¸€é¡µçš„ flush æ“ä½œã€‚</li><li>æ¥ä¸‹æ¥å°† page ä» address_page ä¸­å–ä¸‹ï¼Œç„¶åè°ƒç”¨ <code>mapping-&gt;a_ops-&gt;freepage()</code> é‡Šæ”¾æ‰è¿™ä¸€ pageã€‚</li></ul></li></ul></li><li><p>æ¥ä¸‹æ¥ï¼Œè°ƒç”¨ <code>mapping-&gt;a_ops-&gt;direct_io()</code> å†™æ•°æ®ã€‚</p></li><li><p>ç„¶åï¼Œç»§ç»­è°ƒç”¨æ­¥éª¤ 3 æ¥åˆ·ä¸€æ¬¡ pageã€‚è¿™æ˜¯å› ä¸ºå¯èƒ½æœ‰å…¶ä»–è¿›ç¨‹é¢„è¯»äº†è¿™ä¸€éƒ¨åˆ†çš„æ•°æ®ï¼Œæˆ–è€…å› ä¸º mmap äº†ï¼Œç„¶ååœ¨è®¿é—®æ—¶å‡ºç° page fault å¯¼è‡´è¿™ä¸€éƒ¨åˆ†çš„æ•°æ®è¢«æ‹‰è¿›æ¥äº†ã€‚</p></li><li><p>å¦‚æœ direct_io è°ƒç”¨å¤±è´¥äº†ï¼Œåˆ™é€šè¿‡å†™ Cacheã€åˆ· Cacheã€å†æ— æ•ˆåŒ– Cache çš„æ–¹å¼å†™æ•°æ®ã€‚</p><ul><li>å†™ Cacheã€‚å¯¹äºå†™å…¥èŒƒå›´å†…çš„æ¯ä¸€é¡µï¼š<ul><li>è°ƒç”¨ <code>mapping-&gt;a_ops-&gt;write_begin()</code>ï¼Œé€šçŸ¥æ–‡ä»¶ç³»ç»Ÿå‡†å¤‡å¾€ page ä¸Šæ•°æ®äº†ã€‚</li><li>kmap page åï¼Œå°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ° page ä¸Šï¼Œç„¶å kunmap pageï¼Œåˆ· tlbã€‚</li><li>è°ƒç”¨ <code>mapping-&gt;a_ops-&gt;write_end()</code>ï¼Œé€šçŸ¥æ–‡ä»¶ç³»ç»Ÿå¾€ page ä¸Šå†™æ•°æ®çš„è¿‡ç¨‹ç»“æŸã€‚</li><li>åˆ¤æ–­è„æ•°æ®æ˜¯å¦è¶…è¿‡æŸä¸€é˜ˆå€¼ï¼Œä»¥å†³å®šæ˜¯å¦éœ€è¦åå°åˆ·æ•°æ®ä¸‹å»ã€‚</li></ul></li><li>åˆ· Cache å’Œæ— æ•ˆåŒ– Cache çš„è¿‡ç¨‹ä¸æ­¥éª¤ 2ã€3 ç±»ä¼¼ã€‚</li></ul></li><li><p>è‡³æ­¤ï¼Œdirect_io çš„è¿‡ç¨‹ç»“æŸã€‚</p></li></ol><p>å¦‚æœæ˜¯æ™®é€šçš„å†™ Cacheï¼Œè€Œä¸æ˜¯ direct_ioï¼Œåˆ™ä¸ä¸Šè¿°æ­¥éª¤ 6 çš„å†™ Cache æ­¥éª¤ç›¸åŒã€‚</p><p>å¦‚æœå†™å…¥æ•°æ®æˆåŠŸï¼Œä¸”ç”¨æˆ·æŒ‡å®šäº†éœ€è¦ fsyncï¼Œåˆ™é€šè¿‡ <code>file-&gt;f_op-&gt;fsync()</code> å›è°ƒå°†æ›´æ–°çš„æ•°æ®åˆ·ä¸‹å»ã€‚</p><h2 id="address_space-åˆ·æ•°æ®æµç¨‹"><a href="#address_space-åˆ·æ•°æ®æµç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#address_space-åˆ·æ•°æ®æµç¨‹"></a> address_space åˆ·æ•°æ®æµç¨‹</h2><ol><li><p>å…ˆè°ƒç”¨ <code>mapping-&gt;a_ops-&gt;writepages</code> åˆ·æ•°æ®ã€‚</p></li><li><p>å¦‚æœ writepages å›è°ƒä¸å­˜åœ¨ï¼Œåªèƒ½ä½¿ç”¨ write_page å›è°ƒã€‚</p><ul><li>blk_start_plug()</li><li>å¯¹äºèŒƒå›´å†…çš„æ¯ä¸ª pageï¼š<ul><li>å¦‚æœè¦ç­‰å¾…æ‰€æœ‰ page å®Œæˆï¼ˆ<code>wbc-&gt;sync_mode == WB_SYNC_ALL</code>ï¼‰æˆ–è€…æ ‡è®°äº† <code>wbc-&gt;tagged_writepages</code>ï¼Œåˆ™å°† address_space ä¸­æ ‡è®°ä¸º PAGECACHE_TAG_DIRTY çš„é¡µé¢å†æ ‡è®°ä¸º PAGECACHE_TAG_TOWRITEã€‚åŸæ¥çš„ DIRTY æ ‡è®°ä¸å»æ‰ã€‚</li><li>å¦‚æœä¸Šä¸€æ­¥è®¾ç½®äº† TOWRITE æ ‡è®°ï¼Œåˆ™å†æ¬¡åœ¨ address_space ä¸­æœç´¢æ ‡è®°ä¸º TOWRITE çš„é‚£äº› pageï¼Œå¦åˆ™æœç´¢åœ¨ address_space ä¸­æ ‡è®°ä¸º DIRTY çš„å›è°ƒï¼ˆä»…åœ¨ç»™å®šçš„èŒƒå›´å†…æœç´¢ï¼‰ã€‚å¯¹äºæœç´¢åˆ°çš„ pageï¼š<ul><li>å¦‚æœ page çš„ï¼ˆä¸æ˜¯ address_space çš„ï¼‰DIRTY æ ‡è®°è¢«æ¸…æ‰äº†ï¼Œè¯´æ˜å…¶ä»–è¿›ç¨‹å…ˆåˆ·ä¸‹å»äº†ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¯¹è¿™ä¸ª page åšä»»ä½•æ“ä½œã€‚</li><li>å¦‚æœ page æœ‰ WRITEBACK æ ‡è®°ï¼Œå¦‚æœ <code>wbc-&gt;sync_mode != WB_SYNC_NONE</code>ï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾…è¿™ä¸ª page çš„ writeback æ“ä½œå®Œæˆã€‚</li><li>å¦åˆ™ï¼Œç”±å½“å‰è¿›ç¨‹è´Ÿè´£è°ƒç”¨ <code>mapping-&gt;a_op-&gt;writepage()</code> å›è°ƒåˆ·æ•°æ®ã€‚</li></ul></li></ul></li><li>blk_finish_plug()</li></ul></li><li><p>å¦‚æœå›è°ƒå‡½æ•°è¿”å›äº† -NOMEMï¼Œè¡¨ç¤ºå¯¹åº”å—è®¾å¤‡ç¹å¿™ã€‚æ­¤æ—¶å¦‚æœ <code>wbc-&gt;sync_mode == WB_SYNC_ALL</code>ï¼Œä»£è¡¨å¯ä»¥åœ¨è¿™é‡Œç­‰å¾…è®¾å¤‡åˆ·æ•°æ®ï¼Œå› æ­¤è°ƒç”¨ io_schedule() ç¨å¾®ç­‰å¾…ä¸€æ®µæ—¶é—´åå›åˆ°ç¬¬ä¸€æ­¥é‡è¯•ã€‚</p></li><li><p>æœç´¢ address_spaceï¼Œå¯¹äºèŒƒå›´å†…çš„æ¯ä¸ªæ ‡è®°ä¸º PAGECACHE_TAG_WRITEBACK çš„ pageï¼Œç­‰å¾… page çš„ writeback æ ‡è®°è¢«æ¸…ç©ºã€‚</p></li></ol><blockquote><p>æˆ‘ä»¬å¹¶æ²¡æœ‰è®¾ç½® address_space çš„ PAGECACHE_TAG_WRITEBACK æ ‡å¿—ï¼Œä½†æ˜¯åœ¨ç­‰å¾…æ•°æ®è¢«åˆ·ä¸‹å»æ—¶ï¼Œå´æ˜¯æœç´¢çš„è¯¥æ ‡å¿—ã€‚å…¶å® PAGECACHE_TAG_WRITEBACK æ ‡å¿—æ˜¯è¢« <code>a_op-&gt;readpage()</code> æˆ– <code>a_op-&gt;readpages()</code> å›è°ƒå‡½æ•°è®¾ç½®çš„ã€‚</p></blockquote><h2 id="ç­‰å¾…-page-æ ‡å¿—æµç¨‹"><a href="#ç­‰å¾…-page-æ ‡å¿—æµç¨‹" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#ç­‰å¾…-page-æ ‡å¿—æµç¨‹"></a> ç­‰å¾… page æ ‡å¿—æµç¨‹</h2><p>ç­‰å¾… page æ ‡å¿—è¢«æ¸…é›¶ï¼Œè¿™æ˜¯å¸¸è§çš„æ“ä½œã€‚ä¾‹å¦‚ç­‰å¾… page çš„ writeback æ ‡å¿—è¢«æ¸…é›¶ï¼Œè¡¨ç¤º page è¢«å†™ä¸‹å»äº†ã€‚</p><p>page çš„ç­‰å¾…æœºåˆ¶æ˜¯ç”¨å“ˆå¸Œè¡¨å®Œæˆçš„ï¼Œåå­—æ˜¯ page_wait_tableï¼Œå…± 256 æ ¹é“¾è¡¨ï¼Œä»¥ page çš„åœ°å€ä½œä¸ºé”®ï¼ˆKeyï¼‰ã€‚</p><ol><li><p>æ¯æ¬¡éœ€è¦ç­‰å¾… page çš„æŸä¸ªæ ‡å¿—ä½è¢«æ¸…é›¶æ—¶ï¼Œåœ¨æ ˆä¸Šåˆ›å»ºä¸€ä¸ª wait_page_queueï¼Œä½œä¸º wait_queue çš„ä¸€ä¸ª entryã€‚</p></li><li><p>è®©è¯¥ entry å°†å…¥åˆ°å¯¹åº”çš„ wait_page_queue çš„å°¾éƒ¨ï¼Œç„¶åè°ƒç”¨ io_schedule() è¿›è¡Œç­‰å¾…ã€‚</p></li><li><p>å½“æœ‰å…¶ä»–è¿›ç¨‹ä»å“ˆå¸Œè¡¨çš„é“¾è¡¨ä¸Šå”¤é†’æŸä¸ª page æ—¶ï¼Œä¼šåˆ¤æ–­å½“å‰ entry ç­‰å¾…çš„ page æ˜¯å¦ä¸å°†è¦å”¤é†’çš„ page ç›¸åŒï¼Œç­‰å¾…æ ‡å¿—æ˜¯å¦ç›¸åŒã€‚è‹¥ç›¸åŒï¼Œä¼šå…ˆè°ƒç”¨ wait_page_queue çš„å›è°ƒå‡½æ•°å°†è¯¥ entry ä»é“¾è¡¨ä¸Šå–ä¸‹ï¼Œç„¶åå†å”¤é†’è¿›ç¨‹ã€‚</p></li><li><p>å½“ä»é˜»å¡ä¸­è¢«å”¤é†’åï¼Œåˆ¤æ–­æ ‡å¿—ä½æ˜¯å¦è¢«æ¸…é›¶ã€‚å¦‚æœæ˜¯ï¼Œåˆ™ä»ç­‰å¾…ä¸­è¿”å›ã€‚å¦‚æœæ˜¯è¢«ä¿¡å·æ‰“æ–­çš„ï¼Œä¹Ÿéœ€è¦è¿”å›ï¼Œå¦åˆ™å›åˆ°æ­¥éª¤ 2 é‡æ–°ç­‰å¾…ã€‚</p></li></ol><h2 id="plug-æœºåˆ¶"><a href="#plug-æœºåˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#plug-æœºåˆ¶"></a> plug æœºåˆ¶</h2><h3 id="plug"><a href="#plug" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#plug"></a> plug</h3><p>**plug æœºåˆ¶ç”¨äºç¼“å­˜åˆ·å‘é€šç”¨å—å±‚çš„æ•°æ®ã€‚**ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><ol><li><p>è°ƒç”¨ blk_start_plug() åˆå§‹åŒ–ä¸€ä¸ª plugã€‚</p></li><li><p>å¤„ç†å„ç§å¾€é€šç”¨å—å±‚è¯»å†™æ•°æ®çš„è¯·æ±‚ã€‚</p></li><li><p>è°ƒç”¨ blk_finish_plug() åˆ·æ•°æ®ã€‚</p></li></ol><p>plug ä»…æœ‰ä¸‰æ ¹é“¾è¡¨ï¼š</p><ol><li><p>listï¼šç”¨äºæ™®é€š request çš„é“¾è¡¨ï¼Œä¸Šé¢ä¸²ç€å•é˜Ÿåˆ—çš„ requestã€‚</p></li><li><p>mq_listï¼šç”¨äº multi-queue çš„é“¾è¡¨ï¼Œä¸Šé¢ä¸²ç€å¤šé˜Ÿåˆ—çš„ requestã€‚</p></li><li><p>cb_listï¼šåœ¨ unplug æ—¶éœ€è°ƒç”¨çš„å›è°ƒå‡½æ•°é“¾è¡¨ã€‚</p></li></ol><figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">blk_plug</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mq_list</span>;</span> <span class="comment">/* blk-mq requests */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">cb_list</span>;</span> <span class="comment">/* md requires an unplug callback */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> rq_count;</span><br><span class="line">	<span class="type">bool</span> multiple_queues;</span><br><span class="line">	<span class="type">bool</span> nowait;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">blk_plug_cb</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*blk_plug_cb_fn)</span><span class="params">(<span class="keyword">struct</span> blk_plug_cb *, <span class="type">bool</span>)</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">blk_plug_cb</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">	blk_plug_cb_fn callback;</span><br><span class="line">	<span class="type">void</span> *data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure><h3 id="blk_start_plug"><a href="#blk_start_plug" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#blk_start_plug"></a> blk_start_plug</h3><p>plug æ€»æ˜¯ä¸è¿›ç¨‹ç»‘åœ¨ä¸€èµ·çš„ï¼Œä¸€ä¸ªè¿›ç¨‹åªä¼šæœ‰ä¸€ä¸ª plugï¼Œä½† plug æœºåˆ¶å¯ä»¥é€’å½’è¿›å…¥ã€‚</p><ol><li><p>åˆ¤æ–­ <code>current-&gt;plug</code> æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œç›´æ¥è¿”å›ã€‚</p></li><li><p>åˆå§‹åŒ– plug çš„ä¸‰æ ¹é“¾è¡¨ã€‚</p></li><li><p>å°†å¤–ç•Œä¼ é€’è¿›æ¥çš„ plug ä½œä¸º <code>task-&gt;plug</code>ã€‚</p></li></ol><h3 id="blk_finish_plug"><a href="#blk_finish_plug" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#blk_finish_plug"></a> blk_finish_plug</h3><ol><li><p>å¦‚æœå¤–ç•Œä¼ é€’è¿›æ¥çš„ plug ä¸æ˜¯ <code>current-&gt;plug</code>ï¼Œåˆ™å¤„äºé€’å½’è°ƒç”¨ plug ä¸­ï¼Œç›´æ¥è¿”å›ã€‚</p></li><li><p>è°ƒç”¨ <code>plug-&gt;cb_list</code> ä¸­çš„æ‰€æœ‰å›è°ƒå‡½æ•°ã€‚</p></li><li><p>å°† mq_list çš„ request åˆ·ä¸‹å»ã€‚</p><ul><li>å¯¹ mq_list è¿›è¡Œæ’åºã€‚è¿™æ ·å±äºåŒä¸€ä¸ª blk_mq_ctx çš„é‚£äº› request å°±è¢«æ”¾åœ¨ä¸€èµ·äº†ã€‚</li><li>å°†å±äºåŒä¸€ä¸ª blk_mq_ctx çš„ request æœé›†åˆ°ä¸€æ ¹é“¾è¡¨ä¸Šï¼Œç»Ÿä¸€æäº¤åˆ°åŒä¸€ä¸ª blk_mq_hw_ctx ä¸­ã€‚</li></ul></li><li><p>å°† list çš„ request åˆ·ä¸‹å»ã€‚</p><ul><li>å¯¹ list è¿›è¡Œæ’åºã€‚è¿™æ ·å±äºåŒä¸€ä¸ª request_queue çš„é‚£äº› request å°±è¢«æ”¾åœ¨ä¸€èµ·äº†ã€‚</li><li>å°†å±äºåŒä¸€ä¸ª request_queue çš„ request æœé›†åˆ°ä¸€æ ¹é“¾è¡¨ä¸Šï¼Œç»Ÿä¸€æäº¤åˆ°å¯¹åº”çš„ request_queue ä¸­ã€‚</li></ul></li><li><p>è®¾ç½® <code>current-&gt;plug</code> ä¸º NULLã€‚</p></li></ol><h2 id="inode-super_block-å’Œ-dentry-çš„å¹¶å‘æŸ¥æ‰¾æœºåˆ¶"><a href="#inode-super_block-å’Œ-dentry-çš„å¹¶å‘æŸ¥æ‰¾æœºåˆ¶" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#inode-super_block-å’Œ-dentry-çš„å¹¶å‘æŸ¥æ‰¾æœºåˆ¶"></a> inodeã€super_block å’Œ dentry çš„å¹¶å‘æŸ¥æ‰¾æœºåˆ¶</h2><p>ä»¥ inode ä¸ºä¾‹ï¼Œç»å¸¸ä¼šé‡åˆ° malloc() ä¸€ä¸ª inode çš„æƒ…å†µã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå†…æ ¸ä¸­å¯¹äºä¸€ä¸ªæ–‡ä»¶åªå¯¹åº”ä¸€ä¸ª inodeï¼Œä½†å¦‚æœä¸¤ä¸ªè¿›ç¨‹åŒæ—¶æƒ³é’ˆå¯¹ç¡¬ç›˜ä¸Šçš„åŒä¸€ä¸ªæ–‡ä»¶åˆ›å»º inodeï¼Œå°±ä¼šé€ æˆå†²çªã€‚</p><p>å†…æ ¸ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°†æ‰€æœ‰çš„ inode æ”¾åœ¨äº† inode_hashtableï¼Œè¢«è‡ªæ—‹é”ä¿æŠ¤ã€‚å½“éœ€è¦ä¸€ä¸ªæ–‡ä»¶å¯¹åº”çš„ inode æ—¶ï¼š</p><ol><li><p>åŠ é”ï¼Œä»è¯¥å“ˆå¸Œè¡¨æŸ¥æ‰¾å¯¹åº”çš„ inodeï¼Œè§£é”ã€‚</p></li><li><p>è‹¥æ²¡æœ‰ï¼Œåˆ†é…ä¸€ä¸ª inodeã€‚</p></li><li><p>åŠ é”ã€‚</p></li><li><p>ä»è¯¥å“ˆå¸Œè¡¨ä¸­å†æ¬¡æŸ¥æ‰¾å¯¹åº”çš„ inodeã€‚</p></li><li><p>è‹¥ä¸å­˜åœ¨å¯¹åº”çš„ inodeï¼Œå°†æ–°çš„ inode åŠ å…¥åˆ°å“ˆå¸Œè¡¨ä¸­ã€‚</p></li><li><p>è§£é”ã€‚</p></li><li><p>è‹¥å­˜åœ¨å¯¹åº”çš„ inodeï¼Œå°†åˆšæ‰åˆ†é…çš„ inode é‡Šæ”¾æ‰ã€‚</p></li></ol><p>dentry å’Œ super_block ä¹Ÿæœ‰ç±»ä¼¼æœºåˆ¶ï¼Œè®¾è®¡å†…æ ¸çš„ä¸€ç³»åˆ—å‡½æ•° iget_locked()ã€sget()ã€d_alloc_parallel() ç­‰ã€‚</p><p>dentry æ¯”è¾ƒç‰¹æ®Šã€‚å®ƒå°†è¦æŸ¥æ‰¾çš„ dentry æ”¾åˆ°ä¸€ä¸ªåä¸º in_lookup_hashtable çš„å“ˆå¸Œè¡¨ä¸­ï¼Œè€Œå°†æ‰€æœ‰çš„ dentry æ”¾å…¥åˆ° dentry_hashtable ä¸­ã€‚</p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#å‚è€ƒæ–‡ç« "></a> å‚è€ƒæ–‡ç« </h1><ol><li><p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://linux-kernel-labs.github.io/refs/heads/master/">Linux Kernel Teaching â€” The Linux Kernel documentation</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p></li><li><p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://linux-kernel-labs-zh.xyz/">Linux å†…æ ¸æ•™å­¦ â€” Linux ç³»ç»Ÿå†…æ ¸æ–‡æ¡£</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p></li></ol></div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ æœ¬æ–‡ç»“æŸï¼Œæ„Ÿè°¢æ‚¨çš„é˜…è¯» ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">æœ¬æ–‡ä½œè€…: </span><span class="copyright-author__value"><a href="https://blog.davidingplus.cn">DavidingPlus</a></span></div><div class="copyright-link"><span class="copyright-link__name">æœ¬æ–‡é“¾æ¥: </span><span class="copyright-link__value"><a href="https://blog.davidingplus.cn/posts/68b0f3fd.html">https://blog.davidingplus.cn/posts/68b0f3fd.html</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">ç‰ˆæƒå£°æ˜: </span><span class="copyright-notice__value">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</span></div></div><div class="post-reward reward"><div class="reward-button">å¤§çˆ·ï¼Œèµä¸ªé“œæ¿å‘—~~~</div><div class="reward-qrcode"><span class="reward-qrcode-alipay"><img class="reward-qrcode-alipay__img" src="/images/reward/alipay.webp"><div class="reward-qrcode-alipay__text">æ”¯ä»˜å®</div></span><span class="reward-qrcode-wechat"><img class="reward-qrcode-wechat__img" src="/images/reward/wechat-pay.webp"><div class="reward-qrcode-wechat__text">å¾®ä¿¡</div></span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/posts/69869e7f.html"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">Block Device Drivers</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/posts/2d325f6a.html"><span class="paginator-prev__text">TeRMï¼šExtending RDMA-Attached Memory with SSD</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="utterances-container"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">æ–‡ç« ç›®å½•</span><span class="sidebar-nav-ov">ç«™ç‚¹æ¦‚è§ˆ</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Fvfs"><span class="toc-number">1.</span> <span class="toc-text">è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E6%A0%88%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">å­˜å‚¨æ ˆæ•´ä½“ç»“æ„</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿæ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#super_block"><span class="toc-number">3.1.</span> <span class="toc-text">super_block</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inode"><span class="toc-number">3.2.</span> <span class="toc-text">inode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#file"><span class="toc-number">3.3.</span> <span class="toc-text">file</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dentry"><span class="toc-number">3.4.</span> <span class="toc-text">dentry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">3.5.</span> <span class="toc-text">å…¶ä»–æ•°æ®ç»“æ„</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E5%92%8C%E6%B3%A8%E9%94%80%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">4.</span> <span class="toc-text">æ³¨å†Œå’Œæ³¨é”€æ–‡ä»¶ç³»ç»Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#struct-file_system_type"><span class="toc-number">4.1.</span> <span class="toc-text">struct file_system_type</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mount-%E5%92%8C-kill_sb"><span class="toc-number">4.2.</span> <span class="toc-text">mount() å’Œ kill_sb()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#super_block-2"><span class="toc-number">5.</span> <span class="toc-text">super_block</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#struct-super_block"><span class="toc-number">5.1.</span> <span class="toc-text">struct super_block</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#super_block-%E6%93%8D%E4%BD%9C"><span class="toc-number">5.2.</span> <span class="toc-text">super_block æ“ä½œ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#fill_super"><span class="toc-number">6.</span> <span class="toc-text">fill_super()</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E7%BC%93%E5%AD%98"><span class="toc-number">7.</span> <span class="toc-text">ç¼“å†²åŒºç¼“å­˜</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%92%8C%E6%9C%89%E7%94%A8%E7%9A%84%E5%AE%8F"><span class="toc-number">8.</span> <span class="toc-text">å‡½æ•°å’Œæœ‰ç”¨çš„å®</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#inode-2"><span class="toc-number">9.</span> <span class="toc-text">inode</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#struct-inode"><span class="toc-number">9.1.</span> <span class="toc-text">struct inode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inode-%E6%93%8D%E4%BD%9C"><span class="toc-number">9.2.</span> <span class="toc-text">inode æ“ä½œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-inode"><span class="toc-number">9.2.1.</span> <span class="toc-text">è·å– inode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E7%BA%A7%E5%9D%97%E6%93%8D%E4%BD%9C"><span class="toc-number">9.2.2.</span> <span class="toc-text">è¶…çº§å—æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inode_operations"><span class="toc-number">9.2.3.</span> <span class="toc-text">inode_operations</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mount"><span class="toc-number">10.</span> <span class="toc-text">mount</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#file-2"><span class="toc-number">11.</span> <span class="toc-text">file</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E6%96%87%E4%BB%B6%E7%B4%A2%E5%BC%95%E8%8A%82%E7%82%B9"><span class="toc-number">12.</span> <span class="toc-text">å¸¸è§„æ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#page-cache"><span class="toc-number">13.</span> <span class="toc-text">page cache</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#address_space"><span class="toc-number">14.</span> <span class="toc-text">address_space</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dentry-2"><span class="toc-number">15.</span> <span class="toc-text">dentry</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#struct-dentry"><span class="toc-number">15.1.</span> <span class="toc-text">struct dentry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dentry-%E6%93%8D%E4%BD%9C"><span class="toc-number">15.2.</span> <span class="toc-text">dentry æ“ä½œ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%B4%A2%E5%BC%95%E8%8A%82%E7%82%B9"><span class="toc-number">16.</span> <span class="toc-text">ç›®å½•ç´¢å¼•èŠ‚ç‚¹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%B4%A2%E5%BC%95%E8%8A%82%E7%82%B9%E6%93%8D%E4%BD%9C"><span class="toc-number">16.1.</span> <span class="toc-text">ç›®å½•ç´¢å¼•èŠ‚ç‚¹æ“ä½œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0"><span class="toc-number">16.2.</span> <span class="toc-text">ç›¸å…³å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E8%8A%82%E7%82%B9"><span class="toc-number">16.2.1.</span> <span class="toc-text">åˆ›å»ºç´¢å¼•èŠ‚ç‚¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95"><span class="toc-number">16.2.2.</span> <span class="toc-text">åˆ›å»ºç›®å½•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%93%BE%E6%8E%A5"><span class="toc-number">16.2.3.</span> <span class="toc-text">åˆ›å»ºé“¾æ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AC%A6%E5%8F%B7%E9%93%BE%E6%8E%A5"><span class="toc-number">16.2.4.</span> <span class="toc-text">åˆ›å»ºç¬¦å·é“¾æ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E9%93%BE%E6%8E%A5"><span class="toc-number">16.2.5.</span> <span class="toc-text">åˆ é™¤é“¾æ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%9B%AE%E5%BD%95"><span class="toc-number">16.2.6.</span> <span class="toc-text">åˆ é™¤ç›®å½•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%9B%AE%E5%BD%95%E4%B8%AD%E6%90%9C%E7%B4%A2%E7%B4%A2%E5%BC%95%E8%8A%82%E7%82%B9"><span class="toc-number">16.2.7.</span> <span class="toc-text">åœ¨ç›®å½•ä¸­æœç´¢ç´¢å¼•èŠ‚ç‚¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95%E4%B8%AD%E7%9A%84%E6%9D%A1%E7%9B%AE"><span class="toc-number">16.2.8.</span> <span class="toc-text">éå†ç›®å½•ä¸­çš„æ¡ç›®</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%8D%E5%9B%BE%E6%93%8D%E4%BD%9C"><span class="toc-number">17.</span> <span class="toc-text">ä½å›¾æ“ä½œ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">18.</span> <span class="toc-text">æµç¨‹åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%95%B4%E4%BD%93%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">18.1.</span> <span class="toc-text">æ–‡ä»¶ç³»ç»Ÿæ•´ä½“è¿è¡Œæµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#path-lookup-%E8%BF%87%E7%A8%8B"><span class="toc-number">18.2.</span> <span class="toc-text">path lookup è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mount-%E8%BF%87%E7%A8%8B"><span class="toc-number">18.3.</span> <span class="toc-text">mount è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#open-%E8%BF%87%E7%A8%8B"><span class="toc-number">18.4.</span> <span class="toc-text">open è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8-read-%E6%B5%81%E7%A8%8B"><span class="toc-number">18.5.</span> <span class="toc-text">é€šç”¨ read æµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8-write-%E6%B5%81%E7%A8%8B"><span class="toc-number">18.6.</span> <span class="toc-text">é€šç”¨ write æµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#address_space-%E5%88%B7%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B"><span class="toc-number">18.7.</span> <span class="toc-text">address_space åˆ·æ•°æ®æµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%89%E5%BE%85-page-%E6%A0%87%E5%BF%97%E6%B5%81%E7%A8%8B"><span class="toc-number">18.8.</span> <span class="toc-text">ç­‰å¾… page æ ‡å¿—æµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#plug-%E6%9C%BA%E5%88%B6"><span class="toc-number">18.9.</span> <span class="toc-text">plug æœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#plug"><span class="toc-number">18.9.1.</span> <span class="toc-text">plug</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#blk_start_plug"><span class="toc-number">18.9.2.</span> <span class="toc-text">blk_start_plug</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#blk_finish_plug"><span class="toc-number">18.9.3.</span> <span class="toc-text">blk_finish_plug</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#inode-super_block-%E5%92%8C-dentry-%E7%9A%84%E5%B9%B6%E5%8F%91%E6%9F%A5%E6%89%BE%E6%9C%BA%E5%88%B6"><span class="toc-number">18.10.</span> <span class="toc-text">inodeã€super_block å’Œ dentry çš„å¹¶å‘æŸ¥æ‰¾æœºåˆ¶</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">19.</span> <span class="toc-text">å‚è€ƒæ–‡ç« </span></a></li></ol></section><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/assets/android-chrome-512x512.webp" alt="avatar"></div><p class="sidebar-ov-author__text">Self-discipline is key in life.</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/DavidingPlus" target="_blank" rel="noopener" data-popover="GitHub" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="/qq/" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="/wechat/" target="_blank" rel="noopener" data-popover="å¾®ä¿¡" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weixin"></i></span></a><a class="sidebar-ov-social-item" href="mailto:davidingplus@qq.com" target="_blank" rel="noopener" data-popover="davidingplus@qq.com" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fas fa-envelope"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">38</div><div class="sidebar-ov-state-item__name">å½’æ¡£</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">21</div><div class="sidebar-ov-state-item__name">åˆ†ç±»</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="çŸ¥è¯†å…±äº«è®¸å¯åè®®" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">æ‚¨å·²é˜…è¯»äº† </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright Â© 2023~2025</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>DavidingPlus</span><span class="footer__devider">|</span><span>èœ€ ICP å¤‡ 2024088070 å·</span></div><div><span>ç”± <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> å¼ºåŠ›é©±åŠ¨</span><span> v7.2.0</span><span class="footer__devider">|</span><span>ä¸»é¢˜ - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.8.6</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">è®¿é—®äººæ•°</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">æµè§ˆæ€»é‡</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div><div><span id="timeDate">è½½å…¥å¤©æ•°...</span><span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("09/18/2023 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="å°ç ´ç«™å·²ç»å®‰å…¨è¿è¡Œ "+dnum+" å¤© ",document.getElementById("times").innerHTML=hnum+" å°æ—¶ "+mnum+" åˆ† "+snum+" ç§’å•¦ï¼"}setInterval("createtime()",250)</script></div><script type="text/javascript" id="maid-script" mermaidoptioins="{&quot;theme&quot;:&quot;default&quot;}" src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/mermaid.min.js"></script><script>if(window.mermaid){var options=JSON.parse(document.getElementById("maid-script").getAttribute("mermaidoptioins"));mermaid.initialize(options)}</script></div></footer><div class="loading-animation" id="loading-animation"><div class="loading-animation__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-thumbs-up"></i></span></div><div class="back2bottom" id="back2bottom"><span class="back2bottom__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="æœç´¢æ–‡ç« ï¼ˆæ”¯æŒå¤šå…³é”®è¯ï¼Œè¯·ç”¨ç©ºæ ¼åˆ†éš”ï¼‰"><div class="search-btns">ä½¿ç”¨æœç´¢ï¼š<span class="search-btns-item search-btns-item--bing"><i></i>å¿…åº”</span><span class="search-btns-item search-btns-item--baidu"><i></i>ç™¾åº¦</span></div></div><div class="search-results"></div></div><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/jquery.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/velocity.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/velocity-ui.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/canvas-nest.js" color="255,255,255" opacity="1" count="99" zindex="-1"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/fancybox.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/masonry.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/lazyload.js"></script><script>function initSearch(){var e=!0,t="search.json";t?/json$/i.test(t)&&(e=!1):t="search.xml";var n="/"+t;$.ajax({url:n,dataType:e?"xml":"json",async:!0,success:function(t){var n=e?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,o=$(".search-input input"),i=$(".search-results"),c=100,r=1,a=function(){var e=o.val().toLowerCase().trim(),t=e.split(/[\s]+/),a=[];t.length>1&&t.push(e),e.length>0&&n.forEach(function(e){var n=!1,o=e.title&&e.title.trim()||"[ æ–‡ç« æ— æ ‡é¢˜ ]",i=o&&o.toLowerCase(),s=e.content&&e.content.replace(/<[^>]+>/g,""),l=s&&s.toLowerCase(),u=e.url&&decodeURI(e.url).replace(/\/{2,}/g,"/"),h=[],d=[];t.forEach(function(e){function t(e,t,n,o){if(!e||!t)return[];var i=0,c=-1,r=[];for(n||(e=e.toLowerCase(),t=t.toLowerCase());-1!==(c=t.indexOf(e,i));){var a=!1;h.forEach(function(t){t.index===c&&t.word.length<e.length&&(t.word=e,a=!0)}),i=c+e.length,!a&&r.push({index:c,word:e,weight:o})}return r}h=h.concat(t(e,i,!1,c)),d=d.concat(t(e,l,!1,r))});var f=h.length,p=d.length;if((f>0||p>0)&&(n=!0),n){function w(e,t,n,o){if(e&&t&&t.length){var i="",c=n,r=o;return t.forEach(function(t){if(!(t.index<c)){var n=t.index+t.word.length;i+=e.slice(c,t.index),i+="<b>"+e.slice(t.index,n)+"</b>",c=n}}),i+=e.slice(c,r)}}[h,d].forEach(function(e){e.sort(function(e,t){return e.index-t.index})});var v,g={},x=h.length*c+d.length*r,y=w(o,h,0,o.length)||o;if(d.length>0){var S=d[0].index;v=w(s,d,S>20?S-20:0,S+180)}else v=s.slice(0,200);g.title=y,g.content=v,g.url=u,g.weight=x,a.push(g)}});var s="";a.length?(a.sort(function(e,t){return t.weight-e.weight}),s+="<ul>",a.forEach(function(e){s+='<li><a class="search-results-title" href="'+e.url+'">',s+=e.title,s+='</a><div class="search-results-content">',s+=e.content,s+="</div></li>"}),s+="</ul>"):s+='<div class="search-results-none"><i class="far fa-meh"></i></div>',i.html(s)};o.on("input",a),o.on("keyup",function(e){e.keyCode===Stun.utils.codeToKeyCode("Enter")&&a()})}})}function closeSearch(){$("body").css({overflow:"auto"}),$(".search-popup").css({display:"none"}),$(".search-mask").css({display:"none"})}function safeOpenUrl(e){var t=window.open();t.opener=null,t.location=e}function extSearch(e){var t=window.location.host,n=$(".search-input input").val().toLowerCase().trim();n?safeOpenUrl({google:"https://www.google.com/search?q=",bing:"https://cn.bing.com/search?q=",baidu:"https://www.baidu.com/s?ie=UTF-8&wd="}[e]+n+" site:"+t):Stun.utils.popAlert("warning","è¯·è¾“å…¥å­—ç¬¦")}window.addEventListener("DOMContentLoaded",function(){Stun.utils.pjaxReloadLocalSearch=function(){$(".header-nav-search").on("click",function(e){e.stopPropagation(),$("body").css("overflow","hidden"),$(".search-popup").velocity("stop").velocity("transition.expandIn",{duration:300,complete:function(){$(".search-popup input").focus()}}),$(".search-mask").velocity("stop").velocity("transition.fadeIn",{duration:300}),initSearch()}),$(".search-mask, .search-close").on("click",function(){closeSearch()}),$(document).on("keydown",function(e){e.keyCode===Stun.utils.codeToKeyCode("Escape")&&closeSearch()})},Stun.utils.pjaxReloadLocalSearch()},!1);var assistSearchList=window.CONFIG.assistSearch;Array.isArray(assistSearchList)&&assistSearchList.forEach(function(e){document.querySelector(".search-btns-item--"+e).addEventListener("click",function(){extSearch(e)},!1)})</script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/pjax.js"></script><script>window.addEventListener("DOMContentLoaded",function(){new Pjax({selectors:["head title","#main",".pjax-reload",".header-banner"],history:!0,scrollTo:!1,scrollRestoration:!1,cacheBust:!1,debug:!1,currentUrlFullReload:!1,timeout:0});document.addEventListener("pjax:send",function(){$(".header-nav-menu").removeClass("show"),CONFIG.pjax&&CONFIG.pjax.avoidBanner&&$("html").velocity("scroll",{duration:500,offset:$("#header").height(),easing:"easeInOutCubic"}),$(".loading-animation").addClass("loading")},!1),window.addEventListener("pjax:complete",function(){if($(".loading-animation").removeClass("loading"),$("link[rel=prefetch], script[data-pjax-rm]").each(function(){$(this).remove()}),$("script[data-pjax], #pjax-reload script").each(function(){$(this).parent().append($(this).remove())}),Stun.utils.pjaxReloadBoot&&Stun.utils.pjaxReloadBoot(),Stun.utils.pjaxReloadScroll&&Stun.utils.pjaxReloadScroll(),Stun.utils.pjaxReloadSidebar&&Stun.utils.pjaxReloadSidebar(),"undefined"!=typeof mermaid){const e=Array.from(document.querySelectorAll(".mermaid")).filter(e=>!e.dataset.processed);mermaid.init(void 0,e)}},!1)},!1)</script><div id="pjax-reload"><link href="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/css/katex.min.css" rel="stylesheet" type="text/css"><link href="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/css/copy-tex.css" rel="stylesheet" type="text/css"><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/copy-tex.min.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/quicklink.js"></script><script>function initQuicklink(){quicklink({timeout:"10000",priority:!0,ignores:[i=>i.includes("#"),i=>"https://blog.davidingplus.cn/posts/68b0f3fd.html"===i,/\/api\/?/,i=>i.includes(".xml"),i=>i.includes(".zip"),(i,t)=>t.hasAttribute("nofollow"),(i,t)=>t.hasAttribute("noprefetch")]})}initQuicklink()</script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/busuanzi.js" async></script></div><script src="/js/utils.js?v=2.8.6"></script><script src="/js/stun-boot.js?v=2.8.6"></script><script src="/js/scroll.js?v=2.8.6"></script><script src="/js/header.js?v=2.8.6"></script><script src="/js/sidebar.js?v=2.8.6"></script><script type="application/json" src="/search.json"></script><script data-pjax="">function loadUtterances(){var t=document,e=t.createElement("script"),s=t.getElementById("utterances-container"),r=Stun.utils.getNightMode()?"photon-dark":"github-light";s&&(e.src="https://utteranc.es/client.js",e.setAttribute("repo","DavidingPlus/blog-comments"),e.setAttribute("issue-term","title"),e.setAttribute("label","utterances"),e.setAttribute("theme",r),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),e.setAttribute("data-pjax-rm",""),s.append(e))}loadUtterances()</script><script async src="/js/cursor/text.js"></script><script src="/js/activate-power-mode.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,document.body.addEventListener("input",POWERMODE)</script><script>var titleTime,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="ğŸ¤¡å¿«å›æ¥,ç²—å¤§äº‹äº†~~"+OriginTitile,clearTimeout(titleTime)):(document.title="ğŸ˜šæ¬¢è¿å›æ¥!~"+OriginTitile,titleTime=setTimeout(function(){document.title=OriginTitile},2e3))})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"left",width:160,height:290},mobile:{show:!0},log:!1})</script></body></html>