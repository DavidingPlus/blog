<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="renderer" content="webkit"><meta name="force-rendering" content="webkit"><script>window.MSInputMethodContext&&document.documentMode&&(window.location.href="https://support.dmeng.net/upgrade-your-browser.html")</script><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/assets/favicon-16x16.webp?v=2.8.6" type="image/png" sizes="16x16"><link rel="icon" href="/assets/favicon-32x32.webp?v=2.8.6" type="image/png" sizes="32x32"><link rel="apple-touch-icon" href="/assets/apple-touch-icon.webp?v=2.8.6" sizes="180x180"><meta name="description" content="cairo是一个方便和高性能的第三方C库。它可以作为绘制引擎，帮助我们绘制各种图形，并且提供多种输出方式。本文将在Linux下结合X11图形显示协议绘制简单的图形。 这是效果图："><meta property="og:type" content="article"><meta property="og:title" content="在 X11 下使用 cairo 引擎绘制图形"><meta property="og:url" content="https://blog.davidingplus.cn/posts/70513923.html"><meta property="og:site_name" content="DavidingPlus&#39;s Blog"><meta property="og:description" content="cairo是一个方便和高性能的第三方C库。它可以作为绘制引擎，帮助我们绘制各种图形，并且提供多种输出方式。本文将在Linux下结合X11图形显示协议绘制简单的图形。 这是效果图："><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/59cb53826fcba1602fd3769171f5f127.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20240715163723130.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20240715165238889.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20240715172400074.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20240715172916780.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20240715175839407.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20240716111623175.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20240716141915019.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20240716142350311.png"><meta property="og:image" content="https://cdn.davidingplus.cn/images/2025/02/01/image-20240716155335456.png"><meta property="article:published_time" content="2024-07-02T18:30:00.000Z"><meta property="article:modified_time" content="2024-07-16T16:30:00.000Z"><meta property="article:author" content="DavidingPlus"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.davidingplus.cn/images/2025/02/01/59cb53826fcba1602fd3769171f5f127.png"><title>在 X11 下使用 cairo 引擎绘制图形 | DavidingPlus's Blog</title><link ref="canonical" href="https://blog.davidingplus.cn/posts/70513923.html"><link rel="dns-prefetch" href="https://cdn.davidingplus.cn"><link rel="stylesheet" href="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/css/fontawesome.css" type="text/css"><link rel="stylesheet" href="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/css/fancybox.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.8.6"><script>var Stun=window.Stun||{},CONFIG={root:"/",algolia:void 0,assistSearch:["bing","baidu"],fontIcon:{prompt:{success:"fas fa-check-circle",info:"fas fa-arrow-circle-right",warning:"fas fa-exclamation-circle",error:"fas fa-times-circle"},copyBtn:"fas fa-copy"},sidebar:{offsetTop:"55px",tocMaxDepth:6},header:{enable:!0,showOnPost:!0,scrollDownIcon:!0},postWidget:{endText:!0},nightMode:{enable:!0},back2top:{enable:!0},back2bottom:{enable:!0},codeblock:{style:"default",highlight:"light",wordWrap:!0},reward:!0,fancybox:!0,zoomImage:{gapAside:"20px"},galleryWaterfall:{colWidth:"255px",gapX:"65px"},lazyload:!0,pjax:{avoidBanner:!0},externalLink:{icon:{enable:!0,name:"fas fa-external-link-alt"}},shortcuts:void 0,prompt:{copyButton:"复制",copySuccess:"恭喜亲亲，复制成功咧",copyError:"哎呀，复制失败了"},sourcePath:{js:"js",css:"css",images:"images"},utterancesTheme:{light:"github-light",dark:"photon-dark"}};window.CONFIG=CONFIG</script><meta name="generator" content="Hexo 7.2.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="javascript:;" onclick="return!1"><span class="header-nav-menu-item__icon"><i class="fas fa-bars"></i></span><span class="header-nav-menu-item__text">其他</span></a><div class="header-nav-submenu"><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/friends/"><span class="header-nav-submenu-item__icon"><i class="fas fa-users"></i></span><span class="header-nav-submenu-item__text">友链</span></a></div><div class="header-nav-submenu-item"><a class="header-nav-submenu-item__link" href="/gallery/"><span class="header-nav-submenu-item__icon"><i class="fas fa-images"></i></span><span class="header-nav-submenu-item__text">相册</span></a></div></div></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-user"></i></span><span class="header-nav-menu-item__text">关于</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" target="_blank" rel="noopener" href="https://davidingplus.cn/"><span class="header-nav-menu-item__icon"><i class="fas fa-pager"></i></span><span class="header-nav-menu-item__text">站点主页</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">DavidingPlus's Blog</div><div class="header-banner-info__subtitle">🕊️ world peace</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">在 X11 下使用 cairo 引擎绘制图形</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2024-07-02</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2024-07-16</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">7.3k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">56分</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><meta name="referrer" content="no-referrer"><p><code>cairo</code>是一个方便和高性能的第三方<code>C</code>库。它可以作为绘制引擎，帮助我们绘制各种图形，并且提供多种输出方式。本文将在<code>Linux</code>下结合<code>X11</code>图形显示协议绘制简单的图形。</p><p>这是效果图：</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/59cb53826fcba1602fd3769171f5f127.png" alt="59cb53826fcba1602fd3769171f5f127" style="zoom:67%"> <span id="more"></span><h1 id="安装Cairo库"><a href="#安装Cairo库" class="heading-link"><i class="fas fa-link"></i></a><a href="#安装Cairo库" class="headerlink" title="安装Cairo库"></a>安装Cairo库</h1><p><code>cairo</code>的官方网站是<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://cairographics.org/">https://cairographics.org</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。上面对<code>cairo</code>图形库做了一个完整的介绍，包括如何下载、<code>API</code>接口、示例等等。</p><h2 id="通过包管理器安装"><a href="#通过包管理器安装" class="heading-link"><i class="fas fa-link"></i></a><a href="#通过包管理器安装" class="headerlink" title="通过包管理器安装"></a>通过包管理器安装</h2><p>通过官方文档知道，在<code>Linux</code>下可以直接通过包管理器进行下载，以<code>Ubuntu</code>为例。</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install libcairo2-dev</span><br></pre></td></tr></table></div></figure><p>下载好以后头文件和动态库就安装好了。头文件安装在<code>/usr/include/cairo/</code>中，静态库和动态库分别位于<code>/usr/lib/x86_64-linux-gnu/libcairo.a</code>和<code>/usr/lib/x86_64-linux-gnu/libcairo.so</code>。因此能直接被系统识别，直接引入头文件，编译的时候链接<code>cairo</code>库即可。</p><h2 id="通过Conan安装"><a href="#通过Conan安装" class="heading-link"><i class="fas fa-link"></i></a><a href="#通过Conan安装" class="headerlink" title="通过Conan安装"></a>通过Conan安装</h2><p>对于个人而言，<code>apt</code>安装自然是非常友好的。但是对于<code>LarkSDK</code>这样一个面向用户的基础框架而言，除非最基本的系统库例如<code>X</code>窗口系统<code>libx11-dev</code>，<code>Wayland</code>窗口系统<code>libwayland-dev</code>和<code>Wayland</code>键盘处理<code>libxkbcommon-dev</code>等，其他的第三方库均最好不以<code>apt</code>包的方式引入。鉴于<code>C++</code>没有自己的包管理器，因此需要借助第三方的包管理器，例如<code>conan</code>，<code>cpm</code>等。本项目使用<code>conan</code>管理第三方包。</p><p><code>conan</code>是一个<code>python</code>语言编写的<code>C++</code>的包管理器，官方网址是<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://conan.io/">https://conan.io/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。<code>conan</code>管理了众多第三方的<code>C++</code>库，通过命令行操作就能方便的在自己的项目中引入<code>conan</code>包。需要通过<code>conanfile.py</code>或者<code>conanfile.txt</code>进行配置，当然这不是本文的重点，具体见文档<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://docs.conan.io/2/">https://docs.conan.io/2/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。</p><p><code>conan</code>官方提供了自己的<code>conan</code>仓库，<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://conan.io/center">https://conan.io/center</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。在上面能找到很多我们熟知的第三方库，例如<code>gtest</code>，<code>qt</code>，<code>boost</code>，<code>fmt</code>等。当然还有一些更基础的工具库，这里不赘述。当然<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://conan.io/center/recipes/cairo">cairo</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>库也在其中。</p><h3 id="尝试安装Cairo"><a href="#尝试安装Cairo" class="heading-link"><i class="fas fa-link"></i></a><a href="#尝试安装Cairo" class="headerlink" title="尝试安装Cairo"></a>尝试安装Cairo</h3><p>现在让我们尝试安装<code>cairo</code>库并尝试用<code>CMake</code>将其引入。在新开的项目中创建<code>conanfile.txt</code>，引入项目依赖<code>cairo</code>。使用<code>conanfile.py</code>主要用于生成和发布自己的<code>conan</code>包，<code>conan</code>提供了丰富的选项供用户操作。这里只是为了测试，因此使用最简单的<code>conanfile.txt</code>即可。</p><figure class="highlight ini"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[requires]</span></span><br><span class="line">cairo/1.18.0</span><br><span class="line"></span><br><span class="line"><span class="section">[generators]</span></span><br><span class="line">cmake</span><br></pre></td></tr></table></div></figure><p>编写自己的<code>CMakeLists.txt</code>，配置项目的相关信息，引入<code>conan</code>的部分类似如下：</p><figure class="highlight cmake"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> (<span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/conanbuildinfo.cmake)</span><br><span class="line">conan_basic_setup (NO_OUTPUT_DIRS)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span> (xxx</span><br><span class="line">    ...</span><br><span class="line">)</span><br><span class="line"><span class="keyword">target_link_libraries</span> (xxx <span class="variable">$&#123;CONAN_LIBS&#125;</span>)</span><br></pre></td></tr></table></div></figure><p>之后执行一般的构建流程即可。</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">conan install ..</span><br><span class="line">cmake ..</span><br><span class="line">make <span class="comment"># windows 下默认没有 make 命令，使用 cmake --build ./ 代替</span></span><br></pre></td></tr></table></div></figure><p><code>conan</code>官方的包很多，很全，但是<code>conan</code>本身还有很多<code>bug</code>，单就<code>cairo</code>包的使用过程中就有很多问题。最典型的，执行<code>conan install ..</code>可能会失败，并且遇到很多错误。因此我们需要了解<code>conan</code>包是个什么东西，才能明确问题是如何形成的。</p><h3 id="关于Conan包"><a href="#关于Conan包" class="heading-link"><i class="fas fa-link"></i></a><a href="#关于Conan包" class="headerlink" title="关于Conan包"></a>关于Conan包</h3><p>现在对<code>conan</code>包做一个简述。对于<code>C++</code>库而言，为了让用户方便的使用，把<code>.h</code>和<code>.cpp</code>代码全部打包出去是不合适的，这些代码不应该在用户的机器上再被编译一次，而应该在需要用的时候被直接使用。因此需要通过库的方式进行发布，也就是使用静态库和动态库。在发布的包中，最重要的文件就是头文件和库文件。当然可能会携带一些其他必要的文件，例如资源文件、版本说明文件等。</p><p>我们都知道，编译<code>C/C++</code>的代码需要依赖于<code>C++</code>和编译器的版本。进一步的，由于<code>C/C++</code>是非常接近底层的代码，虽然标准库是跨平台的，但是如果需要写平台相关的程序，还需要注意操作系统的版本。因此，对于同一个版本的<code>conan</code>包，不同的系统，不同的编译环境，是静态库还是动态库，是<code>Debug</code>包还是<code>Release</code>包，甚至依赖包的版本，都可能对最后的编译造成一定影响。在本地的<code>conan</code>配置中会保存相关的这些信息，在<code>conan</code>拉包的时候会匹配本地的配置拉取合适的包。配置文件默认位于<code>~/.conan/profile/default</code>中。</p><p>在<code>Linux</code>下的配置类似于这样，看其参数很明显就能知道对应的含义。</p><figure class="highlight ini"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[settings]</span></span><br><span class="line"><span class="attr">os</span>=Linux</span><br><span class="line"><span class="attr">os_build</span>=Linux</span><br><span class="line"><span class="attr">arch</span>=x<span class="number">86_64</span></span><br><span class="line"><span class="attr">arch_build</span>=x<span class="number">86_64</span></span><br><span class="line"><span class="attr">compiler</span>=gcc</span><br><span class="line"><span class="attr">compiler.version</span>=<span class="number">9</span></span><br><span class="line"><span class="attr">compiler.libcxx</span>=libstdc++<span class="number">11</span></span><br><span class="line"><span class="attr">build_type</span>=Release</span><br><span class="line"><span class="section">[options]</span></span><br><span class="line"><span class="section">[build_requires]</span></span><br><span class="line"><span class="section">[env]</span></span><br></pre></td></tr></table></div></figure><p>在<code>Windows</code>下类似于这样：</p><figure class="highlight ini"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[settings]</span></span><br><span class="line"><span class="attr">os</span>=Windows</span><br><span class="line"><span class="attr">os_build</span>=Windows</span><br><span class="line"><span class="attr">arch</span>=x<span class="number">86_64</span></span><br><span class="line"><span class="attr">arch_build</span>=x<span class="number">86_64</span></span><br><span class="line"><span class="attr">compiler</span>=Visual Studio</span><br><span class="line"><span class="attr">compiler.version</span>=<span class="number">16</span></span><br><span class="line"><span class="attr">build_type</span>=Release</span><br><span class="line"><span class="section">[options]</span></span><br><span class="line"><span class="section">[build_requires]</span></span><br><span class="line"><span class="section">[env]</span></span><br></pre></td></tr></table></div></figure><p>现在我们以<code>cairo/1.18.0@</code>包为例，使用<code>conan</code>命令查看其远端的包的列表。</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conan search cairo/1.18.0@ -r conancenter</span><br></pre></td></tr></table></div></figure><p>得到的结果大致是这样：</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20240715163723130.png" alt="image-20240715163723130" style="zoom:55%"><p>我们发现<code>settings</code>中的内容和我们的<code>profiles/default</code>中的内容对应，这就是前面提到的匹配。例如图中是一个<code>Mac</code>下的<code>apple-clang</code>的<code>13.0</code>版本的<code>静态库</code>的<code>Debug</code>包。每个包的<code>options</code>，<code>settings</code>和<code>requires</code>都会对最前面的<code>Package_ID</code>产生影响，这是一个哈希计算值，具体如何影响和生成请参考<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://docs.conan.io/2/reference/binary_model/package_id.html">https://docs.conan.io/2/reference/binary_model&#x2F;package_id.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。当然这其中也有令人费解的地方，请见下文。</p><h3 id="解决错误（并吐槽）"><a href="#解决错误（并吐槽）" class="heading-link"><i class="fas fa-link"></i></a><a href="#解决错误（并吐槽）" class="headerlink" title="解决错误（并吐槽）"></a>解决错误（并吐槽）</h3><p>前面提到，<code>conan</code>官方的包有问题，会导致在安装的时候出现错误。例如，我在安装的出现的错误如下：</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20240715165238889.png" alt="image-20240715165238889" style="zoom:55%"><p>错误信息告诉我<code>fontconfig</code>的<code>2.15.0</code>的版本需要<code>conan 1.60.4</code>以上才能安装。由于公司使用的是<code>conan 1.60.1</code>，首先我想到的是<code>conan</code>版本不正确。深入研究后，我发现的问题出乎我的意料。</p><p>由于公司实际开发的<code>conan</code>版本不可能从<code>1.60.1</code>升到<code>1.60.4</code>，要升肯定一步到位到<code>conan 2.0</code>了。首先查看<code>conancenter</code>中<code>cairo/1.18.0@</code>远端的包，检索符合当前系统和编译环境的。我发现了三个长的几乎一样的包：</p><figure class="highlight ini"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; package 1</span></span><br><span class="line">Package_ID: 703bcc640002869a53960c4449d3825ff8a103e6</span><br><span class="line">    <span class="section">[options]</span></span><br><span class="line">        fPIC: True</span><br><span class="line">        shared: False</span><br><span class="line">        tee: False</span><br><span class="line">        with_fontconfig: True</span><br><span class="line">        with_freetype: True</span><br><span class="line">        with_glib: True</span><br><span class="line">        with_lzo: True</span><br><span class="line">        with_png: True</span><br><span class="line">        with_symbol_lookup: False</span><br><span class="line">        with_xcb: True</span><br><span class="line">        with_xlib: True</span><br><span class="line">        with_xlib_xrender: True</span><br><span class="line">        with_zlib: True</span><br><span class="line">    <span class="section">[settings]</span></span><br><span class="line">        arch: x86_64</span><br><span class="line">        build_type: Release</span><br><span class="line">        compiler: gcc</span><br><span class="line">        compiler.version: 9</span><br><span class="line">        os: Linux</span><br><span class="line">    <span class="section">[requires]</span></span><br><span class="line">        brotli/1.1.0:b21556a366bf52552d3a00ce381b508d0563e081</span><br><span class="line">        bzip2/1.0.8:da606cf731e334010b0bf6e85a2a6f891b9f36b0</span><br><span class="line">        expat/2.6.0:c215f67ac7fc6a34d9d0fb90b0450016be569d86</span><br><span class="line">        fontconfig/2.15.0:b172ac37518ca059ccac0be9c3eb29e5179ecf1e</span><br><span class="line">        freetype/2.13.2:f1014dc4f9380132c471ceb778980949abf136d3</span><br><span class="line">        glib/2.78.3:06c63123a2bb8b6d3ea5dcae501525df32efb7b5</span><br><span class="line">        libelf/0.8.13:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        libffi/3.4.4:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        libmount/2.39:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        libpng/1.6.43:7929d8ecf29c60d74fd3c1f6cb78bbb3cb49c0c7</span><br><span class="line">        libselinux/3.5:6b0384e3aaa343ede5d2bd125e37a0198206de42</span><br><span class="line">        lzo/2.10:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        pcre2/10.42:647f8233073b10c84d51b1833c74f5a1cb8e8604</span><br><span class="line">        pixman/0.43.4:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        util-linux-libuuid/2.39.2:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        xorg/system:5ab84d6acfe1f23c4fae0ab88f26e3a396351ac9</span><br><span class="line">        zlib/1.3.1:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">    Outdated from recipe: True</span><br><span class="line"></span><br><span class="line"><span class="comment">; package 2</span></span><br><span class="line">Package_ID: 8098347825649d9fd3e21c49992446a2a2193ad4</span><br><span class="line">    <span class="section">[options]</span></span><br><span class="line">        fPIC: True</span><br><span class="line">        shared: False</span><br><span class="line">        tee: False</span><br><span class="line">        with_fontconfig: True</span><br><span class="line">        with_freetype: True</span><br><span class="line">        with_glib: True</span><br><span class="line">        with_lzo: True</span><br><span class="line">        with_png: True</span><br><span class="line">        with_symbol_lookup: False</span><br><span class="line">        with_xcb: True</span><br><span class="line">        with_xlib: True</span><br><span class="line">        with_xlib_xrender: True</span><br><span class="line">        with_zlib: True</span><br><span class="line">    <span class="section">[settings]</span></span><br><span class="line">        arch: x86_64</span><br><span class="line">        build_type: Release</span><br><span class="line">        compiler: gcc</span><br><span class="line">        compiler.version: 9</span><br><span class="line">        os: Linux</span><br><span class="line">    <span class="section">[requires]</span></span><br><span class="line">        brotli/1.1.0:b21556a366bf52552d3a00ce381b508d0563e081</span><br><span class="line">        bzip2/1.0.8:da606cf731e334010b0bf6e85a2a6f891b9f36b0</span><br><span class="line">        expat/2.5.0:c215f67ac7fc6a34d9d0fb90b0450016be569d86</span><br><span class="line">        fontconfig/2.14.2:b172ac37518ca059ccac0be9c3eb29e5179ecf1e</span><br><span class="line">        freetype/2.13.0:f1014dc4f9380132c471ceb778980949abf136d3</span><br><span class="line">        glib/2.78.0:06c63123a2bb8b6d3ea5dcae501525df32efb7b5</span><br><span class="line">        libelf/0.8.13:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        libffi/3.4.4:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        libmount/2.39:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        libpng/1.6.40:7929d8ecf29c60d74fd3c1f6cb78bbb3cb49c0c7</span><br><span class="line">        libselinux/3.5:6b0384e3aaa343ede5d2bd125e37a0198206de42</span><br><span class="line">        lzo/2.10:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        pcre2/10.42:647f8233073b10c84d51b1833c74f5a1cb8e8604</span><br><span class="line">        pixman/0.40.0:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        util-linux-libuuid/2.39:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        xorg/system:5ab84d6acfe1f23c4fae0ab88f26e3a396351ac9</span><br><span class="line">        zlib/1.3:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">    Outdated from recipe: True</span><br><span class="line">        </span><br><span class="line"><span class="comment">; package 3</span></span><br><span class="line">Package_ID: a336bac291d8ec6a55c6257f3266f9a8760c7403</span><br><span class="line">    <span class="section">[options]</span></span><br><span class="line">        fPIC: True</span><br><span class="line">        shared: False</span><br><span class="line">        tee: False</span><br><span class="line">        with_fontconfig: True</span><br><span class="line">        with_freetype: True</span><br><span class="line">        with_glib: True</span><br><span class="line">        with_lzo: True</span><br><span class="line">        with_png: True</span><br><span class="line">        with_symbol_lookup: False</span><br><span class="line">        with_xcb: True</span><br><span class="line">        with_xlib: True</span><br><span class="line">        with_xlib_xrender: True</span><br><span class="line">        with_zlib: True</span><br><span class="line">    <span class="section">[settings]</span></span><br><span class="line">        arch: x86_64</span><br><span class="line">        build_type: Release</span><br><span class="line">        compiler: gcc</span><br><span class="line">        compiler.version: 9</span><br><span class="line">        os: Linux</span><br><span class="line">    <span class="section">[requires]</span></span><br><span class="line">        brotli/1.1.0:b21556a366bf52552d3a00ce381b508d0563e081</span><br><span class="line">        bzip2/1.0.8:da606cf731e334010b0bf6e85a2a6f891b9f36b0</span><br><span class="line">        expat/2.5.0:c215f67ac7fc6a34d9d0fb90b0450016be569d86</span><br><span class="line">        fontconfig/2.14.2:b172ac37518ca059ccac0be9c3eb29e5179ecf1e</span><br><span class="line">        freetype/2.13.2:f1014dc4f9380132c471ceb778980949abf136d3</span><br><span class="line">        glib/2.78.1:06c63123a2bb8b6d3ea5dcae501525df32efb7b5</span><br><span class="line">        libelf/0.8.13:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        libffi/3.4.4:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        libmount/2.39:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        libpng/1.6.40:7929d8ecf29c60d74fd3c1f6cb78bbb3cb49c0c7</span><br><span class="line">        libselinux/3.5:6b0384e3aaa343ede5d2bd125e37a0198206de42</span><br><span class="line">        lzo/2.10:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        pcre2/10.42:647f8233073b10c84d51b1833c74f5a1cb8e8604</span><br><span class="line">        pixman/0.42.2:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        util-linux-libuuid/2.39.2:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">        xorg/system:5ab84d6acfe1f23c4fae0ab88f26e3a396351ac9</span><br><span class="line">        zlib/1.3:6af9cc7cb931c5ad942174fd7838eb655717c709</span><br><span class="line">    Outdated from recipe: True</span><br></pre></td></tr></table></div></figure><p>这三个包的唯一区别在于<code>requires</code>不同，第一个包需要<code>expat/2.6.0</code>，第二个和第三个包需要<code>expat/2.5.0</code>。第二个包需要<code>freetype/2.13.0</code>，第三个包<code>freetype/2.13.2</code>。这就是唯一区别，然后生成了三个不同的哈希值，对应不同的<code>package</code>。</p><p>那么问题来了，<code>conan install</code>默认会读取本地的配置，但是本地配置不可能指定<code>requires</code>啊。不同的项目可能用的版本不同，这是很正常的事情，也不应该是由用户承担责任的地方。其次，<code>conan install</code>不能指定<code>package_id</code>下载，因此下载的是哪一个包，完全就看他怎么想了。非常不幸运的是，我需要第二个包，但是下载只能下载到第一个包。</p><p>那么如何解决这个问题呢？幸运的是，<code>conan</code>提供了<code>conan download</code>的方法，这个东西可以指定<code>package_id</code>进行下载。那就简单了，先把<code>cairo</code>本包下载到本地，然后再指定这一套流程，由于本地有缓存，会跳过去远端拉取<code>cairo</code>包的这一步，这样所有本包和所有依赖不就顺利拉取下来了吗？说干就干。</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conan download cairo/1.18.0@:8098347825649d9fd3e21c49992446a2a2193ad4 -r conancenter</span><br></pre></td></tr></table></div></figure><p>成功下载下来以后，再次执行<code>conan install ..</code>，又出问题了。</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20240715172400074.png" alt="image-20240715172400074" style="zoom:58%"><p>不对啊，这个包依赖的<code>fontconfig</code>的版本是<code>2.14.2</code>啊，为什么这里还是下载的<code>2.15.0</code>啊？为了解决这个问题，我打开了对应的<code>conanfile.py</code>，阅读到<code>requirements()</code>函数的时候，豁然开朗。</p><figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">requirements</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="variable language_">self</span>.requires(<span class="string">&quot;pixman/0.43.4&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.options.with_zlib <span class="keyword">and</span> <span class="variable language_">self</span>.options.with_png:</span><br><span class="line">        <span class="variable language_">self</span>.requires(<span class="string">&quot;expat/[&gt;=2.6.2 &lt;3]&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.options.with_lzo:</span><br><span class="line">        <span class="variable language_">self</span>.requires(<span class="string">&quot;lzo/2.10&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.options.with_zlib:</span><br><span class="line">        <span class="variable language_">self</span>.requires(<span class="string">&quot;zlib/[&gt;=1.2.11 &lt;2]&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.options.with_freetype:</span><br><span class="line">        <span class="variable language_">self</span>.requires(<span class="string">&quot;freetype/2.13.2&quot;</span>, transitive_headers=<span class="literal">True</span>, transitive_libs=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.options.with_fontconfig:</span><br><span class="line">        <span class="variable language_">self</span>.requires(<span class="string">&quot;fontconfig/2.15.0&quot;</span>, transitive_headers=<span class="literal">True</span>, transitive_libs=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.options.with_png:</span><br><span class="line">        <span class="variable language_">self</span>.requires(<span class="string">&quot;libpng/[&gt;=1.6 &lt;2]&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.options.with_glib:</span><br><span class="line">        <span class="variable language_">self</span>.requires(<span class="string">&quot;glib/2.78.3&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.settings.os <span class="keyword">in</span> [<span class="string">&quot;Linux&quot;</span>, <span class="string">&quot;FreeBSD&quot;</span>]:</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.options.with_xlib <span class="keyword">or</span> <span class="variable language_">self</span>.options.with_xlib_xrender <span class="keyword">or</span> <span class="variable language_">self</span>.options.with_xcb:</span><br><span class="line">            <span class="variable language_">self</span>.requires(<span class="string">&quot;xorg/system&quot;</span>, transitive_headers=<span class="literal">True</span>, transitive_libs=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.options.get_safe(<span class="string">&quot;with_opengl&quot;</span>) == <span class="string">&quot;desktop&quot;</span>:</span><br><span class="line">        <span class="variable language_">self</span>.requires(<span class="string">&quot;opengl/system&quot;</span>, transitive_headers=<span class="literal">True</span>, transitive_libs=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.settings.os == <span class="string">&quot;Windows&quot;</span>:</span><br><span class="line">            <span class="variable language_">self</span>.requires(<span class="string">&quot;glext/cci.20210420&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.requires(<span class="string">&quot;wglext/cci.20200813&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.requires(<span class="string">&quot;khrplatform/cci.20200529&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.options.get_safe(<span class="string">&quot;with_opengl&quot;</span>) <span class="keyword">and</span> <span class="variable language_">self</span>.settings.os <span class="keyword">in</span> [<span class="string">&quot;Linux&quot;</span>, <span class="string">&quot;FreeBSD&quot;</span>]:</span><br><span class="line">        <span class="variable language_">self</span>.requires(<span class="string">&quot;egl/system&quot;</span>, transitive_headers=<span class="literal">True</span>, transitive_libs=<span class="literal">True</span>)</span><br></pre></td></tr></table></div></figure><p>不是哥们，<code>expat</code>需要的是<code>2.5.0</code>，但是你规定依赖的包是<code>&gt;=2.6.2 and &lt;3</code>。哈？这不前后矛盾吗？对于<code>freetype</code>和<code>fontconfig</code>也是相同的问题。同时，我们再浏览一下<code>cairo</code>包拉下来以后的整体结构。奥，原来同一个版本的所有包的<code>conanfile.py</code>都是同一个文件。好，这没有任何问题，这是<code>conan</code>的设计。但是你自己不更新依赖版本的限制是什么意思，如果硬要不改的话，发布不同的版本也是<code>ok</code>的啊。这样一套流程下来，导致<code>conan</code>拉包就出现了问题。</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20240715172916780.png" alt="image-20240715172916780" style="zoom:67%"><p>那么如何解决呢？公司这边的解决方式是将该版本的<code>cairo</code>包上传到公司的<code>conan</code>服务器上，并手动修改<code>conanfile.py</code>使其版本匹配，并将所有的依赖以及穿透依赖全部拷贝到公司服务器上。至此，<code>cairo</code>终于成功通过<code>conan</code>安装。</p><p><code>Windows</code>那边也是同样的问题，同样操作即可。</p><h3 id="补充"><a href="#补充" class="heading-link"><i class="fas fa-link"></i></a><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>在<code>Linux</code>下的<code>Cairo</code>包中，有一个依赖项值得看一下，即<code>xorg/system</code>。这个包的版本是<code>system</code>，意思是和系统相关的包，这里是<code>Linux</code>下<code>X</code>图形协议相关的依赖。众所周知，系统包是通过<code>apt</code>或者<code>yum</code>进行安装的，意思是<code>conan</code>能够调用这些包命令来帮我们自动安装对应的包吗？</p><p>答案是可以的，参见文档<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://docs.conan.io/2/reference/tools/system/package_manager.html">https://docs.conan.io/2/reference/tools/system/package_manager.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。留意这段代码：</p><figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">system_requirements</span>(<span class="params">self</span>):</span><br><span class="line">    apt = package_manager.Apt(<span class="variable language_">self</span>)</span><br><span class="line">    apt.install([<span class="string">&quot;libx11-dev&quot;</span>, <span class="string">&quot;libx11-xcb-dev&quot;</span>, <span class="string">&quot;libfontenc-dev&quot;</span>, <span class="string">&quot;libice-dev&quot;</span>, <span class="string">&quot;libsm-dev&quot;</span>, <span class="string">&quot;libxau-dev&quot;</span>, <span class="string">&quot;libxaw7-dev&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;libxcomposite-dev&quot;</span>, <span class="string">&quot;libxcursor-dev&quot;</span>, <span class="string">&quot;libxdamage-dev&quot;</span>, <span class="string">&quot;libxdmcp-dev&quot;</span>, <span class="string">&quot;libxext-dev&quot;</span>, <span class="string">&quot;libxfixes-dev&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;libxi-dev&quot;</span>, <span class="string">&quot;libxinerama-dev&quot;</span>, <span class="string">&quot;libxkbfile-dev&quot;</span>, <span class="string">&quot;libxmu-dev&quot;</span>, <span class="string">&quot;libxmuu-dev&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;libxpm-dev&quot;</span>, <span class="string">&quot;libxrandr-dev&quot;</span>, <span class="string">&quot;libxrender-dev&quot;</span>, <span class="string">&quot;libxres-dev&quot;</span>, <span class="string">&quot;libxss-dev&quot;</span>, <span class="string">&quot;libxt-dev&quot;</span>, <span class="string">&quot;libxtst-dev&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;libxv-dev&quot;</span>, <span class="string">&quot;libxxf86vm-dev&quot;</span>, <span class="string">&quot;libxcb-glx0-dev&quot;</span>, <span class="string">&quot;libxcb-render0-dev&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;libxcb-render-util0-dev&quot;</span>, <span class="string">&quot;libxcb-xkb-dev&quot;</span>, <span class="string">&quot;libxcb-icccm4-dev&quot;</span>, <span class="string">&quot;libxcb-image0-dev&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;libxcb-keysyms1-dev&quot;</span>, <span class="string">&quot;libxcb-randr0-dev&quot;</span>, <span class="string">&quot;libxcb-shape0-dev&quot;</span>, <span class="string">&quot;libxcb-sync-dev&quot;</span>, <span class="string">&quot;libxcb-xfixes0-dev&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;libxcb-xinerama0-dev&quot;</span>, <span class="string">&quot;libxcb-dri3-dev&quot;</span>, <span class="string">&quot;uuid-dev&quot;</span>, <span class="string">&quot;libxcb-cursor-dev&quot;</span>, <span class="string">&quot;libxcb-dri2-0-dev&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;libxcb-dri3-dev&quot;</span>, <span class="string">&quot;libxcb-present-dev&quot;</span>, <span class="string">&quot;libxcb-composite0-dev&quot;</span>, <span class="string">&quot;libxcb-ewmh-dev&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;libxcb-res0-dev&quot;</span>], update=<span class="literal">True</span>, check=<span class="literal">True</span>)</span><br><span class="line">    apt.install_substitutes(</span><br><span class="line">        [<span class="string">&quot;libxcb-util-dev&quot;</span>], [<span class="string">&quot;libxcb-util0-dev&quot;</span>], update=<span class="literal">True</span>, check=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    yum = package_manager.Yum(<span class="variable language_">self</span>)</span><br><span class="line">    yum.install([<span class="string">&quot;libxcb-devel&quot;</span>, <span class="string">&quot;libfontenc-devel&quot;</span>, <span class="string">&quot;libXaw-devel&quot;</span>, <span class="string">&quot;libXcomposite-devel&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;libXcursor-devel&quot;</span>, <span class="string">&quot;libXdmcp-devel&quot;</span>, <span class="string">&quot;libXtst-devel&quot;</span>, <span class="string">&quot;libXinerama-devel&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;libxkbfile-devel&quot;</span>, <span class="string">&quot;libXrandr-devel&quot;</span>, <span class="string">&quot;libXres-devel&quot;</span>, <span class="string">&quot;libXScrnSaver-devel&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;xcb-util-wm-devel&quot;</span>, <span class="string">&quot;xcb-util-image-devel&quot;</span>, <span class="string">&quot;xcb-util-keysyms-devel&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;xcb-util-renderutil-devel&quot;</span>, <span class="string">&quot;libXdamage-devel&quot;</span>, <span class="string">&quot;libXxf86vm-devel&quot;</span>, <span class="string">&quot;libXv-devel&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;xcb-util-devel&quot;</span>, <span class="string">&quot;libuuid-devel&quot;</span>, <span class="string">&quot;xcb-util-cursor-devel&quot;</span>], update=<span class="literal">True</span>, check=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    dnf = package_manager.Dnf(<span class="variable language_">self</span>)</span><br><span class="line">    dnf.install([<span class="string">&quot;libxcb-devel&quot;</span>, <span class="string">&quot;libfontenc-devel&quot;</span>, <span class="string">&quot;libXaw-devel&quot;</span>, <span class="string">&quot;libXcomposite-devel&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;libXcursor-devel&quot;</span>, <span class="string">&quot;libXdmcp-devel&quot;</span>, <span class="string">&quot;libXtst-devel&quot;</span>, <span class="string">&quot;libXinerama-devel&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;libxkbfile-devel&quot;</span>, <span class="string">&quot;libXrandr-devel&quot;</span>, <span class="string">&quot;libXres-devel&quot;</span>, <span class="string">&quot;libXScrnSaver-devel&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;xcb-util-wm-devel&quot;</span>, <span class="string">&quot;xcb-util-image-devel&quot;</span>, <span class="string">&quot;xcb-util-keysyms-devel&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;xcb-util-renderutil-devel&quot;</span>, <span class="string">&quot;libXdamage-devel&quot;</span>, <span class="string">&quot;libXxf86vm-devel&quot;</span>, <span class="string">&quot;libXv-devel&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;xcb-util-devel&quot;</span>, <span class="string">&quot;libuuid-devel&quot;</span>, <span class="string">&quot;xcb-util-cursor-devel&quot;</span>], update=<span class="literal">True</span>, check=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    zypper = package_manager.Zypper(<span class="variable language_">self</span>)</span><br><span class="line">    zypper.install([<span class="string">&quot;libxcb-devel&quot;</span>, <span class="string">&quot;libfontenc-devel&quot;</span>, <span class="string">&quot;libXaw-devel&quot;</span>, <span class="string">&quot;libXcomposite-devel&quot;</span>,</span><br><span class="line">                          <span class="string">&quot;libXcursor-devel&quot;</span>, <span class="string">&quot;libXdmcp-devel&quot;</span>, <span class="string">&quot;libXtst-devel&quot;</span>, <span class="string">&quot;libXinerama-devel&quot;</span>,</span><br><span class="line">                          <span class="string">&quot;libxkbfile-devel&quot;</span>, <span class="string">&quot;libXrandr-devel&quot;</span>, <span class="string">&quot;libXres-devel&quot;</span>, <span class="string">&quot;libXss-devel&quot;</span>,</span><br><span class="line">                          <span class="string">&quot;xcb-util-wm-devel&quot;</span>, <span class="string">&quot;xcb-util-image-devel&quot;</span>, <span class="string">&quot;xcb-util-keysyms-devel&quot;</span>,</span><br><span class="line">                          <span class="string">&quot;xcb-util-renderutil-devel&quot;</span>, <span class="string">&quot;libXdamage-devel&quot;</span>, <span class="string">&quot;libXxf86vm-devel&quot;</span>, <span class="string">&quot;libXv-devel&quot;</span>,</span><br><span class="line">                          <span class="string">&quot;xcb-util-devel&quot;</span>, <span class="string">&quot;libuuid-devel&quot;</span>, <span class="string">&quot;xcb-util-cursor-devel&quot;</span>], update=<span class="literal">True</span>, check=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    pacman = package_manager.PacMan(<span class="variable language_">self</span>)</span><br><span class="line">    pacman.install([<span class="string">&quot;libxcb&quot;</span>, <span class="string">&quot;libfontenc&quot;</span>, <span class="string">&quot;libice&quot;</span>, <span class="string">&quot;libsm&quot;</span>, <span class="string">&quot;libxaw&quot;</span>, <span class="string">&quot;libxcomposite&quot;</span>, <span class="string">&quot;libxcursor&quot;</span>,</span><br><span class="line">                          <span class="string">&quot;libxdamage&quot;</span>, <span class="string">&quot;libxdmcp&quot;</span>, <span class="string">&quot;libxtst&quot;</span>, <span class="string">&quot;libxinerama&quot;</span>, <span class="string">&quot;libxkbfile&quot;</span>, <span class="string">&quot;libxrandr&quot;</span>, <span class="string">&quot;libxres&quot;</span>,</span><br><span class="line">                          <span class="string">&quot;libxss&quot;</span>, <span class="string">&quot;xcb-util-wm&quot;</span>, <span class="string">&quot;xcb-util-image&quot;</span>, <span class="string">&quot;xcb-util-keysyms&quot;</span>, <span class="string">&quot;xcb-util-renderutil&quot;</span>,</span><br><span class="line">                          <span class="string">&quot;libxxf86vm&quot;</span>, <span class="string">&quot;libxv&quot;</span>, <span class="string">&quot;xcb-util&quot;</span>, <span class="string">&quot;util-linux-libs&quot;</span>, <span class="string">&quot;xcb-util-cursor&quot;</span>], update=<span class="literal">True</span>, check=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    package_manager.Pkg(<span class="variable language_">self</span>).install([<span class="string">&quot;libX11&quot;</span>, <span class="string">&quot;libfontenc&quot;</span>, <span class="string">&quot;libice&quot;</span>, <span class="string">&quot;libsm&quot;</span>, <span class="string">&quot;libxaw&quot;</span>, <span class="string">&quot;libxcomposite&quot;</span>, <span class="string">&quot;libxcursor&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;libxdamage&quot;</span>, <span class="string">&quot;libxdmcp&quot;</span>, <span class="string">&quot;libxtst&quot;</span>, <span class="string">&quot;libxinerama&quot;</span>, <span class="string">&quot;libxkbfile&quot;</span>, <span class="string">&quot;libxrandr&quot;</span>, <span class="string">&quot;libxres&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;libXScrnSaver&quot;</span>, <span class="string">&quot;xcb-util-wm&quot;</span>, <span class="string">&quot;xcb-util-image&quot;</span>, <span class="string">&quot;xcb-util-keysyms&quot;</span>, <span class="string">&quot;xcb-util-renderutil&quot;</span>,</span><br><span class="line">                       <span class="string">&quot;libxxf86vm&quot;</span>, <span class="string">&quot;libxv&quot;</span>, <span class="string">&quot;xkeyboard-config&quot;</span>, <span class="string">&quot;xcb-util&quot;</span>, <span class="string">&quot;xcb-util-cursor&quot;</span>], update=<span class="literal">True</span>, check=<span class="literal">True</span>)</span><br></pre></td></tr></table></div></figure><p>对于<code>Ubuntu</code>来讲，<code>conan</code>能手动帮我们调用<code>apt</code>安装所需要的系统依赖。需要注意一点，需要在配置文件中加上两句，来指明开启这个功能和使用<code>sudo</code>。所以最终的配置文件类似如下：</p><figure class="highlight ini"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[settings]</span></span><br><span class="line"><span class="attr">os</span>=Linux</span><br><span class="line"><span class="attr">os_build</span>=Linux</span><br><span class="line"><span class="attr">arch</span>=x<span class="number">86_64</span></span><br><span class="line"><span class="attr">arch_build</span>=x<span class="number">86_64</span></span><br><span class="line"><span class="attr">compiler</span>=gcc</span><br><span class="line"><span class="attr">compiler.version</span>=<span class="number">9</span></span><br><span class="line"><span class="attr">compiler.libcxx</span>=libstdc++<span class="number">11</span></span><br><span class="line"><span class="attr">build_type</span>=Release</span><br><span class="line"><span class="section">[options]</span></span><br><span class="line"><span class="section">[build_requires]</span></span><br><span class="line"><span class="section">[env]</span></span><br><span class="line"><span class="section">[conf]</span></span><br><span class="line">tools.system.package_manager:<span class="attr">mode</span>=install</span><br><span class="line">tools.system.package_manager:<span class="attr">sudo</span>=<span class="literal">True</span></span><br></pre></td></tr></table></div></figure><p>至此，我们成功通过<code>conan</code>安装下来了<code>cairo</code>，看到成功的结果，我的内心无比兴奋。</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20240715175839407.png" alt="image-20240715175839407" style="zoom:60%"><h1 id="使用Cairo库绘制图形"><a href="#使用Cairo库绘制图形" class="heading-link"><i class="fas fa-link"></i></a><a href="#使用Cairo库绘制图形" class="headerlink" title="使用Cairo库绘制图形"></a>使用Cairo库绘制图形</h1><p>安装完<code>cairo</code>库，是时候使用它绘制一些简单的图形了。</p><h2 id="Linux-GUI背景简述"><a href="#Linux-GUI背景简述" class="heading-link"><i class="fas fa-link"></i></a><a href="#Linux-GUI背景简述" class="headerlink" title="Linux GUI背景简述"></a>Linux GUI背景简述</h2><p><code>Linux</code>本身是不带有图形界面的，真正原生的<code>Linux</code>系统只是一个基于命令行的操作系统。但是我们目前所使用的<code>Linux</code>发行版，例如<code>Ubuntu</code>、<code>Centos</code>等，都是有图形界面的啊。这是因为这些图形界面是<code>Linux</code>下的一个应用程序而已，是通过程序和协议模拟和实现出来的，或者说图形界面并不属于<code>Linux</code>内核的一部分。这一点和<code>Windows</code>系统完全不一样，<code>Windows</code>的命令行在我看来完全不如<code>Linux</code>这么好用，甚至有时候我会爆粗口喷他，但是<code>Windows</code>的用户的依然最多。为什么呢？就是因为<code>GUI</code>好看。<code>Windows</code>的图形界面是操作系统的一部分，并且做的确实好看和丝滑。这样变相的降低了用户的学习和使用成本，对大多数的人而言是件好事。但是对于程序员特别是偏向底层的程序员来讲，却真不一定。</p><p>在<code>Linux</code>下，需要通过应用程序实现图形界面，那就需要设计一个合适的协议。目前市面上比较流行的有两种协议，<code>X</code>协议和<code>Wayland</code>协议。这两种协议都是基于网络通信的思想，将图形显示分为了客户端（即你的应用程序）和服务端通信的过程。输入设备和显示设备不是同一个设备，而且他们需要相互配合，进行画面显示，所以需要一个交互协议，建立他们直接的沟通桥梁。当然<code>X</code>协议和<code>Wayland</code>协议的细节有所区别，粗略的讲是<code>server</code>和<code>compositor</code>的设计不同，具体可见<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.secjuice.com/wayland-vs-xorg/">https://www.secjuice.com/wayland-vs-xorg/</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。</p><p>本文以及后续以<code>X</code>协议为例展开，并以<code>XClient</code>和<code>XServer</code>分别代指客户端和服务端。例如现在我需要画一个圆，<code>XClient</code>需要告诉<code>XServer</code>在屏幕的什么地方，使用什么颜色，画多大的一个圆。至于这个圆如何生成，如何使用硬件真正绘制图形等等这些操作，都是由<code>XServer</code>完成的。当然更进一步的，<code>XServer</code>还可以捕捉鼠标和键盘的动作，会触发相应的事件。<code>XClient</code>可以接受相应的事件并且完成相应的逻辑。这就是整个<code>X</code>协议以及绘制逻辑的简要概括。</p><p><code>X</code>协议有很多实现。目前用的最多的是<code>XOrg</code>，对应的<code>XClient</code>有<code>Xlib</code>和<code>XCB</code>的两种实现，提供了和<code>XServer</code>对接的<code>API</code>。（<code>At the bottom level of the X client library stack are Xlib and XCB, two helper libraries (really sets of libraries) that provide API for talking to the X server.</code>）本文的背景是<code>X11</code>，也是<code>Xlib</code>库的一个特殊版本。</p><p>上面只是非常粗略的说明了一下基本思路，更多文档请参考：</p><ol><li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.x.org/wiki/">X.Org</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li><li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://wayland.freedesktop.org/">Wayland</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li><li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.x.org/wiki/guide/xlib-and-xcb/">The X New Developer’s Guide: Xlib and XCB</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li></ol><h2 id="安装X11并编写GUI程序"><a href="#安装X11并编写GUI程序" class="heading-link"><i class="fas fa-link"></i></a><a href="#安装X11并编写GUI程序" class="headerlink" title="安装X11并编写GUI程序"></a>安装X11并编写GUI程序</h2><p>强烈建议在虚拟机下进行，因为<code>Wsl</code>需要内核更新到<code>2.2.4</code>以后才能使用最新功能的<code>GUI</code>，而且体验还不是很好。</p><p>以<code>Ubuntu</code>为例，系统默认是未安装<code>X11</code>库的（<code>XServer</code>肯定是有的，不然你怎么看得到图形界面呢？安装<code>X11</code>只是提供了窗口系统的开发支持）。因此我们使用如下命令手动安装。值得一提的是，由于<code>X11</code>是系统库，因此使用<code>apt</code>包安装即可。同理对于<code>Wayland</code>也是一样。</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install libx11-dev</span><br></pre></td></tr></table></div></figure><p>安装完成以后，使用<code>CMake</code>就能很方便的引入<code>X11</code>支持了。</p><figure class="highlight cmake"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_executable</span> (xxx</span><br><span class="line">    ...</span><br><span class="line">)</span><br><span class="line"><span class="keyword">target_link_libraries</span> (xxx X11)</span><br></pre></td></tr></table></div></figure><p>现在我们编写一个样例程序，用于在<code>X11</code>下绘制一个图形窗口。这里面涉及到很多的<code>X11</code>的<code>API</code>，本文只做简单介绍，具体请参考文档<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.x.org/releases/X11R7.7/doc/libX11/libX11/libX11.html">https://www.x.org/releases/X11R7.7/doc/libX11/libX11/libX11.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p><figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;X11/Xlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 用于和 XServer 建立连接，dpy 指针全局只有一份</span></span><br><span class="line">    Display *dpy = <span class="built_in">XOpenDisplay</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (!dpy)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Unable to open X display!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> screen = <span class="built_in">DefaultScreen</span>(dpy);</span><br><span class="line">    <span class="comment">// 创建一个顶层窗口</span></span><br><span class="line">    Window w = <span class="built_in">XCreateSimpleWindow</span>(</span><br><span class="line">        dpy,</span><br><span class="line">        <span class="built_in">RootWindow</span>(dpy, <span class="built_in">DefaultScreen</span>(dpy)),</span><br><span class="line">        <span class="number">100</span>, <span class="number">100</span>, <span class="number">400</span>, <span class="number">300</span>, <span class="number">0</span>,</span><br><span class="line">        <span class="built_in">BlackPixel</span>(dpy, screen),</span><br><span class="line">        <span class="built_in">BlackPixel</span>(dpy, screen)</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 将需要检测的事件绑定在窗口上</span></span><br><span class="line">    <span class="built_in">XSelectInput</span>(dpy, w, ExposureMask);</span><br><span class="line">    <span class="comment">// 展示这个窗口</span></span><br><span class="line">    <span class="built_in">XMapWindow</span>(dpy, w);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Entering loop ...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进入事件循环</span></span><br><span class="line">    XEvent e;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">XNextEvent</span>(dpy, &amp;e);</span><br><span class="line">        <span class="keyword">switch</span> (e.type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> Expose:</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;event: Expose&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;event: &quot;</span> &lt;&lt; e.type &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>接口的大致功能以在代码注释中体现。注意到整个程序最重要的架构是最后的这个事件循环，当<code>XClient</code>窗口成功创建出来以后，<code>XServer</code>需要不断监听<code>XClient</code>发送的事件并予以处理，这样才能实现<code>GUI</code>程序的功能。因此事件循环的存在就自然而然了。有点类似于<code>IO</code>多路复用中<code>epoll</code>技术的框架。在这里监听的是<code>Expose</code>事件，不用具体关心这个语义是什么意思，在窗口创建和窗口大小发生改变的时候会触发<code>Expose</code>事件，这里也是用作信息打印测试。</p><p>程序的运行结果如下，可以发现窗口创建和改变窗口大小的时候在不断打印<code>Expose</code>的信息。</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20240716111623175.png" alt="image-20240716111623175" style="zoom:67%"><p>对于事件循环这个概念，不管是<code>Qt</code>，还是<code>LarkSDK</code>，还是对于一个跨平台的<code>GUI</code>框架，事件循环显然是必不可少的。问题在于跨平台需要统一不同平台下的窗体系统和事件处理等逻辑，最终抽象出跨平台的接口，这就是这些框架正在做最重要的一件事情。以<code>LarkSDK</code>为例，虽然最简单的跨平台的程序是四行就能搞定，但是其中涉及到的知识和背景是非常庞大的。</p><figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;lwindowapplication.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;lwindow.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LWindowApplication app; <span class="comment">// 创建窗体程序主框架实例</span></span><br><span class="line">    LWindow w; <span class="comment">// 创建顶层窗体</span></span><br><span class="line">    w.<span class="built_in">show</span>(); <span class="comment">// 让窗体可见</span></span><br><span class="line">    <span class="keyword">return</span> app.<span class="built_in">exec</span>(); <span class="comment">// 进入主事件循环</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><h2 id="尝试引入Cairo"><a href="#尝试引入Cairo" class="heading-link"><i class="fas fa-link"></i></a><a href="#尝试引入Cairo" class="headerlink" title="尝试引入Cairo"></a>尝试引入Cairo</h2><p><code>cairo</code>将输出和绘制的概念做了严格区分。<code>cairo surface</code>是一个抽象出来的概念，与其对接的是多种输出方式，例如<code>PDF</code>、<code>PNG</code>、<code>SVG</code>、<code>Win32</code>、<code>XLib</code>、<code>XCB</code>等，如图所示。</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20240716141915019.png" alt="image-20240716141915019" style="zoom:75%"><p>接着我们查看<code>cairo</code>官方提供的<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://cairographics.org/samples/">samples</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>，可以发现，官方提供的样例好像完全和<code>surface</code>没有关系，换句话说没有反映输出的方式。例如这段代码：</p><figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> xc = <span class="number">128.0</span>;</span><br><span class="line"><span class="type">double</span> yc = <span class="number">128.0</span>;</span><br><span class="line"><span class="type">double</span> radius = <span class="number">100.0</span>;</span><br><span class="line"><span class="type">double</span> angle1 = <span class="number">45.0</span>  * (M_PI/<span class="number">180.0</span>);  <span class="comment">/* angles are specified */</span></span><br><span class="line"><span class="type">double</span> angle2 = <span class="number">180.0</span> * (M_PI/<span class="number">180.0</span>);  <span class="comment">/* in radians           */</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cairo_set_line_width</span> (cr, <span class="number">10.0</span>);</span><br><span class="line"><span class="built_in">cairo_arc</span> (cr, xc, yc, radius, angle1, angle2);</span><br><span class="line"><span class="built_in">cairo_stroke</span> (cr);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* draw helping lines */</span></span><br><span class="line"><span class="built_in">cairo_set_source_rgba</span> (cr, <span class="number">1</span>, <span class="number">0.2</span>, <span class="number">0.2</span>, <span class="number">0.6</span>);</span><br><span class="line"><span class="built_in">cairo_set_line_width</span> (cr, <span class="number">6.0</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">cairo_arc</span> (cr, xc, yc, <span class="number">10.0</span>, <span class="number">0</span>, <span class="number">2</span>*M_PI);</span><br><span class="line"><span class="built_in">cairo_fill</span> (cr);</span><br><span class="line"></span><br><span class="line"><span class="built_in">cairo_arc</span> (cr, xc, yc, radius, angle1, angle1);</span><br><span class="line"><span class="built_in">cairo_line_to</span> (cr, xc, yc);</span><br><span class="line"><span class="built_in">cairo_arc</span> (cr, xc, yc, radius, angle2, angle2);</span><br><span class="line"><span class="built_in">cairo_line_to</span> (cr, xc, yc);</span><br><span class="line"><span class="built_in">cairo_stroke</span> (cr);</span><br></pre></td></tr></table></div></figure><p>它的绘制结果是这样的：</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20240716142350311.png" alt="image-20240716142350311" style="zoom:85%"><p>这个图样可以被输出到前面提到的任意一种<code>surface</code>中。同时这也是我想说的，<code>cairo</code>将输出和绘制的概念做了完整区分，同样这也是我们容易想到和愿意看到的。所以，如果想要创建一个输出到<code>PNG</code>中的实例，代码应该类似如下：</p><figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建 surface</span></span><br><span class="line"><span class="type">cairo_surface_t</span> *surface = <span class="built_in">cairo_image_surface_create</span>(CAIRO_FORMAT_ARGB32, <span class="number">640</span>, <span class="number">480</span>);</span><br><span class="line"><span class="comment">// 创建绘图上下文 context</span></span><br><span class="line"><span class="type">cairo_t</span> *cr = <span class="built_in">cairo_create</span>(surface);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绘制逻辑，只和 context 相关，与 surface 无关</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出到 png 格式中</span></span><br><span class="line"><span class="built_in">cairo_surface_write_to_png</span>(surface, <span class="string">&quot;xxx.png&quot;</span>);</span><br></pre></td></tr></table></div></figure><p>至此，我们用<code>surface</code>和<code>context</code>来代指输出和绘制的概念，也明白了<code>cario</code>是如何区分这两个概念的了。<code>surface</code>用作指明绘制的图形输出到哪里，<code>context</code>则用于进行绘制。读者可以尝试编写一个完整的程序输出上面的图案到一张图片文件中。</p><h2 id="Cairo和X11相结合"><a href="#Cairo和X11相结合" class="heading-link"><i class="fas fa-link"></i></a><a href="#Cairo和X11相结合" class="headerlink" title="Cairo和X11相结合"></a>Cairo和X11相结合</h2><p>使用<code>cairo</code>成功输出到图片文件中以后，试着想想如何与<code>X11</code>窗口系统结合了。提前声明，用到的<code>surface</code>只有<code>XLib Surface</code>和<code>Image Surface</code>，其他的<code>API</code>请自行查询<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://cairographics.org/manual/">文档</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。</p><h3 id="XLib-Surface"><a href="#XLib-Surface" class="heading-link"><i class="fas fa-link"></i></a><a href="#XLib-Surface" class="headerlink" title="XLib Surface"></a>XLib Surface</h3><p>首先想到的肯定是<code>XLib Surface</code>。这代表<code>cairo</code>帮我做好了与<code>X11</code>平台的对接工作，我只需要按部就班地使用<code>cairo</code>的<code>API</code>即可。所有的<code>surface</code>基本上只有在创建的时候会有区别，在<code>context</code>那一层的绘制几乎没有区别。例如下面就是<code>XLib Surface</code>的创建<code>API</code>，参数具体含义请参考<span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://cairographics.org/manual/cairo-XLib-Surfaces.html">官方文档</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>。</p><figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">cairo_surface_t</span> *</span></span><br><span class="line"><span class="function"><span class="title">cairo_xlib_surface_create</span> <span class="params">(Display *dpy,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Drawable drawable,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Visual *visual,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">int</span> width,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">int</span> height)</span></span>;</span><br></pre></td></tr></table></div></figure><p>查询该方法需要的接口如何获取以后，编写出如下的代码：</p><figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;exception&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;X11/Xlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cairo.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cairo/cairo-xlib.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Display *dpy = <span class="built_in">XOpenDisplay</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (!dpy)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Failed to open X display&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> screen = <span class="built_in">DefaultScreen</span>(dpy);</span><br><span class="line">    Window w = <span class="built_in">XCreateSimpleWindow</span>(</span><br><span class="line">        dpy,</span><br><span class="line">        <span class="built_in">RootWindow</span>(dpy, <span class="built_in">DefaultScreen</span>(dpy)),</span><br><span class="line">        <span class="number">100</span>, <span class="number">100</span>, <span class="number">640</span>, <span class="number">480</span>, <span class="number">0</span>,</span><br><span class="line">        <span class="built_in">BlackPixel</span>(dpy, screen),</span><br><span class="line">        <span class="built_in">BlackPixel</span>(dpy, screen));</span><br><span class="line">    <span class="built_in">XSelectInput</span>(dpy, w, ExposureMask);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">XMapWindow</span>(dpy, w);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Entering loop ...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 window id 获取该窗口的信息</span></span><br><span class="line">    XWindowAttributes attr;</span><br><span class="line">    <span class="built_in">XGetWindowAttributes</span>(dpy, w, &amp;attr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 XLib Surface</span></span><br><span class="line">    <span class="type">cairo_surface_t</span> *surface = <span class="built_in">cairo_xlib_surface_create</span>(dpy, w, attr.visual, attr.width, attr.height);</span><br><span class="line">    <span class="type">cairo_t</span> *cr = <span class="built_in">cairo_create</span>(surface);</span><br><span class="line"></span><br><span class="line">    XEvent e;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">XNextEvent</span>(dpy, &amp;e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (e.type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> Expose:</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;event: Expose&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 绘制操作</span></span><br><span class="line">                <span class="built_in">cairo_set_source_rgb</span>(cr, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">0.5</span>);</span><br><span class="line">                <span class="built_in">cairo_paint</span>(cr);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">cairo_set_source_rgb</span>(cr, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">                <span class="built_in">cairo_move_to</span>(cr, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">                <span class="built_in">cairo_line_to</span>(cr, <span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">                <span class="built_in">cairo_stroke</span>(cr);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;event: &quot;</span> &lt;&lt; e.type &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cairo_destroy</span>(cr);</span><br><span class="line">    <span class="built_in">cairo_surface_destroy</span>(surface);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">XDestroyWindow</span>(dpy, w);</span><br><span class="line">    <span class="built_in">XCloseDisplay</span>(dpy);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>这样能在<code>Expose</code>事件触发的时候成功绘制出文章开始时候展示的图样。</p><h3 id="Image-Surface"><a href="#Image-Surface" class="heading-link"><i class="fas fa-link"></i></a><a href="#Image-Surface" class="headerlink" title="Image Surface"></a>Image Surface</h3><p><code>XLib Surface</code>的代码结构看着很像自动挡的感觉，创建<code>surface</code>，在事件循环中用<code>context</code>进行绘制，最终得到想要的图案。</p><p>我们深入思考一下，图形是如何被绘制到屏幕上的呢？前面举了个例子，画一个圆，告诉<code>XServer</code>在哪里，用什么颜色，画多大、多宽的圆。至于如何用硬件画不是<code>XClient</code>关心的事情，但是如何表示这些信息呢？显然需要用合适的<code>data</code>进行存储。进一步讲，<code>context</code>调用各种方法的实际过程，其实就是往数据缓冲区<code>data</code>中写数据的过程。当类似<code>flush</code>操作的被调用以后，这些数据才会真正反映在屏幕上，形成我们观看的效果。</p><p>在这样的语义下，我们进一步思考<code>surface</code>的概念，其实用<strong>可绘制表面</strong>的概念好像更加贴切（本概念借鉴于<code>LarkSDK</code>的<code>LSurface</code>）。绘图的数据缓冲区记录了图形的数据，类型是<code>unsigned char *</code>，这些数据和不同的输出方式对接就能达到不同的输出效果。至于为什么是<code>unsigned char *</code>（我猜测大概是字节流）以及如何对接，这不是本文的重点，有兴趣请自己查询资料。</p><p>知道这个过程以后，回到<code>Image Surface</code>本身，为什么要使用这个东西，是因为它为我们提供了获取数据的接口。也就是当我用<code>context</code>绘制以后，调用这个方法就能立刻拿到缓冲区的数据。</p><figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">char</span> *</span></span><br><span class="line"><span class="function"><span class="title">cairo_image_surface_get_data</span> <span class="params">(<span class="type">cairo_surface_t</span> *surface)</span></span>;</span><br></pre></td></tr></table></div></figure><p>然后让我们思考一下绘制效率。不同引擎的效率的区别根本上就是在于如何快速的把这些数据计算出来，或者换句话讲，如何快速地让缓冲区的内存填充为指定的数据。比如对于最基本的暴力软渲染和<code>cairo</code>引擎，他们的效率差距显然是非常大的。这里有一个例子可以参考，是<code>LarkSDK</code>原生软渲染和<code>cairo</code>引擎同样绘制<code>10000</code>条斜线的效率差距，以下是结果，保守估计至少差了几百到一千倍。</p><img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="https://cdn.davidingplus.cn/images/2025/02/01/image-20240716155335456.png" alt="image-20240716155335456" style="zoom:80%"><p>回到正题，再结合<code>X11</code>的<code>API</code>，我们可以给出使用<code>Image Surface</code>的代码：</p><figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;exception&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;X11/Xlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cairo.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Display *dpy = <span class="built_in">XOpenDisplay</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (!dpy)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Failed to open X display&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> screen = <span class="built_in">DefaultScreen</span>(dpy);</span><br><span class="line">    Window w = <span class="built_in">XCreateSimpleWindow</span>(</span><br><span class="line">        dpy,</span><br><span class="line">        <span class="built_in">RootWindow</span>(dpy, <span class="built_in">DefaultScreen</span>(dpy)),</span><br><span class="line">        <span class="number">100</span>, <span class="number">100</span>, <span class="number">640</span>, <span class="number">480</span>, <span class="number">0</span>,</span><br><span class="line">        <span class="built_in">BlackPixel</span>(dpy, screen),</span><br><span class="line">        <span class="built_in">BlackPixel</span>(dpy, screen));</span><br><span class="line">    <span class="built_in">XSelectInput</span>(dpy, w, ExposureMask);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> mask = <span class="number">0</span>;</span><br><span class="line">    XGCValues values;</span><br><span class="line">    GC gc = <span class="built_in">XCreateGC</span>(dpy, w, mask, &amp;values);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">XMapWindow</span>(dpy, w);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 Image Surface</span></span><br><span class="line">    <span class="type">cairo_surface_t</span> *surface = <span class="built_in">cairo_image_surface_create</span>(CAIRO_FORMAT_ARGB32, <span class="number">640</span>, <span class="number">480</span>);</span><br><span class="line">    <span class="type">cairo_t</span> *cr = <span class="built_in">cairo_create</span>(surface);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得 Cairo 管理的绘图数据的指针</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *pData = <span class="built_in">cairo_image_surface_get_data</span>(surface);</span><br><span class="line">    <span class="comment">// 创建 X11 下的 Image Buffer ，将其中的数据替换为 Cairo 的数据指针</span></span><br><span class="line">    XImage *pBackBuffer = <span class="built_in">XCreateImage</span>(</span><br><span class="line">        dpy,</span><br><span class="line">        <span class="built_in">DefaultVisual</span>(dpy, screen),</span><br><span class="line">        <span class="built_in">DefaultDepth</span>(dpy, screen),</span><br><span class="line">        ZPixmap,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        (<span class="type">char</span> *)pData,</span><br><span class="line">        <span class="number">640</span>, <span class="number">480</span>,</span><br><span class="line">        <span class="number">8</span>,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Entering loop ...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    XEvent e;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">XNextEvent</span>(dpy, &amp;e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (e.type)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> Expose:</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;event: Expose&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">cairo_set_source_rgb</span>(cr, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">0.5</span>);</span><br><span class="line">                <span class="built_in">cairo_paint</span>(cr);</span><br><span class="line"></span><br><span class="line">                <span class="built_in">cairo_set_source_rgb</span>(cr, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">                <span class="built_in">cairo_move_to</span>(cr, <span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">                <span class="built_in">cairo_line_to</span>(cr, <span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line">                <span class="built_in">cairo_stroke</span>(cr);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// flush 操作，刷新缓冲区，更新数据</span></span><br><span class="line">                <span class="built_in">cairo_surface_flush</span>(surface);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// X11 下真正绘制图形的方法，用到了外面定义的 X11 Image Buffer，而其内部的数据就是 Cairo 管理的缓冲区数据</span></span><br><span class="line">                <span class="built_in">XPutImage</span>(</span><br><span class="line">                    dpy,</span><br><span class="line">                    w,</span><br><span class="line">                    gc,</span><br><span class="line">                    pBackBuffer,</span><br><span class="line">                    <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                    <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">                    <span class="number">640</span>, <span class="number">480</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;event: &quot;</span> &lt;&lt; e.type &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">cairo_destroy</span>(cr);</span><br><span class="line">    <span class="built_in">cairo_surface_destroy</span>(surface);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">XDestroyWindow</span>(dpy, w);</span><br><span class="line">    <span class="built_in">XCloseDisplay</span>(dpy);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>至此，我们完成了在<code>X11</code>下使用<code>Cairo</code>引擎绘制图形的全部过程。<code>Windows</code>的程序架构和事件循环有所区别，但思路是相同的。当然，这仅仅是阐述了基本过程，还有更多的细节值得研究和探讨。</p></div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://blog.davidingplus.cn">DavidingPlus</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://blog.davidingplus.cn/posts/70513923.html">https://blog.davidingplus.cn/posts/70513923.html</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-reward reward"><div class="reward-button">大爷，赏个铜板呗~~~</div><div class="reward-qrcode"><span class="reward-qrcode-alipay"><img class="reward-qrcode-alipay__img" src="/images/reward/alipay.webp"><div class="reward-qrcode-alipay__text">支付宝</div></span><span class="reward-qrcode-wechat"><img class="reward-qrcode-wechat__img" src="/images/reward/wechat-pay.webp"><div class="reward-qrcode-wechat__text">微信</div></span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/posts/a98e1d5b.html"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">使用 Woboq CodeBrowser 搭建源代码网站</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/posts/642c4108.html"><span class="paginator-prev__text">tips</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="utterances-container"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Cairo%E5%BA%93"><span class="toc-number">1.</span> <span class="toc-text">安装Cairo库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">通过包管理器安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87Conan%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text">通过Conan安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E5%AE%89%E8%A3%85Cairo"><span class="toc-number">1.2.1.</span> <span class="toc-text">尝试安装Cairo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8EConan%E5%8C%85"><span class="toc-number">1.2.2.</span> <span class="toc-text">关于Conan包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E9%94%99%E8%AF%AF%EF%BC%88%E5%B9%B6%E5%90%90%E6%A7%BD%EF%BC%89"><span class="toc-number">1.2.3.</span> <span class="toc-text">解决错误（并吐槽）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-number">1.2.4.</span> <span class="toc-text">补充</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Cairo%E5%BA%93%E7%BB%98%E5%88%B6%E5%9B%BE%E5%BD%A2"><span class="toc-number">2.</span> <span class="toc-text">使用Cairo库绘制图形</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-GUI%E8%83%8C%E6%99%AF%E7%AE%80%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">Linux GUI背景简述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85X11%E5%B9%B6%E7%BC%96%E5%86%99GUI%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.2.</span> <span class="toc-text">安装X11并编写GUI程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E5%BC%95%E5%85%A5Cairo"><span class="toc-number">2.3.</span> <span class="toc-text">尝试引入Cairo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cairo%E5%92%8CX11%E7%9B%B8%E7%BB%93%E5%90%88"><span class="toc-number">2.4.</span> <span class="toc-text">Cairo和X11相结合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#XLib-Surface"><span class="toc-number">2.4.1.</span> <span class="toc-text">XLib Surface</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Image-Surface"><span class="toc-number">2.4.2.</span> <span class="toc-text">Image Surface</span></a></li></ol></li></ol></li></ol></section><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/assets/android-chrome-512x512.webp" alt="avatar"></div><p class="sidebar-ov-author__text">Self-discipline is key in life.</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/DavidingPlus" target="_blank" rel="noopener" data-popover="GitHub" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="/qq/" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="/wechat/" target="_blank" rel="noopener" data-popover="微信" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weixin"></i></span></a><a class="sidebar-ov-social-item" href="mailto:davidingplus@qq.com" target="_blank" rel="noopener" data-popover="davidingplus@qq.com" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fas fa-envelope"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">36</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">20</div><div class="sidebar-ov-state-item__name">分类</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">您已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2023~2025</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>DavidingPlus</span><span class="footer__devider">|</span><span>蜀 ICP 备 2024088070 号</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v7.2.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.8.6</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div><div><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>var now=new Date;function createtime(){var n=new Date("09/18/2023 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="小破站已经安全运行 "+dnum+" 天 ",document.getElementById("times").innerHTML=hnum+" 小时 "+mnum+" 分 "+snum+" 秒啦！"}setInterval("createtime()",250)</script></div><script type="text/javascript" id="maid-script" mermaidoptioins="{&quot;theme&quot;:&quot;default&quot;}" src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/mermaid.min.js"></script><script>if(window.mermaid){var options=JSON.parse(document.getElementById("maid-script").getAttribute("mermaidoptioins"));mermaid.initialize(options)}</script></div></footer><div class="loading-animation" id="loading-animation"><div class="loading-animation__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-thumbs-up"></i></span></div><div class="back2bottom" id="back2bottom"><span class="back2bottom__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"><div class="search-btns">使用搜索：<span class="search-btns-item search-btns-item--bing"><i></i>必应</span><span class="search-btns-item search-btns-item--baidu"><i></i>百度</span></div></div><div class="search-results"></div></div><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/jquery.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/velocity.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/velocity-ui.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/canvas-nest.js" color="255,255,255" opacity="1" count="99" zindex="-1"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/fancybox.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/masonry.js"></script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/lazyload.js"></script><script>function initSearch(){var e=!0,t="search.json";t?/json$/i.test(t)&&(e=!1):t="search.xml";var n="/"+t;$.ajax({url:n,dataType:e?"xml":"json",async:!0,success:function(t){var n=e?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,o=$(".search-input input"),i=$(".search-results"),c=100,r=1,a=function(){var e=o.val().toLowerCase().trim(),t=e.split(/[\s]+/),a=[];t.length>1&&t.push(e),e.length>0&&n.forEach(function(e){var n=!1,o=e.title&&e.title.trim()||"[ 文章无标题 ]",i=o&&o.toLowerCase(),s=e.content&&e.content.replace(/<[^>]+>/g,""),l=s&&s.toLowerCase(),u=e.url&&decodeURI(e.url).replace(/\/{2,}/g,"/"),h=[],d=[];t.forEach(function(e){function t(e,t,n,o){if(!e||!t)return[];var i=0,c=-1,r=[];for(n||(e=e.toLowerCase(),t=t.toLowerCase());-1!==(c=t.indexOf(e,i));){var a=!1;h.forEach(function(t){t.index===c&&t.word.length<e.length&&(t.word=e,a=!0)}),i=c+e.length,!a&&r.push({index:c,word:e,weight:o})}return r}h=h.concat(t(e,i,!1,c)),d=d.concat(t(e,l,!1,r))});var f=h.length,p=d.length;if((f>0||p>0)&&(n=!0),n){function w(e,t,n,o){if(e&&t&&t.length){var i="",c=n,r=o;return t.forEach(function(t){if(!(t.index<c)){var n=t.index+t.word.length;i+=e.slice(c,t.index),i+="<b>"+e.slice(t.index,n)+"</b>",c=n}}),i+=e.slice(c,r)}}[h,d].forEach(function(e){e.sort(function(e,t){return e.index-t.index})});var v,g={},x=h.length*c+d.length*r,y=w(o,h,0,o.length)||o;if(d.length>0){var S=d[0].index;v=w(s,d,S>20?S-20:0,S+180)}else v=s.slice(0,200);g.title=y,g.content=v,g.url=u,g.weight=x,a.push(g)}});var s="";a.length?(a.sort(function(e,t){return t.weight-e.weight}),s+="<ul>",a.forEach(function(e){s+='<li><a class="search-results-title" href="'+e.url+'">',s+=e.title,s+='</a><div class="search-results-content">',s+=e.content,s+="</div></li>"}),s+="</ul>"):s+='<div class="search-results-none"><i class="far fa-meh"></i></div>',i.html(s)};o.on("input",a),o.on("keyup",function(e){e.keyCode===Stun.utils.codeToKeyCode("Enter")&&a()})}})}function closeSearch(){$("body").css({overflow:"auto"}),$(".search-popup").css({display:"none"}),$(".search-mask").css({display:"none"})}function safeOpenUrl(e){var t=window.open();t.opener=null,t.location=e}function extSearch(e){var t=window.location.host,n=$(".search-input input").val().toLowerCase().trim();n?safeOpenUrl({google:"https://www.google.com/search?q=",bing:"https://cn.bing.com/search?q=",baidu:"https://www.baidu.com/s?ie=UTF-8&wd="}[e]+n+" site:"+t):Stun.utils.popAlert("warning","请输入字符")}window.addEventListener("DOMContentLoaded",function(){Stun.utils.pjaxReloadLocalSearch=function(){$(".header-nav-search").on("click",function(e){e.stopPropagation(),$("body").css("overflow","hidden"),$(".search-popup").velocity("stop").velocity("transition.expandIn",{duration:300,complete:function(){$(".search-popup input").focus()}}),$(".search-mask").velocity("stop").velocity("transition.fadeIn",{duration:300}),initSearch()}),$(".search-mask, .search-close").on("click",function(){closeSearch()}),$(document).on("keydown",function(e){e.keyCode===Stun.utils.codeToKeyCode("Escape")&&closeSearch()})},Stun.utils.pjaxReloadLocalSearch()},!1);var assistSearchList=window.CONFIG.assistSearch;Array.isArray(assistSearchList)&&assistSearchList.forEach(function(e){document.querySelector(".search-btns-item--"+e).addEventListener("click",function(){extSearch(e)},!1)})</script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/pjax.js"></script><script>window.addEventListener("DOMContentLoaded",function(){new Pjax({selectors:["head title","#main",".pjax-reload",".header-banner"],history:!0,scrollTo:!1,scrollRestoration:!1,cacheBust:!1,debug:!1,currentUrlFullReload:!1,timeout:0});document.addEventListener("pjax:send",function(){$(".header-nav-menu").removeClass("show"),CONFIG.pjax&&CONFIG.pjax.avoidBanner&&$("html").velocity("scroll",{duration:500,offset:$("#header").height(),easing:"easeInOutCubic"}),$(".loading-animation").addClass("loading")},!1),window.addEventListener("pjax:complete",function(){if($(".loading-animation").removeClass("loading"),$("link[rel=prefetch], script[data-pjax-rm]").each(function(){$(this).remove()}),$("script[data-pjax], #pjax-reload script").each(function(){$(this).parent().append($(this).remove())}),Stun.utils.pjaxReloadBoot&&Stun.utils.pjaxReloadBoot(),Stun.utils.pjaxReloadScroll&&Stun.utils.pjaxReloadScroll(),Stun.utils.pjaxReloadSidebar&&Stun.utils.pjaxReloadSidebar(),"undefined"!=typeof mermaid){const e=Array.from(document.querySelectorAll(".mermaid")).filter(e=>!e.dataset.processed);mermaid.init(void 0,e)}},!1)},!1)</script><div id="pjax-reload"><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/quicklink.js"></script><script>function initQuicklink(){quicklink({timeout:"10000",priority:!0,ignores:[i=>i.includes("#"),i=>"https://blog.davidingplus.cn/posts/70513923.html"===i,/\/api\/?/,i=>i.includes(".xml"),i=>i.includes(".zip"),(i,t)=>t.hasAttribute("nofollow"),(i,t)=>t.hasAttribute("noprefetch")]})}initQuicklink()</script><script src="//cdn.davidingplus.cn/files/hexo-theme-stun-third-party/js/busuanzi.js" async></script></div><script src="/js/utils.js?v=2.8.6"></script><script src="/js/stun-boot.js?v=2.8.6"></script><script src="/js/scroll.js?v=2.8.6"></script><script src="/js/header.js?v=2.8.6"></script><script src="/js/sidebar.js?v=2.8.6"></script><script type="application/json" src="/search.json"></script><script data-pjax="">function loadUtterances(){var t=document,e=t.createElement("script"),s=t.getElementById("utterances-container"),r=Stun.utils.getNightMode()?"photon-dark":"github-light";s&&(e.src="https://utteranc.es/client.js",e.setAttribute("repo","DavidingPlus/blog-comments"),e.setAttribute("issue-term","title"),e.setAttribute("label","utterances"),e.setAttribute("theme",r),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),e.setAttribute("data-pjax-rm",""),s.append(e))}loadUtterances()</script><script async src="/js/cursor/text.js"></script><script src="/js/activate-power-mode.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,document.body.addEventListener("input",POWERMODE)</script><script>var titleTime,OriginTitile=document.title;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="🤡快回来,粗大事了~~"+OriginTitile,clearTimeout(titleTime)):(document.title="😚欢迎回来!~"+OriginTitile,titleTime=setTimeout(function(){document.title=OriginTitile},2e3))})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/wanko.model.json"},display:{position:"left",width:160,height:290},mobile:{show:!0},log:!1})</script></body></html>